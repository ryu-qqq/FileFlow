# ========================================
# Upload Scheduler Application Configuration
# ========================================
# Purpose: Upload Session 만료 처리 전용 Scheduler
# Components:
#   - CleanupExpiredSessionsJob (Batch)
#   - UploadSessionExpirationListener (Redis TTL)
# ========================================

spring:
  application:
    name: fileflow-scheduler-upload

  # ========================================
  # Profile Configuration
  # ========================================
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:local}

  # ========================================
  # JPA Configuration
  # ========================================
  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        format_sql: true
        use_sql_comments: true
        jdbc:
          batch_size: 100
        order_inserts: true
        order_updates: true

  # ========================================
  # DataSource Configuration
  # ========================================
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 10  # Scheduler는 작은 Pool로 충분
      minimum-idle: 2
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  # ========================================
  # Redis Configuration
  # ========================================
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 2

# ========================================
# Batch Job Configuration
# ========================================
batch:
  cleanup:
    # Cron Expression: 매일 새벽 2시
    cron: "0 0 2 * * *"

    # PENDING 세션 만료 시간 (분)
    pending-expiration-minutes: 30

    # IN_PROGRESS 세션 만료 시간 (시간)
    in-progress-expiration-hours: 24

    # Pessimistic Lock 대상 세션 개수 (FOR UPDATE SKIP LOCKED)
    # - 동시 실행되는 스케줄러 인스턴스 간 경합 방지
    # - 권장값: 100~1000 (메모리 사용량 고려)
    batch-size: 1000

# ========================================
# Logging Configuration
# ========================================
logging:
  level:
    root: INFO
    com.ryuqq.fileflow: DEBUG
    org.springframework.scheduling: DEBUG
    org.springframework.data.redis: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# ========================================
# Actuator Configuration
# ========================================
management:
  server:
    port: 9093  # Upload Scheduler 전용 Actuator Port (ECS Health Check)
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true

# ========================================
# Application Custom Properties
# ========================================
app:
  scheduler:
    upload:
      enabled: true
      description: "Upload Session Expiration Scheduler"
      components:
        - CleanupExpiredSessionsJob
        - UploadSessionExpirationListener
