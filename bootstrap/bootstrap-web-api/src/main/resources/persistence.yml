# ===============================================
# Persistence MySQL Adapter Configuration
# ===============================================

# Common JPA Settings
spring:
  jpa:
    open-in-view: false
    show-sql: false
    properties:
      hibernate:
        default_batch_fetch_size: 100

# Flyway Configuration
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true

---
# ===============================================
# Production Profile
# ===============================================
spring:
  config:
    activate:
      on-profile: prod

  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:fileflow}?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
    username: ${DB_USER:root}
    password: ${DB_PASSWORD:root}
    hikari:
      # Pool Size
      maximum-pool-size: 20
      minimum-idle: 10

      # Timeout
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

      # Leak Detection
      leak-detection-threshold: 60000

      # Pool Name
      pool-name: FileFlowHikariPool

      # Connection Init SQL
      connection-init-sql: SELECT 1

      # MySQL Optimization
      data-source-properties:
        cachePrepStmts: true
        prepStmtCacheSize: 250
        prepStmtCacheSqlLimit: 2048
        useServerPrepStmts: true
        rewriteBatchedStatements: true
        cacheResultSetMetadata: true
        cacheServerConfiguration: true
        elideSetAutoCommits: true
        maintainTimeStats: false

  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        format_sql: false
        use_sql_comments: false
        jdbc:
          batch_size: 50
          fetch_size: 50
        order_inserts: true
        order_updates: true
        batch_versioned_data: true
        query:
          plan_cache_max_size: 2048
          in_clause_parameter_padding: true

logging:
  level:
    com.ryuqq.fileflow: INFO
    org.hibernate.SQL: WARN
    org.hibernate.orm.jdbc.bind: WARN

---
# ===============================================
# Test Profile
# ===============================================
spring:
  config:
    activate:
      on-profile: test

  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:testdb;MODE=MySQL;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    username: sa
    password:

  jpa:
    hibernate:
      ddl-auto: create-drop
    properties:
      hibernate:
        dialect: org.hibernate.dialect.H2Dialect
        format_sql: false

  flyway:
    enabled: false
