# yaml-language-server: $schema=https://coderabbit.ai/integrations/schema.v2.json

# CodeRabbit Configuration for Spring Standards Project
# This configuration enforces our Zero-Tolerance rules and project conventions

language: ko-KR
tone_instructions: "Java/Spring Boot hexagonal expert. CRITICAL: 1) No Lombok (@Data/@Builder) 2) No getter chaining 3) Long FK only (no @ManyToOne) 4) No external API in @Transactional 5) No @Transactional on private/final. ASSERTIVE on rules."

early_access: true
enable_free_tier: false

reviews:
  profile: assertive
  high_level_summary: true
  high_level_summary_placeholder: |
    ## ğŸ“Š Summary

    This PR implements...

    ### âœ… Compliance Status
    - Zero-Tolerance Rules: [Pass/Fail]
    - Architecture: [Pass/Fail]
    - Testing: [Pass/Fail]

  poem: false
  collapse_walkthrough: false

  auto_review:
    enabled: true
    auto_incremental_review: true
    ignore_title_keywords:
      - "WIP"
      - "Draft"
      - "DO NOT MERGE"
    drafts: false
    base_branches:
      - "main"
      - "develop"
    ignore_usernames:
      - "dependabot"
      - "renovate"

  # íŒŒì¼ í•„í„°ë§ (ë¹Œë“œ ì‚°ì¶œë¬¼ ì œì™¸)
  path_filters:
    - "!**/build/**"
    - "!**/target/**"
    - "!**/.gradle/**"
    - "!**/node_modules/**"
    - "!**/*.class"
    - "!**/*.jar"
    - "!**/*.war"

  # Layerë³„ ì»¤ìŠ¤í…€ ë¦¬ë·° ê·œì¹™
  path_instructions:
    # Domain Layer (ê°€ì¥ ì—„ê²©)
    - path: "domain/src/main/java/**/*.java"
      instructions: |
        CRITICAL ZERO-TOLERANCE RULES (Must enforce):

        1. **Lombok ì ˆëŒ€ ê¸ˆì§€**
           - âŒ @Data, @Builder, @Getter, @Setter, @Value, @With
           - âœ… Plain Java getters/setters only
           - Reason: Domainì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ í•µì‹¬, ëª…ì‹œì  ì½”ë“œ í•„ìˆ˜

        2. **Law of Demeter (Getter ì²´ì´ë‹ ê¸ˆì§€)**
           - âŒ order.getCustomer().getAddress().getZipCode()
           - âœ… order.getCustomerZipCode()
           - Reason: Tell, Don't Ask ì›ì¹™ ì¤€ìˆ˜

        3. **No Setters on Aggregate Root**
           - âŒ public void setStatus(OrderStatus status)
           - âœ… public void cancel(CancelReason reason)
           - Reason: ìƒíƒœ ë³€ê²½ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œë¡œë§Œ

        4. **Long FK Strategy**
           - âŒ @ManyToOne, @OneToMany (JPA ê´€ê³„ ì–´ë…¸í…Œì´ì…˜)
           - âœ… private Long customerId;
           - Reason: Domainì€ JPAì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ

        5. **Immutability**
           - âœ… final fields where possible
           - âœ… Collections should be unmodifiable

        Architecture:
        - Aggregate Root pattern ì¤€ìˆ˜
        - Value Objects are immutable
        - Domain Events for side effects

    # Application Layer
    - path: "application/src/main/java/**/*UseCase.java"
      instructions: |
        CRITICAL ZERO-TOLERANCE RULES:

        1. **Transaction Boundary Violation**
           - âŒ External API calls (RestTemplate, WebClient, Feign) inside @Transactional
           - âœ… Keep transactions SHORT and ISOLATED
           - Reason: ì™¸ë¶€ APIëŠ” ë¶ˆì•ˆì •, íŠ¸ëœì­ì…˜ì€ DB ì‘ì—…ë§Œ

        2. **Spring Proxy Constraints**
           - âŒ @Transactional on private methods
           - âŒ @Transactional on final methods
           - âŒ this.methodWithTransactional() (same-class call)
           - âœ… public methods only, called from other beans

        3. **Single Responsibility**
           - Each UseCase handles ONE business operation
           - Compose multiple UseCases via orchestration

        4. **Command/Query Separation**
           - Commands return void or simple status
           - Queries return DTOs via Assembler

    # Persistence Layer (Adapter-out)
    - path: "adapter-out/persistence-**/src/main/java/**/*.java"
      instructions: |
        CRITICAL RULES:

        1. **Long FK Strategy (ì—„ê²©)**
           - âŒ @ManyToOne private Customer customer;
           - âœ… @Column private Long customerId;
           - Reason: JPA ê´€ê³„ëŠ” N+1, Lazy Loading ë¬¸ì œ ë°œìƒ

        2. **Entity Immutability**
           - Entities should be immutable after construction
           - Use @Column(updatable = false) where appropriate

        3. **QueryDSL Optimization**
           - Use fetchJoin() for collections
           - Check query execution plans
           - Avoid N+1 problems

        4. **CQRS Separation**
           - Separate read/write repositories
           - Use projections for queries

    # REST API Layer (Adapter-in)
    - path: "adapter-in/rest-api/src/main/java/**/*.java"
      instructions: |
        1. **Controller Thin**
           - No business logic in controllers
           - Only request/response transformation

        2. **GlobalExceptionHandler**
           - All exceptions handled centrally
           - Consistent ApiResponse format

        3. **Validation**
           - Use @Valid for request DTOs
           - Domain validation in Domain layer

        4. **API Versioning**
           - Use /api/v1/ prefix

    # Test Code
    - path: "**/src/test/java/**/*.java"
      instructions: |
        1. **Test Coverage**
           - Domain layer: 90%+ required
           - Application layer: 80%+ required

        2. **Test Patterns**
           - Use Test Fixtures for complex objects
           - Given-When-Then structure
           - Descriptive test names

        3. **ArchUnit**
           - Verify layer dependencies
           - Verify naming conventions

        4. **Integration Tests**
           - Use Testcontainers for DB
           - Clean up test data

  # ë„êµ¬ í™œì„±í™” (Java/Spring ì „ìš©)
  tools:
    # Java ì •ì  ë¶„ì„
    pmd:
      enabled: true

    # ë³´ì•ˆ ìŠ¤ìº”
    gitleaks:
      enabled: true

    # Dependency ì·¨ì•½ì 
    trivy:
      enabled: true

    # Dockerfile ê²€ì¦
    hadolint:
      enabled: true

    # YAML ê²€ì¦
    yamllint:
      enabled: true

chat:
  auto_reply: true
  art: false

knowledge_base:
  opt_out: false

  # í”„ë¡œì íŠ¸ ì»¨ë²¤ì…˜ íŒŒì¼ ìë™ í•™ìŠµ
  code_guidelines:
    enabled: true
    filePatterns:
      - "**/.claude/CLAUDE.md"
      - "**/docs/coding_convention/**/*.md"
      - "**/.windsurf/rules/**/*.md"
      - "**/CODING_STANDARDS.md"
      - "**/.cursorrules"

  learnings:
    scope: "local"

  # ì™¸ë¶€ ì§€ì‹ í†µí•© (ì„ íƒ)
  web_search:
    enabled: true

code_generation:
  docstrings:
    language: ko-KR
  unit_tests:
    language: ko-KR
