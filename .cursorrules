# Spring DDD Standards - Cursor AI Rules

> **ì»¨ë²¤ì…˜ ì›ë³¸**: `docs/coding_convention/` (88ê°œ ê·œì¹™)
> **Cache**: `.claude/cache/rules/` (JSON ê²€ìƒ‰ìš©)
> **Global Framework**: `~/.claude/` (SuperClaude)

---

## ğŸ¯ Kent Beck TDD + Tidy First ì² í•™

ì´ í”„ë¡œì íŠ¸ëŠ” **í…ŒìŠ¤íŠ¸ ì£¼ë„ ê°œë°œ (TDD)**ê³¼ **Tidy First (êµ¬ì¡° ë¨¼ì €, ê¸°ëŠ¥ ë‚˜ì¤‘)**ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

### Kent Beckì˜ TDD 3ë‹¨ê³„

```
Red (í…ŒìŠ¤íŠ¸ ì‘ì„±) â†’ Green (ìµœì†Œ êµ¬í˜„) â†’ Refactor (êµ¬ì¡° ê°œì„ )
         â†“                â†“                  â†“
    ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸     í…ŒìŠ¤íŠ¸ í†µê³¼         ì½”ë“œ ê°œì„ 
         â†“                â†“                  â†“
     test: ì»¤ë°‹        feat: ì»¤ë°‹        struct: ì»¤ë°‹
```

### Tidy First í•µì‹¬ ê°œë…

**êµ¬ì¡°ì  ë³€ê²½(Structural)**ê³¼ **ë™ì‘ ë³€ê²½(Behavioral)**ì„ ì ˆëŒ€ ì„ì§€ ë§ ê²ƒ!

#### 1ï¸âƒ£ Structural Changes (êµ¬ì¡°ì  ë³€ê²½)
- **ì •ì˜**: ë™ì‘ì„ ë³€ê²½í•˜ì§€ ì•Šê³  ì½”ë“œ êµ¬ì¡°ë§Œ ê°œì„ 
- **ì˜ˆì‹œ**: ë³€ìˆ˜/ë©”ì„œë“œ ì´ë¦„ ë³€ê²½, ë©”ì„œë“œ ì¶”ì¶œ, ì½”ë“œ ì´ë™, ì¤‘ë³µ ì œê±°
- **ê²€ì¦**: í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ë³€ê²½ ì „í›„ ë™ì¼í•´ì•¼ í•¨
- **ì»¤ë°‹**: `struct:` prefix ì‚¬ìš©

#### 2ï¸âƒ£ Behavioral Changes (ë™ì‘ ë³€ê²½)
- **ì •ì˜**: ì‹¤ì œ ê¸°ëŠ¥ ì¶”ê°€ ë˜ëŠ” ë³€ê²½
- **ì˜ˆì‹œ**: ìƒˆ ë©”ì„œë“œ/í´ë˜ìŠ¤ ì¶”ê°€, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë³€ê²½, ì•Œê³ ë¦¬ì¦˜ ê°œì„ 
- **ì»¤ë°‹**: `test:` (Red) ë˜ëŠ” `feat:` (Green) prefix ì‚¬ìš©

#### 3ï¸âƒ£ ì² ì¹™: ì ˆëŒ€ ì„ì§€ ë§ ê²ƒ!

```
âŒ ì˜ëª»ëœ ì˜ˆ (ì„ìŒ):
- ë©”ì„œë“œ ì´ë¦„ ë³€ê²½ + ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ (ë™ì‹œì—)

âœ… ì˜¬ë°”ë¥¸ ì˜ˆ (ë¶„ë¦¬):
1. struct: ë©”ì„œë“œ ì´ë¦„ ë³€ê²½ â†’ ì»¤ë°‹
2. test: ìƒˆ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì¶”ê°€ â†’ ì»¤ë°‹
3. feat: ìƒˆ ê¸°ëŠ¥ êµ¬í˜„ â†’ ì»¤ë°‹
```

### ì»¤ë°‹ ë©”ì‹œì§€ ê·œì¹™

| Prefix | ìš©ë„ | Phase | ì˜ˆì‹œ |
|--------|------|-------|------|
| `test:` | ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì¶”ê°€ | Red | `test: Email VO ê²€ì¦ í…ŒìŠ¤íŠ¸ ì¶”ê°€` |
| `feat:` | í…ŒìŠ¤íŠ¸ í†µê³¼ êµ¬í˜„ | Green | `feat: Email VO êµ¬í˜„ (RFC 5322)` |
| `struct:` | êµ¬ì¡° ê°œì„  (ë™ì‘ ë™ì¼) | Refactor | `struct: Email ê²€ì¦ ë¡œì§ ë©”ì„œë“œ ì¶”ì¶œ` |
| `fix:` | ë²„ê·¸ ìˆ˜ì • | - | `fix: Email null ì²˜ë¦¬ ëˆ„ë½ ìˆ˜ì •` |
| `chore:` | ë¹Œë“œ/ì„¤ì • ë³€ê²½ | - | `chore: Gradle ë²„ì „ ì—…ë°ì´íŠ¸` |

**í•µì‹¬ ì›ì¹™**:
- âœ… í•œ ì»¤ë°‹ì—ëŠ” í•˜ë‚˜ì˜ íƒ€ì…ë§Œ
- âœ… Structuralê³¼ Behavioral ì ˆëŒ€ ì„ì§€ ì•Šê¸°
- âœ… ì‘ì€ ì»¤ë°‹ (1-3 íŒŒì¼)
- âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ ì‹œì—ë§Œ ì»¤ë°‹

---

## ğŸš¨ Zero-Tolerance (ì ˆëŒ€ ê¸ˆì§€)

### 1. Lombok ê¸ˆì§€
- âŒ `@Data`, `@Builder`, `@Getter`, `@Setter`, `@AllArgsConstructor`, `@NoArgsConstructor`
- âœ… **Pure Java getter/setter ì§ì ‘ ì‘ì„±**
- **ì˜ˆì™¸**: Test Fixture ëª¨ë“ˆì—ì„œë§Œ í—ˆìš©

### 2. Law of Demeter (Getter ì²´ì´ë‹ ê¸ˆì§€)
- âŒ `order.getCustomer().getAddress().getZipCode()`
- âœ… `order.getCustomerZipCode()` **(Tell, Don't Ask)**

### 3. Long FK Strategy (JPA ê´€ê³„ ê¸ˆì§€)
- âŒ `@ManyToOne`, `@OneToMany`, `@OneToOne`, `@ManyToMany`
- âœ… **`private Long userId;` (Long FK ì‚¬ìš©)**

### 4. Transaction ê²½ê³„ & Outbox Pattern
- âŒ `@Transactional` ë‚´ ì™¸ë¶€ API í˜¸ì¶œ
- âœ… **íŠ¸ëœì­ì…˜ì€ ì§§ê²Œ ìœ ì§€, ì™¸ë¶€ í˜¸ì¶œì€ ë°–ì—ì„œ**
- âœ… **ì™¸ë¶€ API í˜¸ì¶œ ì‹œ Transactional Outbox Pattern ì‚¬ìš© (Pattern B ê¶Œì¥)**
  - Pattern A (Direct Event): ì§€ì–‘ - ê²°ì œ/ê¸ˆìœµì—” ë¶€ì í•©
  - **Pattern B (Outbox + Event Wake-up)**: ê¶Œì¥ - í”„ë¡œë•ì…˜ í‘œì¤€
  - Pattern C (MQ Integration): MQ ë„ì… ì‹œ ê¶Œì¥

### 5. Orchestration Pattern
- âŒ `executeInternal()`ì— `@Transactional` ì‚¬ìš©
- âœ… `executeInternal()`ì— `@Async` í•„ìˆ˜, íŠ¸ëœì­ì…˜ ë°–ì—ì„œ ì™¸ë¶€ API í˜¸ì¶œ
- âŒ Commandì— Lombok (`@Data`, `@Builder` ë“±)
- âœ… CommandëŠ” Record íŒ¨í„´ ì‚¬ìš© (`public record XxxCommand`)
- âŒ Operation Entityì— IdemKey Unique ì œì•½ ì—†ìŒ
- âœ… `@UniqueConstraint(columnNames = {"idem_key"})` í•„ìˆ˜
- âŒ Orchestratorê°€ `boolean`/`void` ë°˜í™˜ ë˜ëŠ” Exception throw
- âœ… OrchestratorëŠ” `Outcome` (Ok/Retry/Fail) ë°˜í™˜

### 6. Javadoc í•„ìˆ˜
- âŒ `@author`, `@since` ì—†ëŠ” public í´ë˜ìŠ¤/ë©”ì„œë“œ
- âœ… **ëª¨ë“  public í´ë˜ìŠ¤/ë©”ì„œë“œì— Javadoc**

### 7. Spring í”„ë¡ì‹œ ì œì•½ì‚¬í•­
âš ï¸ **ë‹¤ìŒ ê²½ìš° `@Transactional`ì´ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:**
- Private ë©”ì„œë“œ
- Final í´ë˜ìŠ¤/ë©”ì„œë“œ
- ê°™ì€ í´ë˜ìŠ¤ ë‚´ë¶€ í˜¸ì¶œ (`this.method()`)

---

## ğŸ“‹ Layerë³„ í•„ìˆ˜ ê·œì¹™

### ğŸ”· Domain Layer (Pure Java - ê°€ì¥ ì—„ê²©)

**Zero-Tolerance**:
- âœ… Lombok ì ˆëŒ€ ê¸ˆì§€ (Plain Javaë§Œ)
- âœ… Law of Demeter ì¤€ìˆ˜ (Getter ì²´ì´ë‹ ê¸ˆì§€)
- âœ… Tell, Don't Ask íŒ¨í„´ (ìƒíƒœ ë³€ê²½ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œë¡œ)
- âœ… JPA/Spring ì–´ë…¸í…Œì´ì…˜ ê¸ˆì§€ (Pure Java)
- âœ… Static Factory Methods 3ì¢… (forNew, of, reconstitute)
- âœ… Foreign Key as Value Object (Long â†’ VO)
- âœ… Clock ì˜ì¡´ì„± ì£¼ì… (LocalDateTime.now() ê¸ˆì§€)

**Architecture Patterns**:
- âœ… Aggregate Root, Value Object, Domain Event
- âœ… Immutability (final fields, unmodifiable collections)
- âœ… Factory Pattern (static factory methods)

**ìƒì„¸ ê·œì¹™**: `docs/coding_convention/02-domain-layer/`

### ğŸ”¶ Application Layer (UseCase + Transaction)

**Zero-Tolerance**:
- âœ… Transaction Boundary ì¤€ìˆ˜ (ì™¸ë¶€ API í˜¸ì¶œ ê¸ˆì§€)
- âœ… Spring Proxy ì œì•½ì‚¬í•­ ì¤€ìˆ˜ (private/final/this ê¸ˆì§€)
- âœ… CQRS ì—„ê²© ë¶„ë¦¬ (Command/Query íŒ¨í‚¤ì§€ ë¶„ë¦¬)
- âœ… DTO Package ë¶„ë¦¬ (dto/command, dto/query, dto/response)
- âœ… Single Responsibility (í•œ UseCase = í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ì‘ì—…)
- âœ… Assembler Pattern (DTO â†” Domain ë³€í™˜ ì§‘ì¤‘)

**Transaction Management**:
- âœ… @Transactionalì€ UseCase(Service)ì—ë§Œ
- âœ… FacadeëŠ” íŠ¸ëœì­ì…˜ ë°–ì—ì„œ ì¡°í•©
- âœ… Transaction Manager: ë‹¨ì¼ Port íŠ¸ëœì­ì…˜ ì²˜ë¦¬

**ìƒì„¸ ê·œì¹™**: `docs/coding_convention/03-application-layer/`

### ğŸ”· Persistence Layer (Adapter-out)

**Zero-Tolerance**:
- âœ… Long FK Strategy ì—„ê²© ì¤€ìˆ˜ (JPA ê´€ê³„ ê¸ˆì§€)
- âœ… Entity Construction Pattern (of() public, ìƒì„±ì private)
- âœ… BaseAuditEntity / SoftDeletableEntity í™œìš©
- âœ… Entity Immutability (Setter ê¸ˆì§€, Getterë§Œ)
- âœ… CQRS Separation (Command: JpaRepository, Query: QueryDSL)
- âœ… Transactionì€ Application Layer ì „ìš© (Adapterì— @Transactional ê¸ˆì§€)

**QueryDSL Optimization**:
- âœ… fetchJoin() for collections
- âœ… Query execution plan í™•ì¸
- âœ… N+1 ë°©ì§€

**ìƒì„¸ ê·œì¹™**: `docs/coding_convention/04-persistence-layer/`

### ğŸ”¶ REST API Layer (Adapter-in)

**Zero-Tolerance**:
- âœ… Thin Controller (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê¸ˆì§€)
- âœ… ResponseEntity<ApiResponse<T>> ë˜í•‘ í•„ìˆ˜
- âœ… @Valid ê²€ì¦ í•„ìˆ˜
- âœ… DELETE ë©”ì„œë“œ ê¸ˆì§€ (ì†Œí”„íŠ¸ ì‚­ì œëŠ” PATCH)
- âœ… Exception Handling (GlobalExceptionHandler ìœ„ì„)
- âœ… Mapper DI (@Component, static ê¸ˆì§€)
- âœ… DTO Pattern (Java 21 Record, Lombok ê¸ˆì§€)

**RESTful URI**:
- âœ… ë¦¬ì†ŒìŠ¤ ë³µìˆ˜í˜• (/orders)
- âŒ ë™ì‚¬ ê¸ˆì§€ (/createOrder)
- âœ… ìƒíƒœ ë³€ê²½ì€ PATCH (/orders/{id}/cancel)

**ìƒì„¸ ê·œì¹™**: `docs/coding_convention/01-adapter-in-layer/rest-api/`

### ğŸ§ª Testing

**Test Coverage**:
- âœ… Domain layer: 90%+ required
- âœ… Application layer: 80%+ required

**Test Patterns**:
- âœ… Test Fixtures (Layerë³„ ë…ë¦½ ëª¨ë“ˆ)
- âœ… Given-When-Then êµ¬ì¡°
- âœ… @DisplayName (ì„¤ëª…ì ì¸ í…ŒìŠ¤íŠ¸ëª…)
- âœ… ArchUnit (ì•„í‚¤í…ì²˜ ê·œì¹™ ê²€ì¦)
- âœ… Integration Tests (Testcontainers)

**ìƒì„¸ ê·œì¹™**: `docs/coding_convention/05-testing/`

---

## ğŸ› ï¸ ê°œë°œ ì›Œí¬í”Œë¡œìš°

### TDD ì‚¬ì´í´ (5-15ë¶„)

```bash
# ğŸ”´ Red Phase: ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì‘ì„±
vim domain/src/test/java/.../EmailTest.java
./gradlew test  # ì‹¤íŒ¨ í™•ì¸
git commit -m "test: Email VO ê²€ì¦ í…ŒìŠ¤íŠ¸ ì¶”ê°€"

# ğŸŸ¢ Green Phase: ìµœì†Œ êµ¬í˜„
vim domain/src/main/java/.../Email.java
./gradlew test  # í†µê³¼ í™•ì¸
git commit -m "feat: Email VO êµ¬í˜„ (RFC 5322 ê²€ì¦)"

# â™»ï¸ Refactor Phase: êµ¬ì¡° ê°œì„  (í•„ìš” ì‹œ)
vim domain/src/main/java/.../Email.java
./gradlew test  # ì—¬ì „íˆ í†µê³¼ í™•ì¸
git commit -m "struct: Email ê²€ì¦ ë¡œì§ ë©”ì„œë“œ ì¶”ì¶œ"
```

### ArchUnit ê²€ì¦

```bash
# ì „ì²´ ì•„í‚¤í…ì²˜ ê²€ì¦
./gradlew test --tests "*.architecture.*"

# Layerë³„ ê²€ì¦
./gradlew test --tests "*DomainLayerArchTest"
./gradlew test --tests "*ApplicationLayerArchTest"
./gradlew test --tests "*PersistenceLayerArchTest"
./gradlew test --tests "*RestApiLayerArchTest"
```

### LangFuse ë©”íŠ¸ë¦­ (ìë™ ìˆ˜ì§‘)

```bash
# JSONL ë¡œê·¸ í™•ì¸
tail -f ~/.claude/logs/tdd-cycle.jsonl

# LangFuse ëŒ€ì‹œë³´ë“œ
open https://us.cloud.langfuse.com

# ìë™ ì¶”ì :
- TDD Phase (test:/feat:/struct:)
- ì»¤ë°‹ í¬ê¸° (íŒŒì¼/ë¼ì¸ ìˆ˜)
- Tidy First ì¤€ìˆ˜ìœ¨
```

---

## ğŸ”— ìƒì„¸ ê·œì¹™ ì°¸ì¡°

**Cursor AIëŠ” ì•„ë˜ ë””ë ‰í† ë¦¬ì˜ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì„ ìë™ìœ¼ë¡œ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:**

### í•µì‹¬ ë¬¸ì„œ
- `.claude/CLAUDE.md` - í”„ë¡œì íŠ¸ ì „ì²´ ì„¤ì •
- `docs/coding_convention/` - 88ê°œ ìƒì„¸ ê·œì¹™

### Layerë³„ ê°€ì´ë“œ
- `docs/coding_convention/02-domain-layer/` - Domain ê·œì¹™ (12ê°œ)
- `docs/coding_convention/03-application-layer/` - Application ê·œì¹™ (26ê°œ)
- `docs/coding_convention/04-persistence-layer/` - Persistence ê·œì¹™ (23ê°œ)
- `docs/coding_convention/01-adapter-in-layer/rest-api/` - REST API ê·œì¹™ (22ê°œ)
- `docs/coding_convention/05-testing/` - Testing ê·œì¹™ (3ê°œ)

### íŒ¨í„´ ê°€ì´ë“œ
- `docs/coding_convention/06-java21-patterns/` - Java 21 íŒ¨í„´
- `docs/coding_convention/07-enterprise-patterns/` - ì—”í„°í”„ë¼ì´ì¦ˆ íŒ¨í„´
- `docs/coding_convention/09-orchestration-patterns/` - Orchestration íŒ¨í„´

---

## ğŸ“Š ArchUnit ê²€ì¦ í•­ëª©

### Layer Dependencies
```java
// Domainì€ ì–´ë–¤ layerë„ ì°¸ì¡°í•˜ì§€ ì•ŠìŒ
noClasses().that().resideIn("..domain..").should().dependOnClassesThat().resideIn("..application..")
noClasses().that().resideIn("..domain..").should().dependOnClassesThat().resideIn("..persistence..")
noClasses().that().resideIn("..domain..").should().dependOnClassesThat().resideIn("..adapter..")

// Applicationì€ Domainë§Œ ì°¸ì¡°
classes().that().resideIn("..application..").should().onlyDependOnClassesThat().resideIn("..domain..", "..application..", "java..", "org.springframework..")

// PersistenceëŠ” Domainê³¼ Application Portë§Œ ì°¸ì¡°
classes().that().resideIn("..persistence..").should().onlyDependOnClassesThat().resideIn("..domain..", "..application.port.out..", "..persistence..", "java..", "org.springframework..", "jakarta.persistence..")
```

### Zero-Tolerance Rules
```java
// Lombok ê¸ˆì§€ (Domain/Application/Persistence)
noClasses().that().resideIn("..domain..").should().beAnnotatedWith(Data.class)
noClasses().that().resideIn("..domain..").should().beAnnotatedWith(Builder.class)

// JPA ê´€ê³„ ê¸ˆì§€ (Persistence)
noFields().that().areDeclaredIn("..persistence.entity..").should().beAnnotatedWith(ManyToOne.class)
noFields().that().areDeclaredIn("..persistence.entity..").should().beAnnotatedWith(OneToMany.class)

// Transactionì€ Application Layerë§Œ
noClasses().that().resideIn("..persistence..").should().beAnnotatedWith(Transactional.class)
noClasses().that().resideIn("..domain..").should().beAnnotatedWith(Transactional.class)
```

### Naming Conventions
```java
// UseCase Interface ë„¤ì´ë°
classes().that().resideIn("..application.port.in.command..").should().haveSimpleNameEndingWith("UseCase")
classes().that().resideIn("..application.port.in.query..").should().haveSimpleNameEndingWith("Query")

// Adapter ë„¤ì´ë°
classes().that().resideIn("..persistence.adapter..").should().haveSimpleNameEndingWith("Adapter")
classes().that().resideIn("..rest.controller..").should().haveSimpleNameEndingWith("Controller")
```

---

## ğŸ“ Best Practices

### 1. TDD ì‚¬ì´í´ì€ ì§§ê²Œ (5-15ë¶„)
- ì‘ì€ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´ Red â†’ Green â†’ Refactor
- í° ê¸°ëŠ¥ì€ ì—¬ëŸ¬ ì‚¬ì´í´ë¡œ ë¶„í• 

### 2. ì»¤ë°‹ì€ ë” ì‘ê²Œ (1-3 íŒŒì¼)
- Structuralê³¼ Behavioral ì ˆëŒ€ ì„ì§€ ì•Šê¸°
- í•œ ì»¤ë°‹ = í•œ ë³€ê²½ (Single Responsibility)

### 3. í…ŒìŠ¤íŠ¸ ë¨¼ì €, êµ¬í˜„ì€ ë‚˜ì¤‘
- Red Phase ì—†ì´ Green Phase ì‹œì‘ ê¸ˆì§€
- í…ŒìŠ¤íŠ¸ê°€ ì—†ëŠ” ì½”ë“œëŠ” ë ˆê±°ì‹œ

### 4. ArchUnitìœ¼ë¡œ ê·œì¹™ ê°•ì œ
- CI/CDì— ArchUnit í…ŒìŠ¤íŠ¸ í¬í•¨
- Zero-Tolerance ìœ„ë°˜ ì‹œ ë¹Œë“œ ì‹¤íŒ¨

### 5. LangFuseë¡œ ë©”íŠ¸ë¦­ ì¶”ì 
- TDD ì‚¬ì´í´ ì‹œê°„ ìµœì í™”
- Tidy First ì¤€ìˆ˜ìœ¨ ëª¨ë‹ˆí„°ë§
- ì»¤ë°‹ í¬ê¸° ìµœì í™”

---

**âœ… ì´ ê·œì¹™ë“¤ì„ ì¤€ìˆ˜í•˜ë©´ Claude Codeì™€ CodeRabbit ê²€ì¦ì„ ëª¨ë‘ í†µê³¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!**
