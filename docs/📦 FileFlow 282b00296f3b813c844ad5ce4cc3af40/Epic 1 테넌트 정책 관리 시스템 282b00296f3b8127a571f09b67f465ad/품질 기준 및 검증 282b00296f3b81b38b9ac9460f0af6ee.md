# 품질 기준 및 검증

# ✅ 품질 기준 및 검증

## 개요

FileFlow Epic 1의 모든 코드는 엄격한 품질 기준을 준수해야 합니다. 이 문서는 자동화된 검증 도구와 수동 체크리스트를 포함합니다.

---

## 아키텍처 규칙 (ArchUnit)

### 1. Domain 순수성 검증

**규칙**:

- Domain 계층은 Spring, JPA, Lombok 의존성이 없어야 함
- Domain은 순수 Java만 사용
- Domain은 Application/Adapter에 의존하지 않음

**ArchUnit 테스트**:

```java
@Test
void domain_계층은_순수해야_한다() {
    noClasses()
        .that().resideInPackage("..domain..")
        .should().dependOnClassesThat().resideInAnyPackage(
            "org.springframework..",
            "javax.persistence..",
            "lombok.."
        )
        .check(importedClasses);
}
```

### 2. 의존성 방향 검증

**규칙**:

- Application → Domain (허용)
- Adapter → Application (허용)
- Adapter → Domain (허용)
- Domain → Application (금지)
- Application → Adapter (금지)
- Adapter → Adapter (금지)

**ArchUnit 테스트**:

```java
@Test
void 계층_의존성_규칙을_준수해야_한다() {
    layeredArchitecture()
        .consideringAllDependencies()
        .layer("Domain").definedBy("..domain..")
        .layer("Application").definedBy("..application..")
        .layer("Adapter").definedBy("..adapter..")
        .whereLayer("Domain").mayOnlyBeAccessedByLayers("Application", "Adapter")
        .whereLayer("Application").mayOnlyBeAccessedByLayers("Adapter")
        .check(importedClasses);
}
```

### 3. Port 명명 규칙

**규칙**:

- Input Port는 "UseCase"로 끝남
- Output Port는 "Port"로 끝남

**ArchUnit 테스트**:

```java
@Test
void 포트_명명_규칙을_준수해야_한다() {
    classes()
        .that().resideInPackage("..[application.port.in](http://application.port.in)..")
        .should().haveSimpleNameEndingWith("UseCase")
        .check(importedClasses);
    
    classes()
        .that().resideInPackage("..application.port.out..")
        .should().haveSimpleNameEndingWith("Port")
        .check(importedClasses);
}
```

---

## Checkstyle 규칙

### 1. Javadoc 필수

**규칙**:

- 모든 public class, method는 Javadoc 필수
- @author 태그 필수
- @since 태그 권장

**예시**:

```java
/**
 * 업로드 정책을 관리하는 Aggregate Root
 *
 * @author John Doe ([john.doe@example.com](mailto:john.doe@example.com))
 * @since 2025-10-04
 */
public class UploadPolicy {
    // ...
}
```

### 2. Lombok 사용 금지

**규칙**:

- @Getter, @Setter, @Builder, @Data 등 모든 Lombok 어노테이션 금지
- 생성자, getter 직접 구현

**검증 방법**:

```bash
grep -r "import lombok" src/
# 결과가 없어야 함
```

### 3. 명명 규칙

**클래스명**:

- UpperCamelCase
- 명사 또는 명사구
- 의미 있는 이름 (MyClass, Data 등 금지)

**메서드명**:

- lowerCamelCase
- 동사로 시작
- 명확한 의도 전달

**상수**:

- UPPER_SNAKE_CASE
- static final

---

## SpotBugs 검증

### 1. NULL 안전성

**규칙**:

- NullPointerException 가능성 제거
- Optional 적절히 사용
- @Nullable, @NonNull 어노테이션 활용

### 2. 리소스 누수 방지

**규칙**:

- try-with-resources 사용
- Stream, Connection 등 적절히 close

### 3. 동시성 이슈

**규칙**:

- 불변 객체 우선 사용
- synchronized 적절히 사용

---

## 테스트 커버리지 (JaCoCo)

### 목표 커버리지

| 계층 | Line Coverage | Branch Coverage |
| --- | --- | --- |
| Domain | 90% 이상 | 85% 이상 |
| Application | 80% 이상 | 75% 이상 |
| Adapter | 70% 이상 | 65% 이상 |

### 검증 명령어

```bash
# 커버리지 리포트 생성
./gradlew jacocoTestReport

# 커버리지 검증
./gradlew jacocoTestCoverageVerification
```

### 제외 대상

- Configuration 클래스
- DTO (단순 데이터 전달)
- Exception 클래스
- Main 클래스

---

## Git Pre-commit Hook

### 설치

```bash
ln -s ../../hooks/pre-commit .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```

### 검증 항목

**1. Domain Validator**

- Domain 패키지에 Spring/JPA/Lombok import 있는지 확인
- 발견 시 커밋 차단

**2. Application Validator**

- Application 패키지에 Adapter import 있는지 확인
- @Transactional 사용 확인

**3. Persistence Validator**

- Entity 클래스에 Lombok 사용 확인

**4. Controller Validator**

- Controller에 Repository 직접 의존 확인
- UseCase만 의존해야 함

**5. Common Validator**

- System.out.println 사용 확인
- 하드코딩된 비밀번호/키 확인

**6. Dead Code Detector**

- 사용되지 않는 import 확인
- 사용되지 않는 변수 확인

---

## 코딩 컨벤션

### 1. Constructor Injection Only

**좋은 예**:

```java
public class GetPolicyService implements GetPolicyUseCase {
    private final LoadPolicyPort loadPolicyPort;
    private final CachePolicyPort cachePolicyPort;
    
    public GetPolicyService(
        LoadPolicyPort loadPolicyPort,
        CachePolicyPort cachePolicyPort
    ) {
        this.loadPolicyPort = loadPolicyPort;
        this.cachePolicyPort = cachePolicyPort;
    }
}
```

**나쁜 예**:

```java
@Service
public class GetPolicyService {
    @Autowired  // ❌ Field Injection
    private LoadPolicyPort loadPolicyPort;
}
```

### 2. Immutability

**좋은 예**:

```java
public final class PolicyKey {
    private final String tenantId;
    private final String userType;
    private final String serviceType;
    
    public PolicyKey(String tenantId, String userType, String serviceType) {
        this.tenantId = tenantId;
        this.userType = userType;
        this.serviceType = serviceType;
    }
    
    // Only getters, no setters
}
```

### 3. Self-Validation

**좋은 예**:

```java
public ImagePolicy(int maxFileSizeMB, int maxFileCount, ...) {
    if (maxFileSizeMB < 1 || maxFileSizeMB > 100) {
        throw new IllegalArgumentException(
            "Max file size must be between 1 and 100 MB"
        );
    }
    this.maxFileSizeMB = maxFileSizeMB;
    // ...
}
```

---

## 최종 체크리스트

### Domain 계층

- [ ]  Lombok 미사용 (전체)
- [ ]  Spring 의존성 없음
- [ ]  JPA 의존성 없음
- [ ]  Immutable Value Objects
- [ ]  Self-Validation 구현
- [ ]  테스트 커버리지 90% 이상
- [ ]  Javadoc 완성
- [ ]  @author 태그 포함

### Application 계층

- [ ]  Lombok 미사용
- [ ]  Port 인터페이스 정의
- [ ]  @Transactional 없음
- [ ]  Constructor Injection only
- [ ]  테스트 커버리지 80% 이상
- [ ]  Javadoc 완성

### Adapter 계층

- [ ]  Lombok 미사용
- [ ]  Port 구현체만 생성
- [ ]  Controller → UseCase만 의존
- [ ]  Persistence → Repository만 의존
- [ ]  테스트 커버리지 70% 이상

### 공통

- [ ]  ArchUnit 테스트 통과
- [ ]  Checkstyle 위반 없음
- [ ]  SpotBugs 버그 없음
- [ ]  Pre-commit hook 통과
- [ ]  데드코드 없음

---

## 검증 명령어 모음

```bash
# 전체 품질 검증
./gradlew clean build

# ArchUnit 테스트
./gradlew :domain:test --tests "*ArchitectureTest"

# Checkstyle
./gradlew checkstyleMain checkstyleTest

# SpotBugs
./gradlew spotbugsMain

# 테스트 커버리지
./gradlew jacocoTestReport jacocoTestCoverageVerification

# Pre-commit hook 수동 실행
.git/hooks/pre-commit
```

---

## 관련 Task

- **Task 1.8**: 품질 게이트 통과 (4시간)
    - ArchUnit 테스트 작성
    - Checkstyle 설정
    - SpotBugs 설정
    - JaCoCo 설정
    - Pre-commit hook 설치
    - 모든 검증 통과