# 데이터베이스 스키마

## 개요

MySQL 기반의 정책 관리 시스템 데이터베이스 스키마입니다.

**총 테이블 수**: 4개 (정책 관리 전용)

- `tenant`
- `upload_policy`
- `processing_policy`
- `policy_change_log`

---

## ERD (Entity Relationship Diagram)

```
tenant (1) ────────────── (N) upload_policy
                               │
                               │ (1:N)
                               ├──────► processing_policy
                               │
                               └──────► policy_change_log
```

---

## 1. tenant

**목적**: 테넌트 기본 정보 관리

```sql
CREATE TABLE tenant (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id VARCHAR(50) UNIQUE NOT NULL COMMENT 'b2c, b2b',
    name VARCHAR(100) NOT NULL COMMENT '테넌트 이름',
    description TEXT COMMENT '테넌트 설명',
    is_active BOOLEAN DEFAULT TRUE COMMENT '활성 상태',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_is_active (is_active)
) COMMENT '테넌트 기본 정보';
```

**초기 데이터**:

```sql
INSERT INTO tenant (tenant_id, name, description) VALUES
('b2c', 'B2C 테넌트', 'B2C 비즈니스용'),
('b2b', 'B2B 테넌트', 'B2B 비즈니스용');
```

---

## 2. upload_policy

**목적**: 테넌트/사용자별 업로드 정책 관리

```sql
CREATE TABLE upload_policy (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    policy_key VARCHAR(100) UNIQUE NOT NULL COMMENT '정책 식별자',
    
    -- 정책 식별 정보
    tenant_id VARCHAR(50) NOT NULL COMMENT 'b2c, b2b',
    user_type VARCHAR(50) NOT NULL COMMENT 'CONSUMER, SELLER, CRAWLER, BUYER',
    service_type VARCHAR(50) NOT NULL COMMENT 'REVIEW, PRODUCT, ORDER_SHEET',
    
    -- 파일 타입별 정책 (JSON)
    file_type_policies JSON NOT NULL COMMENT '파일 타입별 상세 정책',
    
    -- Rate Limiting
    rate_limit_requests_per_hour INT COMMENT '시간당 요청 제한',
    rate_limit_uploads_per_day INT COMMENT '일일 업로드 제한',
    
    -- 버전 관리
    version INT DEFAULT 1 COMMENT '정책 버전',
    is_active BOOLEAN DEFAULT TRUE COMMENT '활성 상태',
    effective_from DATETIME COMMENT '정책 적용 시작일',
    effective_until DATETIME COMMENT '정책 적용 종료일',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by VARCHAR(100) COMMENT '생성자',
    updated_by VARCHAR(100) COMMENT '수정자',
    
    INDEX idx_policy_key (policy_key),
    INDEX idx_tenant_user_service (tenant_id, user_type, service_type),
    INDEX idx_is_active (is_active),
    INDEX idx_effective_dates (effective_from, effective_until),
    
    CONSTRAINT fk_upload_policy_tenant 
        FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id)
) COMMENT '업로드 정책';
```

### file_type_policies JSON 구조

```json
{
  "IMAGE": {
    "maxFileSizeMB": 15,
    "maxFileCount": 10,
    "allowedFormats": ["jpg", "jpeg", "png", "webp"],
    "maxDimension": {
      "width": 8192,
      "height": 8192
    }
  },
  "HTML": {
    "maxFileSizeMB": 5,
    "maxImageCount": 50,
    "downloadExternalImages": true
  },
  "EXCEL": {
    "maxFileSizeMB": 20,
    "maxSheetCount": 10
  },
  "PDF": {
    "maxFileSizeMB": 30,
    "maxPageCount": 100
  }
}
```

---

## 3. processing_policy

**목적**: 파일 후처리 파이프라인 정책 관리

```sql
CREATE TABLE processing_policy (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    policy_key VARCHAR(100) NOT NULL COMMENT '업로드 정책과 동일한 키',
    file_type VARCHAR(50) NOT NULL COMMENT 'IMAGE, HTML, EXCEL, PDF',
    
    -- 파이프라인 설정 (JSON)
    pipeline_config JSON NOT NULL COMMENT '파이프라인 단계 설정',
    
    -- 실행 옵션
    auto_execute BOOLEAN DEFAULT TRUE COMMENT '자동 실행 여부',
    retry_on_failure BOOLEAN DEFAULT TRUE COMMENT '실패 시 재시도 여부',
    max_retry_count INT DEFAULT 3 COMMENT '최대 재시도 횟수',
    
    -- 알림 설정
    notify_on_completion BOOLEAN DEFAULT FALSE COMMENT '완료 시 알림',
    notify_on_failure BOOLEAN DEFAULT TRUE COMMENT '실패 시 알림',
    notification_config JSON COMMENT '알림 설정',
    
    -- 버전 관리
    version INT DEFAULT 1 COMMENT '정책 버전',
    is_active BOOLEAN DEFAULT TRUE COMMENT '활성 상태',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    updated_by VARCHAR(100),
    
    INDEX idx_policy_key (policy_key),
    INDEX idx_file_type (file_type),
    INDEX idx_is_active (is_active),
    UNIQUE KEY uk_policy_file_version (policy_key, file_type, version)
) COMMENT '후처리 정책';
```

### pipeline_config JSON 구조

```json
{
  "pipeline": [
    {
      "step": "OPTIMIZE",
      "order": 1,
      "enabled": true,
      "config": {
        "quality": 90,
        "stripMetadata": false
      }
    },
    {
      "step": "THUMBNAIL",
      "order": 2,
      "enabled": true,
      "config": {
        "sizes": [
          {"name": "small", "width": 300, "height": 300},
          {"name": "medium", "width": 800, "height": 800}
        ]
      }
    },
    {
      "step": "OCR",
      "order": 3,
      "enabled": true,
      "config": {
        "extractFields": ["material", "origin", "washingMethod", "size"]
      }
    },
    {
      "step": "CDN_DEPLOY",
      "order": 4,
      "enabled": true
    }
  ]
}
```

---

## 4. policy_change_log

**목적**: 정책 변경 이력 추적 (감사용)

```sql
CREATE TABLE policy_change_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    policy_key VARCHAR(100) NOT NULL COMMENT '정책 키',
    policy_type VARCHAR(50) NOT NULL COMMENT 'UPLOAD, PROCESSING',
    
    action VARCHAR(50) NOT NULL COMMENT 'CREATE, UPDATE, ACTIVATE, DEACTIVATE',
    
    version_before INT COMMENT '이전 버전',
    version_after INT COMMENT '새 버전',
    
    changed_by VARCHAR(100) NOT NULL COMMENT '변경자',
    changed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    change_summary VARCHAR(500) COMMENT '변경 요약',
    
    INDEX idx_policy_key (policy_key),
    INDEX idx_changed_at (changed_at)
) COMMENT '정책 변경 이력';
```

---

## 초기 데이터 (Seed Data)

### B2C Consumer Review Policy

```sql
INSERT INTO upload_policy (
    policy_key, tenant_id, user_type, service_type,
    file_type_policies,
    rate_limit_requests_per_hour,
    is_active, effective_from, created_by
) VALUES (
    'b2c:CONSUMER:REVIEW', 'b2c', 'CONSUMER', 'REVIEW',
    '{
        "IMAGE": {
            "maxFileSizeMB": 10,
            "maxFileCount": 5,
            "allowedFormats": ["jpg", "jpeg", "png", "gif"],
            "maxDimension": {"width": 4096, "height": 4096}
        }
    }',
    50,
    TRUE, NOW(), 'SYSTEM'
);
```

### B2C Seller Product Policy

```sql
INSERT INTO upload_policy (
    policy_key, tenant_id, user_type, service_type,
    file_type_policies,
    rate_limit_requests_per_hour,
    is_active, effective_from, created_by
) VALUES (
    'b2c:SELLER:PRODUCT', 'b2c', 'SELLER', 'PRODUCT',
    '{
        "IMAGE": {
            "maxFileSizeMB": 15,
            "maxFileCount": 10,
            "allowedFormats": ["jpg", "jpeg", "png", "webp"],
            "maxDimension": {"width": 8192, "height": 8192}
        },
        "HTML": {
            "maxFileSizeMB": 5,
            "maxImageCount": 50,
            "downloadExternalImages": true
        }
    }',
    200,
    TRUE, NOW(), 'SYSTEM'
);
```

### B2B Buyer Order Sheet Policy

```sql
INSERT INTO upload_policy (
    policy_key, tenant_id, user_type, service_type,
    file_type_policies,
    rate_limit_requests_per_hour,
    is_active, effective_from, created_by
) VALUES (
    'b2b:BUYER:ORDER_SHEET', 'b2b', 'BUYER', 'ORDER_SHEET',
    '{
        "EXCEL": {
            "maxFileSizeMB": 20,
            "maxSheetCount": 10
        },
        "PDF": {
            "maxFileSizeMB": 30,
            "maxPageCount": 100
        }
    }',
    100,
    TRUE, NOW(), 'SYSTEM'
);
```

---

## 인덱스 전략

### 조회 패턴 분석

**1. 정책 조회 (가장 빈번)**

```sql
SELECT * FROM upload_policy 
WHERE tenant_id = ? AND user_type = ? AND service_type = ?
AND is_active = TRUE;
```

→ `idx_tenant_user_service` 복합 인덱스

**2. 활성 정책 목록**

```sql
SELECT * FROM upload_policy WHERE is_active = TRUE;
```

→ `idx_is_active` 단일 인덱스

**3. 정책 변경 이력 조회**

```sql
SELECT * FROM policy_change_log 
WHERE policy_key = ? ORDER BY changed_at DESC;
```

→ `idx_policy_key`, `idx_changed_at` 인덱스

---

## Flyway 마이그레이션

### 파일 구조

```
db/migration/
├── V1__create_tenant_table.sql
├── V2__create_upload_policy_table.sql
├── V3__create_processing_policy_table.sql
├── V4__create_policy_change_log_table.sql
└── V5__insert_initial_data.sql
```

**관련 Task**: Task 1.7 - Flyway 마이그레이션 (2시간)

---

## 관련 문서

- Epic 1 메인
- 
    
    [도메인 모델 상세](%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4%20%EC%8A%A4%ED%82%A4%EB%A7%88%20282b00296f3b813abdedf49018cadd7e/%EB%8F%84%EB%A9%94%EC%9D%B8%20%EB%AA%A8%EB%8D%B8%20%EC%83%81%EC%84%B8%206809f6d8a0a847e38dfc86daabc0b325.md)