# Epic 3: ì´ë¯¸ì§€ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸

## ğŸ¯ ëª©í‘œ

ì´ë¯¸ì§€ ìµœì í™” ë° ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ìë™í™”

## ğŸ“Š Epic ì •ë³´

- **Jira Epic**: [KAN-27](https://ryuqqq.atlassian.net/browse/KAN-27)
- **ìƒíƒœ**: â³ ëŒ€ê¸° ì¤‘
- **ì˜ˆìƒ ì‹œê°„**: 93ì‹œê°„ (ì•½ 12ì¼)
- **ìš°ì„ ìˆœìœ„**: P2
- **ì˜ì¡´ì„±**: Epic 2 ì™„ë£Œ í•„ìš” (íŒŒì¼ ì—…ë¡œë“œ ê¸°ë°˜)

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ê°œìš”

### íŒŒì´í”„ë¼ì¸ íë¦„

```
[ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ] (Epic 2)
        â†“
[íŒŒì´í”„ë¼ì¸ íŠ¸ë¦¬ê±°]
        â†“
    [ë¹„ë™ê¸° ì²˜ë¦¬]
        â†“
   â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”
   â”‚         â”‚         â”‚
[Stage 1] [Stage 2] [Stage 3]
   â”‚         â”‚         â”‚
[ìµœì í™”]  [ì¸ë„¤ì¼]  [OCR]
   â”‚         â”‚         â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚
   [Stage 4]
        â”‚
   [CDN ë°°í¬]
        â†“
    [ì™„ë£Œ]
```

### 4ë‹¨ê³„ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸

1. **Stage 1**: ì´ë¯¸ì§€ ìµœì í™” (WebP ë³€í™˜, ì••ì¶•)
2. **Stage 2**: ì¸ë„¤ì¼ ìƒì„± (Small 300x300, Medium 800x800)
3. **Stage 3**: OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ (ìƒí’ˆ ì •ë³´ íŒŒì‹±)
4. **Stage 4**: CDN ë°°í¬ (CloudFront)

---

## ğŸ“¦ ì£¼ìš” ê¸°ëŠ¥

### 1. ì´ë¯¸ì§€ ìµœì í™”

### WebP ë³€í™˜

**ëª©ì **: íŒŒì¼ í¬ê¸° ì¶•ì†Œ ë° í’ˆì§ˆ ìœ ì§€

**ë³€í™˜ ëŒ€ìƒ**:

- JPEG â†’ WebP
- PNG â†’ WebP (Alpha ì±„ë„ ìœ ì§€)
- GIF â†’ WebP (ì• ë‹ˆë©”ì´ì…˜ ì§€ì›)

**ê¸°ìˆ  ìŠ¤íƒ**:

- **Thumbnailator**: Java ì´ë¯¸ì§€ ì²˜ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬
- **WebP Plugin**: WebP í¬ë§· ì§€ì›

**ë³€í™˜ ì˜µì…˜**:

```java
WebPOptions options = new WebPOptions();
options.setQuality(90);  // í’ˆì§ˆ 90%
options.setLossless(false);  // ì†ì‹¤ ì••ì¶•
options.setPreserveMetadata(false);  // EXIF ì œê±°
```

**ê¸°ëŒ€ íš¨ê³¼**:

- JPEG ëŒ€ë¹„ 25-35% íŒŒì¼ í¬ê¸° ê°ì†Œ
- PNG ëŒ€ë¹„ 50-70% íŒŒì¼ í¬ê¸° ê°ì†Œ
- í’ˆì§ˆ ì €í•˜ ìµœì†Œí™”

### ì´ë¯¸ì§€ ì••ì¶•

**í’ˆì§ˆ ê¸°ì¤€**: 90%

**í¬ë§·ë³„ ì••ì¶• ì „ëµ**:

- **JPEG**: MozJPEG ì•Œê³ ë¦¬ì¦˜
- **PNG**: OptiPNG + PNGQuant
- **WebP**: Google libwebp

**ì••ì¶• ì•Œê³ ë¦¬ì¦˜**:

```java
interface CompressionStrategy {
    byte[] compress(byte[] imageData, int quality);
}

class JpegCompressionStrategy implements CompressionStrategy {
    // MozJPEG ê¸°ë°˜ ì••ì¶•
}

class PngCompressionStrategy implements CompressionStrategy {
    // OptiPNG + PNGQuant ì‚¬ìš©
}
```

### EXIF ë©”íƒ€ë°ì´í„° ì²˜ë¦¬

**ì œê±° ëŒ€ìƒ**:

- GPS ìœ„ì¹˜ ì •ë³´
- ì¹´ë©”ë¼ ê¸°ê¸° ì •ë³´
- ì´¬ì˜ ì¼ì‹œ

**ìœ ì§€ ëŒ€ìƒ**:

- ì €ì‘ê¶Œ ì •ë³´
- Orientation íƒœê·¸ (ìë™ íšŒì „ í›„ ì œê±°)

**ì²˜ë¦¬ ë¡œì§**:

1. EXIF ë°ì´í„° ì½ê¸°
2. Orientation ê¸°ë°˜ ì´ë¯¸ì§€ íšŒì „
3. ê°œì¸ì •ë³´ ì œê±°
4. í•„ìš”í•œ ì •ë³´ë§Œ file_metadataì— ì €ì¥

### 2. ì¸ë„¤ì¼ ìƒì„±

### ì¸ë„¤ì¼ í¬ê¸° ì •ì˜

**SMALL**: 300x300

- ì‚¬ìš©ì²˜: ëª©ë¡ ë·°, ë¯¸ë¦¬ë³´ê¸°
- ë¦¬ì‚¬ì´ì§•: Center Crop (ì •ì‚¬ê°í˜•)
- í¬ë§·: WebP

**MEDIUM**: 800x800

- ì‚¬ìš©ì²˜: ìƒì„¸ ë·°, ëª¨ë°”ì¼
- ë¦¬ì‚¬ì´ì§•: Aspect Ratio ìœ ì§€ Fit
- í¬ë§·: WebP

### ë¦¬ì‚¬ì´ì§• ì•Œê³ ë¦¬ì¦˜

**Lanczos3 ë¦¬ìƒ˜í”Œë§**:

- ìµœê³  í’ˆì§ˆì˜ ë¦¬ì‚¬ì´ì§• ì•Œê³ ë¦¬ì¦˜
- ì„ ëª…ë„ ìœ ì§€
- ì—ì¼ë¦¬ì–´ì‹± ë°©ì§€

**ì„ ëª…í™” ì²˜ë¦¬**:

- Unsharp Mask ì ìš©
- ë¦¬ì‚¬ì´ì§• í›„ ì„ ëª…ë„ ì†ì‹¤ ë³´ì •
- ê³¼ë„í•œ ìƒ¤í”„ë‹ ë°©ì§€

### íŒŒì¼ëª… ê·œì¹™

```
ì›ë³¸: product-12345.jpg
Small: product-12345_small.webp
Medium: product-12345_medium.webp
```

### S3 ì €ì¥ êµ¬ì¡°

```
s3://fileflow-storage/
â”œâ”€â”€ originals/
â”‚   â””â”€â”€ {tenant-id}/{file-id}.{ext}
â””â”€â”€ thumbnails/
    â”œâ”€â”€ small/
    â”‚   â””â”€â”€ {tenant-id}/{file-id}.webp
    â””â”€â”€ medium/
        â””â”€â”€ {tenant-id}/{file-id}.webp
```

### 3. OCR (í…ìŠ¤íŠ¸ ì¶”ì¶œ)

### AWS Textract í†µí•©

**API ì‚¬ìš©**:

- **DetectDocumentText**: í…ìŠ¤íŠ¸ ê°ì§€ ë° ì¶”ì¶œ
- **AnalyzeDocument**: ë¬¸ì„œ êµ¬ì¡° ë¶„ì„ (ì„ íƒ)

**ë¹„ìš© ìµœì í™”**:

- ë™ì¼ ì´ë¯¸ì§€ ì¬ì²˜ë¦¬ ë°©ì§€ (ìºì‹±)
- ë°°ì¹˜ ì²˜ë¦¬
- ì‹ ë¢°ë„ 90% ì´ìƒë§Œ ì²˜ë¦¬

**ì²˜ë¦¬ íë¦„**:

```
1. S3ì—ì„œ ì´ë¯¸ì§€ ì°¸ì¡°
2. Textract DetectDocumentText í˜¸ì¶œ
3. í…ìŠ¤íŠ¸ ë¸”ë¡ ì¶”ì¶œ
4. ì‹ ë¢°ë„ í•„í„°ë§ (>= 90%)
5. í…ìŠ¤íŠ¸ ì •ì œ ë° íŒŒì‹±
6. file_metadataì— ì €ì¥
```

### ìƒí’ˆ ì •ë³´ íŒŒì‹±

**íŒŒì‹± ëŒ€ìƒ**:

1. **ì¬ì§ˆ (Material)**
    - íŒ¨í„´: "Cotton 100%", "í´ë¦¬ì—ìŠ¤í…Œë¥´ 80%"
    - ì •ê·œì‹: `/(\w+)\s*(\d+)%/`
2. **ì›ì‚°ì§€ (Origin)**
    - íŒ¨í„´: "Made in Korea", "ì¤‘êµ­ì‚°", "Vietnam"
    - ì •ê·œì‹: `/Made in ([A-Za-zê°€-í£]+)/`
3. **ì„¸íƒë°©ë²• (Washing)**
    - íŒ¨í„´: "ì†ì„¸íƒ", "ë“œë¼ì´í´ë¦¬ë‹", "ë¬¼ì„¸íƒ ê°€ëŠ¥"
    - í‚¤ì›Œë“œ: "ì„¸íƒ", "wash", "clean"
4. **ì‚¬ì´ì¦ˆ (Size)**
    - íŒ¨í„´: "S", "M", "L", "XL", "Free Size"
    - ì •ê·œì‹: `/\b(XS|S|M|L|XL|XXL|Free)\b/i`

**íŒŒì‹± ë¡œì§**:

```java
class ProductInfoParser {
    MaterialPattern materialPattern;
    OriginPattern originPattern;
    WashingPattern washingPattern;
    SizePattern sizePattern;
    
    ProductInformation parse(String extractedText) {
        // íŒ¨í„´ ë§¤ì¹­ ë° íŒŒì‹±
    }
}
```

**ì €ì¥ í˜•ì‹** (file_metadata):

```json
{
  "ocr_extracted_text": "ì›ë³¸ í…ìŠ¤íŠ¸...",
  "product_material": "Cotton 100%",
  "product_origin": "Korea",
  "washing_instruction": "ì†ì„¸íƒ",
  "product_size": "Free Size",
  "ocr_confidence": 0.95
}
```

### 4. CDN ë°°í¬

### CloudFront êµ¬ì„±

**Distribution ì„¤ì •**:

- **Origin**: S3 Bucket
- **Origin Access**: OAC (Origin Access Control)
- **Viewer Protocol**: HTTPS Only
- **Compress**: Gzip, Brotli í™œì„±í™”

**Cache ì •ì±…**:

- **ì´ë¯¸ì§€ íŒŒì¼**: ì¥ê¸° ìºì‹± (1ë…„)
- **Cache-Control**: `public, max-age=31536000, immutable`
- **Query String**: ë¬´ì‹œ

**ì—ì§€ ë¡œì¼€ì´ì…˜**:

- Price Class: All (100+ ì—ì§€ ë¡œì¼€ì´ì…˜)
- ë˜ëŠ” Price Class 100 (ë¹„ìš© ìµœì í™”)

### CDN URL êµ¬ì¡°

```
[https://d123456789.cloudfront.net/originals/{tenant-id}/{file-id}.webp](https://d123456789.cloudfront.net/originals/{tenant-id}/{file-id}.webp)
[https://d123456789.cloudfront.net/thumbnails/small/{tenant-id}/{file-id}.webp](https://d123456789.cloudfront.net/thumbnails/small/{tenant-id}/{file-id}.webp)
[https://d123456789.cloudfront.net/thumbnails/medium/{tenant-id}/{file-id}.webp](https://d123456789.cloudfront.net/thumbnails/medium/{tenant-id}/{file-id}.webp)
```

### ìºì‹œ ë¬´íš¨í™”

**ë¬´íš¨í™” ì‹œë‚˜ë¦¬ì˜¤**:

- íŒŒì¼ ì¬ì—…ë¡œë“œ
- íŒŒì¼ ì‚­ì œ
- ì´ë¯¸ì§€ ì¬ì²˜ë¦¬

**ë¬´íš¨í™” API**:

```
POST /api/v1/cdn/invalidate
Request:
{
  "paths": [
    "/originals/1/file-123.webp",
    "/thumbnails/*/file-123.webp"
  ]
}

Response:
{
  "invalidationId": "I2J3K4L5M6N7O8P9",
  "status": "InProgress",
  "createTime": "2024-12-25T10:00:00Z"
}
```

**ë¹„ìš© ìµœì í™”**:

- ë¬´íš¨í™” ê²½ë¡œ ê·¸ë£¹í•‘
- ì™€ì¼ë“œì¹´ë“œ í™œìš©
- ë¶ˆí•„ìš”í•œ ë¬´íš¨í™” ë°©ì§€

### 5. í›„ì²˜ë¦¬ ì‘ì—… ê´€ë¦¬

### processing_job í…Œì´ë¸”

**ìŠ¤í‚¤ë§ˆ**:

```sql
CREATE TABLE processing_job (
    id BIGINT PRIMARY KEY,
    job_id VARCHAR(36) UNIQUE,
    file_id VARCHAR(36),
    job_type VARCHAR(50),
    job_status VARCHAR(20),
    priority INT DEFAULT 0,
    retry_count INT DEFAULT 0,
    max_retries INT DEFAULT 3,
    error_message TEXT,
    metadata JSON,
    started_at DATETIME,
    completed_at DATETIME,
    created_at DATETIME,
    updated_at DATETIME
);
```

**Job íƒ€ì…**:

- `IMAGE_OPTIMIZATION`: ì´ë¯¸ì§€ ìµœì í™”
- `WEBP_CONVERSION`: WebP ë³€í™˜
- `THUMBNAIL_GENERATION`: ì¸ë„¤ì¼ ìƒì„±
- `OCR_EXTRACTION`: OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ
- `CDN_DEPLOYMENT`: CDN ë°°í¬

**Job ìƒíƒœ**:

```
PENDING â†’ PROCESSING â†’ COMPLETED
                     â†’ FAILED â†’ PENDING (ì¬ì‹œë„)
        â†’ CANCELLED
```

### íŒŒì´í”„ë¼ì¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°

**ì‹¤í–‰ ì „ëµ**:

```java
class ImageProcessingOrchestrator {
    
    void startPipeline(String fileId) {
        // Stage 1: ì´ë¯¸ì§€ ìµœì í™”
        ProcessingJob optimizationJob = createJob(fileId, IMAGE_OPTIMIZATION);
        
        // Stage 2: ì¸ë„¤ì¼ ìƒì„± (ë³‘ë ¬)
        ProcessingJob thumbnailJob = createJob(fileId, THUMBNAIL_GENERATION);
        
        // Stage 3: OCR ì¶”ì¶œ
        ProcessingJob ocrJob = createJob(fileId, OCR_EXTRACTION);
        
        // Stage 4: CDN ë°°í¬
        ProcessingJob cdnJob = createJob(fileId, CDN_DEPLOYMENT);
        
        // ë‹¨ê³„ë³„ ì‹¤í–‰
        executeSequentially(optimizationJob, thumbnailJob, ocrJob, cdnJob);
    }
}
```

**ë³‘ë ¬ ì²˜ë¦¬**:

- ì¸ë„¤ì¼ ìƒì„± (Small, Medium ë™ì‹œ)
- ìµœì í™” ë° OCR (ë…ë¦½ì )

**ì˜ì¡´ì„± ê´€ë¦¬**:

- Stage 2, 3ì€ Stage 1 ì™„ë£Œ í›„
- Stage 4ëŠ” ëª¨ë“  Stage ì™„ë£Œ í›„

---

## ğŸ”§ ê¸°ìˆ  ìŠ¤íƒ

### Backend

- **Language**: Java 17
- **Framework**: Spring Boot 3.x
- **Architecture**: Hexagonal Architecture

### ì´ë¯¸ì§€ ì²˜ë¦¬

- **Thumbnailator**: Java ì´ë¯¸ì§€ ì²˜ë¦¬
- **ImageMagick**: ëŒ€ì•ˆ (ëª…ë ¹ì¤„ ë„êµ¬)
- **Apache Commons Imaging**: ë©”íƒ€ë°ì´í„°
- **Metadata Extractor**: EXIF ë°ì´í„°

### AWS Services

- **S3**: íŒŒì¼ ì €ì¥
- **Textract**: OCR ì„œë¹„ìŠ¤
- **CloudFront**: CDN
- **SQS/SNS**: ë©”ì‹œì§€ í

### Database

- **MySQL 8.0**: ë©”ì¸ DB
- **Redis**: ê²°ê³¼ ìºì‹±

### Libraries

- **AWS SDK for Java v2**: AWS ì„œë¹„ìŠ¤
- **Spring Retry**: ì¬ì‹œë„
- **Resilience4j**: Circuit Breaker

---

## ğŸ“‹ Task ëª©ë¡

### Phase 1: ì´ë¯¸ì§€ ìµœì í™” (16ì‹œê°„)

- [KAN-28](https://ryuqqq.atlassian.net/browse/KAN-28) - ì´ë¯¸ì§€ ìµœì í™” Domain ëª¨ë¸ ì„¤ê³„ - 4h
- [KAN-29](https://ryuqqq.atlassian.net/browse/KAN-29) - WebP ë³€í™˜ ì„œë¹„ìŠ¤ êµ¬í˜„ - 5h
- [KAN-30](https://ryuqqq.atlassian.net/browse/KAN-30) - ì´ë¯¸ì§€ ì••ì¶• ë¡œì§ êµ¬í˜„ (í’ˆì§ˆ 90%) - 4h
- [KAN-31](https://ryuqqq.atlassian.net/browse/KAN-31) - ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì²˜ë¦¬ (EXIF ì œê±°/ìœ ì§€) - 3h

### Phase 2: ì¸ë„¤ì¼ ìƒì„± (13ì‹œê°„)

- [KAN-32](https://ryuqqq.atlassian.net/browse/KAN-32) - ì¸ë„¤ì¼ ìƒì„± ì „ëµ ì„¤ê³„ ë° êµ¬í˜„ - 3h
- [KAN-33](https://ryuqqq.atlassian.net/browse/KAN-33) - ë‹¤ì¤‘ í¬ê¸° ì¸ë„¤ì¼ ìƒì„± (Small: 300x300, Medium: 800x800) - 4h
- [KAN-34](https://ryuqqq.atlassian.net/browse/KAN-34) - ë¦¬ì‚¬ì´ì§• ì•Œê³ ë¦¬ì¦˜ ìµœì í™” - 3h
- [KAN-35](https://ryuqqq.atlassian.net/browse/KAN-35) - ì¸ë„¤ì¼ íŒŒì¼ ê´€ê³„ ì €ì¥ (file_relationship) - 3h

### Phase 3: OCR (18ì‹œê°„)

- [KAN-36](https://ryuqqq.atlassian.net/browse/KAN-36) - AWS Textract í†µí•© ì„¤ì • - 3h
- [KAN-37](https://ryuqqq.atlassian.net/browse/KAN-37) - ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì„œë¹„ìŠ¤ êµ¬í˜„ - 5h
- [KAN-38](https://ryuqqq.atlassian.net/browse/KAN-38) - ìƒí’ˆ ì •ë³´ íŒŒì‹± ë¡œì§ (ì¬ì§ˆ, ì›ì‚°ì§€, ì„¸íƒë°©ë²•, ì‚¬ì´ì¦ˆ) - 6h
- [KAN-39](https://ryuqqq.atlassian.net/browse/KAN-39) - OCR ê²°ê³¼ ì €ì¥ ë° ë©”íƒ€ë°ì´í„° ì—°ë™ - 4h

### Phase 4: CDN ë°°í¬ (10ì‹œê°„)

- [KAN-40](https://ryuqqq.atlassian.net/browse/KAN-40) - CloudFront ë°°í¬ ì„¤ì • (ì¸í”„ë¼) - 4h
- [KAN-41](https://ryuqqq.atlassian.net/browse/KAN-41) - CDN ìë™ ë°°í¬ ë¡œì§ êµ¬í˜„ - 3h
- [KAN-42](https://ryuqqq.atlassian.net/browse/KAN-42) - ìºì‹œ ë¬´íš¨í™” ì„œë¹„ìŠ¤ êµ¬í˜„ - 3h

### Phase 5: íŒŒì´í”„ë¼ì¸ ê´€ë¦¬ (16ì‹œê°„)

- [KAN-43](https://ryuqqq.atlassian.net/browse/KAN-43) - processing_job í…Œì´ë¸” ì„¤ê³„ ë° ìƒì„± - 3h
- [KAN-44](https://ryuqqq.atlassian.net/browse/KAN-44) - íŒŒì´í”„ë¼ì¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ êµ¬í˜„ - 5h
- [KAN-45](https://ryuqqq.atlassian.net/browse/KAN-45) - ì‘ì—… ìƒíƒœ ì¶”ì  ë° ê´€ë¦¬ - 4h
- [KAN-46](https://ryuqqq.atlassian.net/browse/KAN-46) - ì¬ì‹œë„ ë° ì—ëŸ¬ í•¸ë“¤ë§ - 4h

### Phase 6: ë¹„ë™ê¸° ì²˜ë¦¬ ì¸í”„ë¼ (9ì‹œê°„)

- [KAN-47](https://ryuqqq.atlassian.net/browse/KAN-47) - SQS/SNS íŒŒì´í”„ë¼ì¸ ì„¤ì • - 4h
- [KAN-48](https://ryuqqq.atlassian.net/browse/KAN-48) - ë¹„ë™ê¸° ë©”ì‹œì§€ í•¸ë“¤ëŸ¬ êµ¬í˜„ - 5h

### Phase 7: í’ˆì§ˆ ë³´ì¦ (11ì‹œê°„)

- [KAN-49](https://ryuqqq.atlassian.net/browse/KAN-49) - í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„± - 6h
- [KAN-50](https://ryuqqq.atlassian.net/browse/KAN-50) - ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë° ìµœì í™” - 5h

---

## ğŸ“– ì°¸ê³  ë¬¸ì„œ

### AWS ë¬¸ì„œ

- [AWS Textract](https://docs.aws.amazon.com/textract/)
- [CloudFront Developer Guide](https://docs.aws.amazon.com/cloudfront/)
- [SNS/SQS](https://docs.aws.amazon.com/sns/)

### ë¼ì´ë¸ŒëŸ¬ë¦¬

- [Thumbnailator](https://github.com/coobird/thumbnailator)
- [Metadata Extractor](https://github.com/drewnoakes/metadata-extractor)

---

## ğŸ”— ê´€ë ¨ ë§í¬

- **Jira Epic**: [KAN-27](https://ryuqqq.atlassian.net/browse/KAN-27)
- **GitHub**: [FileFlow Repository](https://github.com/ryu-qqq/FileFlow)
- **ìƒìœ„ í”„ë¡œì íŠ¸**: ğŸ—ï¸ Setof ê³ ë„í™” í”„ë¡œì íŠ¸
- **ì´ì „ Epic**: Epic 2: íŒŒì¼ ì—…ë¡œë“œ & ì €ì¥