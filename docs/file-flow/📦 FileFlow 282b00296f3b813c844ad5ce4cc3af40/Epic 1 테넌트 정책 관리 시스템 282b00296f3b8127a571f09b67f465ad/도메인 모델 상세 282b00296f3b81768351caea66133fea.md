# 도메인 모델 상세

## 개요

정책 관리 시스템의 핵심 도메인 모델을 설계합니다. Domain 계층은 **순수한 비즈니스 로직**만 포함하며, 프레임워크 의존성이 없어야 합니다.

---

## 핵심 도메인 모델

### 1. PolicyKey (Value Object)

**목적**: 정책을 고유하게 식별하는 복합 키

**구성 요소**:

- `tenantId`: 테넌트 식별자 (b2c, b2b)
- `userType`: 사용자 유형 (CONSUMER, SELLER, CRAWLER, BUYER)
- `serviceType`: 서비스 유형 (REVIEW, PRODUCT, ORDER_SHEET)

**생성 규칙**:

```java
PolicyKey.of("b2c", "SELLER", "PRODUCT")
→ "b2c:SELLER:PRODUCT"
```

**불변성 보장**:

- 생성 후 변경 불가
- equals/hashCode 구현
- Value Object 패턴

---

### 2. UploadPolicy (Aggregate Root)

**목적**: 파일 업로드 정책 관리

**주요 속성**:

- `policyKey`: PolicyKey (식별자)
- `fileTypePolicies`: 파일 타입별 정책 (VO)
- `rateLimiting`: Rate Limiting 정책 (VO)
- `version`: 정책 버전
- `isActive`: 활성 상태
- `effectiveFrom/Until`: 유효 기간

**비즈니스 규칙**:

1. 정책 업데이트 시 버전 자동 증가
2. 활성화된 정책만 적용 가능
3. 유효 기간 검증
4. 파일 타입별 정책 필수 검증

**주요 메서드**:

```java
// 정책 검증
void validateFile(FileType fileType, long fileSizeBytes, int fileCount)

// 정책 업데이트 (새 버전 생성)
UploadPolicy updatePolicy(FileTypePolicies newPolicies, String changedBy)

// 정책 활성화
UploadPolicy activate()

// 정책 비활성화
UploadPolicy deactivate()
```

---

### 3. FileTypePolicies (Value Object)

**목적**: 파일 타입별 상세 정책 그룹화

**구성 요소**:

- `imagePolicy`: ImagePolicy (nullable)
- `htmlPolicy`: HtmlPolicy (nullable)
- `excelPolicy`: ExcelPolicy (nullable)
- `pdfPolicy`: PdfPolicy (nullable)

**검증 규칙**:

- 최소 1개 이상의 정책 필수
- 각 정책은 독립적으로 검증

---

### 4. ImagePolicy (Value Object)

**속성**:

- `maxFileSizeMB`: 최대 파일 크기 (MB)
- `maxFileCount`: 최대 파일 개수
- `allowedFormats`: 허용 포맷 리스트
- `maxDimension`: 최대 이미지 크기 (Dimension VO)

**기본값**:

```java
maxFileSizeMB: 10
maxFileCount: 5
allowedFormats: ["jpg", "jpeg", "png"]
maxDimension: Dimension(4096, 4096)
```

**검증 로직**:

```java
void validate(String format, long sizeBytes, Dimension dimension)
```

---

### 5. HtmlPolicy (Value Object)

**속성**:

- `maxFileSizeMB`: 최대 HTML 파일 크기
- `maxImageCount`: HTML 내 최대 이미지 개수
- `downloadExternalImages`: 외부 이미지 다운로드 허용 여부

**사용 사례**:

- 상품 상세 설명 HTML 업로드
- 크롤러가 외부 이미지 포함된 HTML 업로드

---

### 6. ExcelPolicy (Value Object)

**속성**:

- `maxFileSizeMB`: 최대 파일 크기
- `maxSheetCount`: 최대 시트 개수

**사용 사례**:

- 바이어 라인시트 업로드

---

### 7. PdfPolicy (Value Object)

**속성**:

- `maxFileSizeMB`: 최대 파일 크기
- `maxPageCount`: 최대 페이지 수

---

### 8. RateLimiting (Value Object)

**속성**:

- `requestsPerHour`: 시간당 요청 제한
- `uploadsPerDay`: 일일 업로드 제한

**검증 로직**:

```java
boolean isAllowed(int currentRequestCount, int currentUploadCount)
```

---

### 9. Dimension (Value Object)

**속성**:

- `width`: 너비 (픽셀)
- `height`: 높이 (픽셀)

**검증**:

```java
boolean isWithin(Dimension maxDimension)
```

---

## 도메인 이벤트

### PolicyUpdatedEvent

**발행 시점**: 정책이 업데이트될 때

**페이로드**:

- `policyKey`: PolicyKey
- `oldVersion`: 이전 버전
- `newVersion`: 새 버전
- `changedBy`: 변경자
- `changedAt`: 변경 시각

**사용 목적**:

- 정책 변경 이력 기록
- 캐시 무효화
- 알림 발송

---

### PolicyActivatedEvent

**발행 시점**: 정책이 활성화될 때

**페이로드**:

- `policyKey`: PolicyKey
- `version`: 버전
- `activatedBy`: 활성화자

---

## 도메인 예외

### PolicyNotFoundException

**발생 조건**: 요청한 정책을 찾을 수 없을 때

### PolicyViolationException

**발생 조건**: 업로드 파일이 정책을 위반했을 때

- 파일 크기 초과
- 파일 개수 초과
- 허용되지 않는 포맷
- 이미지 크기 초과

### InvalidPolicyException

**발생 조건**: 유효하지 않은 정책 데이터

---

## 클래스 다이어그램

```
┌─────────────────────────────────────────┐
│         UploadPolicy (AR)               │
├─────────────────────────────────────────┤
│ - policyKey: PolicyKey                  │
│ - fileTypePolicies: FileTypePolicies    │
│ - rateLimiting: RateLimiting            │
│ - version: int                          │
│ - isActive: boolean                     │
├─────────────────────────────────────────┤
│ + validateFile()                        │
│ + updatePolicy()                        │
│ + activate()                            │
└─────────────────────────────────────────┘
           │
           │ contains
           ▼
┌─────────────────────────────────────────┐
│      FileTypePolicies (VO)              │
├─────────────────────────────────────────┤
│ - imagePolicy: ImagePolicy              │
│ - htmlPolicy: HtmlPolicy                │
│ - excelPolicy: ExcelPolicy              │
│ - pdfPolicy: PdfPolicy                  │
└─────────────────────────────────────────┘
           │
           ├─────────┬─────────┬─────────┐
           ▼         ▼         ▼         ▼
    ImagePolicy HtmlPolicy ExcelPolicy PdfPolicy
```

---

## 구현 가이드라인

### ✅ 준수 사항

1. **NO Lombok**
    - 모든 생성자, getter 직접 구현
    - Builder 패턴 직접 구현 (필요 시)
2. **Immutability**
    - 모든 Value Object는 불변
    - final 필드 사용
    - defensive copy
3. **Self-Validation**
    - 생성자에서 유효성 검증
    - 유효하지 않은 상태로 생성 불가
4. **Rich Domain Model**
    - Anemic Domain Model 지양
    - 비즈니스 로직을 도메인 객체에 위치
5. **No Framework Dependency**
    - Spring, JPA 의존성 없음
    - 순수 Java만 사용

---

## 테스트 전략

### Unit Test

- 각 도메인 객체별 독립 테스트
- 비즈니스 규칙 검증
- 예외 케이스 테스트
- 목표 커버리지: **90% 이상**

### 테스트 예시

```java
@Test
void 파일_크기_초과_시_예외_발생() {
    // given
    ImagePolicy policy = new ImagePolicy(10, 5, formats, dimension);
    
    // when & then
    assertThrows(PolicyViolationException.class, () -> {
        policy.validate("jpg", 11 * 1024 * 1024, dimension);
    });
}
```

---

## 관련 Task

- **Task 1.1**: Domain 모델 설계 및 구현 (12시간)
    - PolicyKey 구현
    - UploadPolicy Aggregate 구현
    - Value Object 9개 구현
    - 도메인 예외 정의
    - 도메인 이벤트 정의
    - 단위 테스트 작성