# FILE-006-003: Persistence Layer êµ¬í˜„

**Epic**: File Upload Presigned URL System
**Layer**: Persistence Layer
**ë¸Œëœì¹˜**: feature/FILE-006-003-persistence
**Jira URL**: (sync-to-jira í›„ ì¶”ê°€)

---

## ğŸ“ ëª©ì 

íŒŒì¼ ë©”íƒ€ë°ì´í„° ì˜ì†í™” ë° Redis ì„¸ì…˜ ì €ì¥ì†Œ êµ¬í˜„

**í•µì‹¬ ì—­í• **:
- MySQL: File ë©”íƒ€ë°ì´í„° ì €ì¥ (Optimistic Lock)
- Redis: UploadSession ì„ì‹œ ì €ì¥ (TTL 15ë¶„)
- Port êµ¬í˜„ (Adapter)
- Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. MySQL (File ë©”íƒ€ë°ì´í„°)

#### FileJpaEntity

**í…Œì´ë¸”**: `files`

**í•„ë“œ**:
- [ ] `id`: Long (PK, Auto Increment)
- [ ] `fileId`: String (UUID, Unique, Not Null, Index)
- [ ] `userId`: Long (FK, Not Null, Index)
- [ ] `tenantId`: Long (Not Null, Index)
- [ ] `role`: String (Not Null)
- [ ] `fileName`: String (Not Null)
- [ ] `fileSize`: Long (Not Null)
- [ ] `mimeType`: String (Not Null)
- [ ] `s3Path`: String (Not Null, Index)
- [ ] `uploadType`: String (Not Null)
- [ ] `uploadedAt`: LocalDateTime (Not Null, Index)
- [ ] `deleted`: Boolean (Not Null, Default: false, Index)
- [ ] `deletedAt`: LocalDateTime (Nullable)
- [ ] `version`: Long (Optimistic Lock, Not Null, Default: 0)

**ì¸ë±ìŠ¤**:
- [ ] `idx_file_id` (file_id) - UNIQUE, íŒŒì¼ ì¡°íšŒ
- [ ] `idx_user_uploaded` (user_id, uploaded_at DESC, deleted) - ì‚¬ìš©ìë³„ íŒŒì¼ ëª©ë¡
- [ ] `idx_s3_path` (s3_path, deleted) - S3 ê²½ë¡œ ì¡°íšŒ

**ì œì•½ì‚¬í•­**:
- [ ] `file_id` UNIQUE
- [ ] `file_size` > 0
- [ ] `version` >= 0

#### FileJpaRepository

**âš ï¸ Query Method ê¸ˆì§€** (jpa-repository-guide.md ì¤€ìˆ˜):
- `findBy*`, `existsBy*` ë“± ìë™ ìƒì„± ë©”ì„œë“œ ì‚¬ìš© ê¸ˆì§€
- ë³µì¡í•œ ì¡°íšŒëŠ” **QueryDSL Repositoryë¡œ ìœ„ì„** í•„ìˆ˜

**ì¸í„°í˜ì´ìŠ¤**:
```java
public interface FileJpaRepository extends JpaRepository<FileJpaEntity, Long> {
    // í•„ìˆ˜ ë©”ì„œë“œë§Œ ìƒì† (save, findById, delete, count)
    // ë³µì¡í•œ ì¡°íšŒ â†’ FileQueryDslRepositoryë¡œ ìœ„ì„
}
```

**í—ˆìš© ë©”ì„œë“œ**:
- [ ] `save(FileJpaEntity)`: íŒŒì¼ ì €ì¥/ì—…ë°ì´íŠ¸
- [ ] `findById(Long)`: PK ì¡°íšŒ
- [ ] `delete(FileJpaEntity)`: ë¬¼ë¦¬ ì‚­ì œ (ì‹¤ì œë¡œëŠ” ì‚¬ìš© ì•ˆ í•¨)
- [ ] `count()`: ì „ì²´ ê°œìˆ˜

#### FileQueryDslRepository

**âš ï¸ QueryDSL í‘œì¤€ ë©”ì„œë“œ í•„ìˆ˜** (querydsl-repository-guide.md ì¤€ìˆ˜):
- `findById`, `findAll`, `countBy`, `existsBy` 4ê°œ ë©”ì„œë“œ í•„ìˆ˜
- **DTO Projection í•„ìˆ˜**: Entity ì§ì ‘ ë°˜í™˜ ê¸ˆì§€
- **N+1 ë°©ì§€**: ì¡°ì¸ ì‹œ fetchJoin ì‚¬ìš©

**ì¸í„°í˜ì´ìŠ¤**:
```java
public interface FileQueryDslRepository {
    // 1. í•„ìˆ˜ ë©”ì„œë“œ - ë‹¨ê±´ ì¡°íšŒ
    Optional<File> findById(String fileId);

    // 2. í•„ìˆ˜ ë©”ì„œë“œ - ëª©ë¡ ì¡°íšŒ
    List<File> findAllByUserId(Long userId, Pageable pageable);

    // 3. í•„ìˆ˜ ë©”ì„œë“œ - ê°œìˆ˜
    Long countByUserId(Long userId);

    // 4. í•„ìˆ˜ ë©”ì„œë“œ - ì¡´ì¬ ì—¬ë¶€
    Boolean existsByFileId(String fileId);
}
```

**ë©”ì„œë“œ êµ¬í˜„**:

**1. findById** (fileIdë¡œ ë‹¨ê±´ ì¡°íšŒ):
```java
@Override
public Optional<File> findById(String fileId) {
    FileJpaEntity entity = queryFactory
        .selectFrom(QFileJpaEntity.fileJpaEntity)
        .where(
            QFileJpaEntity.fileJpaEntity.fileId.eq(fileId),
            QFileJpaEntity.fileJpaEntity.deleted.eq(false)
        )
        .fetchOne();

    return Optional.ofNullable(entity)
        .map(FileMapper::toDomain);
}
```

**2. findAllByUserId** (ì‚¬ìš©ìë³„ ëª©ë¡ ì¡°íšŒ + Pagination):
```java
@Override
public List<File> findAllByUserId(Long userId, Pageable pageable) {
    return queryFactory
        .selectFrom(QFileJpaEntity.fileJpaEntity)
        .where(
            QFileJpaEntity.fileJpaEntity.userId.eq(userId),
            QFileJpaEntity.fileJpaEntity.deleted.eq(false)
        )
        .orderBy(QFileJpaEntity.fileJpaEntity.uploadedAt.desc())
        .offset(pageable.getOffset())
        .limit(pageable.getPageSize())
        .fetch()
        .stream()
        .map(FileMapper::toDomain)
        .toList();
}
```

**3. countByUserId** (ì‚¬ìš©ìë³„ íŒŒì¼ ê°œìˆ˜):
```java
@Override
public Long countByUserId(Long userId) {
    return queryFactory
        .select(QFileJpaEntity.fileJpaEntity.count())
        .from(QFileJpaEntity.fileJpaEntity)
        .where(
            QFileJpaEntity.fileJpaEntity.userId.eq(userId),
            QFileJpaEntity.fileJpaEntity.deleted.eq(false)
        )
        .fetchOne();
}
```

**4. existsByFileId** (íŒŒì¼ ì¡´ì¬ ì—¬ë¶€):
```java
@Override
public Boolean existsByFileId(String fileId) {
    Integer fetchOne = queryFactory
        .selectOne()
        .from(QFileJpaEntity.fileJpaEntity)
        .where(
            QFileJpaEntity.fileJpaEntity.fileId.eq(fileId),
            QFileJpaEntity.fileJpaEntity.deleted.eq(false)
        )
        .fetchFirst();

    return fetchOne != null;
}
```

#### FileMapper

**ì¸í„°í˜ì´ìŠ¤**:
```java
public interface FileMapper {
    static FileJpaEntity toEntity(File file);
    static File toDomain(FileJpaEntity entity);
}
```

**ë©”ì„œë“œ**:
- [ ] `toEntity`: Domain â†’ Entity ë³€í™˜ (VO â†’ ì›ì‹œ íƒ€ì…)
- [ ] `toDomain`: Entity â†’ Domain ë³€í™˜ (ì›ì‹œ íƒ€ì… â†’ VO)

**êµ¬í˜„ ì˜ˆì‹œ**:
```java
/**
 * File Mapper (Domain â†” JPA Entity ë³€í™˜)
 *
 * <p>Law of Demeter ì¤€ìˆ˜: getXxxValue() ë©”ì„œë“œ ì‚¬ìš©
 * <p>ì˜ì†ì„± ë³µì›: File.reconstitute() ì‚¬ìš© (ê²€ì¦ ë¡œì§ ì‹¤í–‰ ì•ˆ í•¨)
 */
public class FileMapper {
    /**
     * Domain â†’ Entity ë³€í™˜
     *
     * <p>Law of Demeter ì¤€ìˆ˜:
     * - file.getFileIdValue() (O)
     * - file.getFileId().value() (X)
     *
     * @param file File Aggregate Root
     * @return FileJpaEntity
     */
    public static FileJpaEntity toEntity(File file) {
        FileJpaEntity entity = new FileJpaEntity();
        entity.setFileId(file.getFileIdValue());              // Law of Demeter
        entity.setUserId(file.getUserId());
        entity.setTenantId(file.getTenantId());
        entity.setRole(file.getRole().name());
        entity.setFileName(file.getFileNameValue());          // Law of Demeter
        entity.setFileSize(file.getFileSizeBytes());          // Law of Demeter
        entity.setMimeType(file.getMimeTypeValue());          // Law of Demeter
        entity.setS3Path(file.getS3PathValue());              // Law of Demeter
        entity.setUploadType(file.getUploadType().name());
        entity.setUploadedAt(file.getUploadedAt());
        entity.setUpdatedAt(file.getUpdatedAt());             // ì¶”ê°€ í•„ìˆ˜
        entity.setDeleted(file.isDeleted());                  // Tell Don't Ask
        entity.setDeletedAt(file.getDeletedAt());
        entity.setVersion(file.getVersion());                 // Optimistic Lock
        return entity;
    }

    /**
     * Entity â†’ Domain ë³€í™˜ (ì˜ì†ì„± ë³µì›)
     *
     * <p>File.reconstitute() ì‚¬ìš©:
     * - ê²€ì¦ ë¡œì§ ì‹¤í–‰ ì•ˆ í•¨
     * - ëª¨ë“  í•„ë“œ ê·¸ëŒ€ë¡œ ì „ë‹¬
     * - Clockì€ SystemDefaultZone ì‚¬ìš©
     *
     * @param entity FileJpaEntity
     * @return File Aggregate Root
     */
    public static File toDomain(FileJpaEntity entity) {
        return File.reconstitute(
            SessionId.from(entity.getFileId()),                   // String â†’ SessionId
            entity.getUserId(),
            entity.getTenantId(),
            UserRole.valueOf(entity.getRole()),
            FileName.from(entity.getFileName()),                  // String â†’ FileName
            FileSize.of(entity.getFileSize()),                    // Long â†’ FileSize
            MimeType.of(entity.getMimeType()),                    // String â†’ MimeType
            S3Path.from(                                          // String â†’ S3Path
                UserRole.valueOf(entity.getRole()),
                entity.getTenantId(),
                extractSellerName(entity),
                extractCustomPath(entity.getS3Path()),
                entity.getFileId(),
                entity.getMimeType()
            ),
            UploadType.valueOf(entity.getUploadType()),
            Clock.systemDefaultZone(),                            // Clock ì£¼ì…
            entity.getUploadedAt(),
            entity.getUpdatedAt(),
            entity.getDeleted(),
            entity.getDeletedAt(),
            entity.getVersion()                                   // Optimistic Lock
        );
    }

    /**
     * S3Pathì—ì„œ sellerName ì¶”ì¶œ
     */
    private static String extractSellerName(FileJpaEntity entity) {
        UserRole role = UserRole.valueOf(entity.getRole());
        if (role == UserRole.SELLER) {
            // S3Path: {tenantId}/setof/{sellerName}/{customPath}/{fileId}.{ext}
            String[] parts = entity.getS3Path().split("/");
            return parts.length > 2 ? parts[2] : null;
        }
        return null;
    }

    /**
     * S3Pathì—ì„œ customPath ì¶”ì¶œ
     */
    private static String extractCustomPath(String s3Path) {
        // S3Path: {tenantId}/{namespace}/{sellerName}/{customPath}/{fileId}.{ext}
        String[] parts = s3Path.split("/");
        if (parts.length > 3) {
            // customPathëŠ” ë§ˆì§€ë§‰ì—ì„œ 2ë²ˆì§¸ ë¶€ë¶„
            return parts[parts.length - 2];
        }
        return "";
    }
}
```

### 2. Redis (UploadSession ì €ì¥ì†Œ)

#### RedisUploadSession (DTO)

**í•„ë“œ**:
```java
public record RedisUploadSession(
    String sessionId,
    Long userId,
    Long tenantId,
    String role,
    String sellerName,
    String uploadType,
    String customPath,
    String fileName,
    Long fileSize,
    String mimeType,
    String status,
    String fileId,
    String s3Path,
    String uploadId,  // MULTIPARTì¸ ê²½ìš° S3 uploadId
    LocalDateTime createdAt,
    LocalDateTime expiresAt
) {}
```

**Redis Key**: `upload:session:{sessionId}`
**TTL**: 15ë¶„
**Value**: JSON

#### RedisUploadSessionRepository

**ì¸í„°í˜ì´ìŠ¤**:
```java
public interface RedisUploadSessionRepository {
    void save(RedisUploadSession session, Duration ttl);
    Optional<RedisUploadSession> findById(String sessionId);
    void deleteById(String sessionId);
}
```

**êµ¬í˜„**:
- [ ] Spring Data Redis (`RedisTemplate`)
- [ ] JSON Serialization (Jackson)

**ë©”ì„œë“œ êµ¬í˜„**:
```java
@Repository
public class RedisUploadSessionRepositoryImpl implements RedisUploadSessionRepository {
    private static final String KEY_PREFIX = "upload:session:";
    private final RedisTemplate<String, String> redisTemplate;

    @Override
    public void save(RedisUploadSession session, Duration ttl) {
        String key = KEY_PREFIX + session.sessionId();
        String json = objectMapper.writeValueAsString(session);
        redisTemplate.opsForValue().set(key, json, ttl);
    }

    @Override
    public Optional<RedisUploadSession> findById(String sessionId) {
        String key = KEY_PREFIX + sessionId;
        String json = redisTemplate.opsForValue().get(key);
        if (json == null) return Optional.empty();
        return Optional.of(objectMapper.readValue(json, RedisUploadSession.class));
    }

    @Override
    public void deleteById(String sessionId) {
        String key = KEY_PREFIX + sessionId;
        redisTemplate.delete(key);
    }
}
```

#### RedisSessionMapper

**ì¸í„°í˜ì´ìŠ¤**:
```java
public interface RedisSessionMapper {
    static RedisUploadSession toRedis(UploadSession session);
    static UploadSession toDomain(RedisUploadSession redis);
}
```

**ë©”ì„œë“œ**:
- [ ] `toRedis`: Domain â†’ Redis DTO ë³€í™˜ (VO â†’ ì›ì‹œ íƒ€ì…)
- [ ] `toDomain`: Redis DTO â†’ Domain ë³€í™˜ (ì›ì‹œ íƒ€ì… â†’ VO)

**êµ¬í˜„ ì˜ˆì‹œ**:
```java
public class RedisSessionMapper {
    public static RedisUploadSession toRedis(UploadSession session) {
        return new RedisUploadSession(
            session.getSessionId().value(),            // SessionId â†’ String
            session.getUserId(),
            session.getTenantId(),
            session.getRole().name(),
            session.getSellerName(),
            session.getUploadType().name(),
            session.getCustomPath(),
            session.getFileName().value(),             // FileName â†’ String
            session.getFileSize().bytes(),             // FileSize â†’ Long
            session.getMimeType().value(),             // MimeType â†’ String
            session.getStatus().name(),
            session.getFileId(),
            session.getS3Path().getFullPath(),         // S3Path â†’ String
            session.getUploadId(),
            session.getCreatedAt(),
            session.getExpiresAt()
        );
    }

    public static UploadSession toDomain(RedisUploadSession redis) {
        return UploadSession.restore(
            SessionId.from(redis.sessionId()),         // String â†’ SessionId
            redis.userId(),
            redis.tenantId(),
            UserRole.valueOf(redis.role()),
            redis.sellerName(),
            UploadType.valueOf(redis.uploadType()),
            redis.customPath(),
            FileName.from(redis.fileName()),           // String â†’ FileName
            FileSize.of(redis.fileSize()),             // Long â†’ FileSize
            MimeType.of(redis.mimeType()),             // String â†’ MimeType
            SessionStatus.valueOf(redis.status()),
            redis.fileId(),
            S3Path.from(redis.s3Path()),               // String â†’ S3Path
            redis.uploadId(),
            redis.createdAt(),
            redis.expiresAt()
        );
    }
}
```

### 3. Adapter êµ¬í˜„ (Port êµ¬í˜„ì²´)

#### FileCommandAdapter (SaveFilePort)

**êµ¬í˜„**:
```java
@Component
public class FileCommandAdapter implements SaveFilePort {
    private final FileJpaRepository repository;

    @Override
    public File save(File file) {
        FileJpaEntity entity = FileMapper.toEntity(file);
        FileJpaEntity saved = repository.save(entity);
        return FileMapper.toDomain(saved);
    }
}
```

**í…ŒìŠ¤íŠ¸**:
- [ ] Optimistic Lock ì¶©ëŒ ì‹œë‚˜ë¦¬ì˜¤
- [ ] ì¤‘ë³µ `fileId` ì €ì¥ ì‹œ ì˜ˆì™¸

#### FileQueryAdapter (LoadFilePort)

**êµ¬í˜„**:
```java
@Component
public class FileQueryAdapter implements LoadFilePort {
    private final FileJpaRepository jpaRepository;
    private final FileQueryDslRepository queryDslRepository;

    @Override
    public Optional<File> findByIdAndNotDeleted(String fileId) {
        return jpaRepository.findByFileIdAndDeletedFalse(fileId)
            .map(FileMapper::toDomain);
    }

    @Override
    public List<File> findByUserId(Long userId, Pageable pageable) {
        return queryDslRepository.findByUserIdWithPagination(userId, pageable);
    }
}
```

#### UploadSessionRedisAdapter (Session Port)

**êµ¬í˜„**:
```java
@Component
public class UploadSessionRedisAdapter implements
    LoadUploadSessionPort,
    SaveUploadSessionPort,
    DeleteUploadSessionPort {

    private final RedisUploadSessionRepository repository;

    @Override
    public Optional<UploadSession> findById(String sessionId) {
        return repository.findById(sessionId)
            .map(RedisSessionMapper::toDomain);
    }

    @Override
    public void save(UploadSession session, Duration ttl) {
        RedisUploadSession redis = RedisSessionMapper.toRedis(session);
        repository.save(redis, ttl);
    }

    @Override
    public void delete(String sessionId) {
        repository.deleteById(sessionId);
    }
}
```

### 4. Configuration

#### RedisConfig

**ì„¤ì •**:
```java
@Configuration
@EnableRedisRepositories
public class RedisConfig {
    @Bean
    public RedisTemplate<String, String> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, String> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new StringRedisSerializer());
        return template;
    }

    @Bean
    public RedisMessageListenerContainer redisMessageListenerContainer(
        RedisConnectionFactory connectionFactory) {
        RedisMessageListenerContainer container = new RedisMessageListenerContainer();
        container.setConnectionFactory(connectionFactory);
        return container;
    }
}
```

**Keyspace Notification ì„¤ì •**:
```yaml
spring:
  redis:
    host: localhost
    port: 6379
    password: ${REDIS_PASSWORD:}
```

**Redis ì„¤ì •** (`redis.conf`):
```
notify-keyspace-events Ex
```

### 5. Flyway ë§ˆì´ê·¸ë ˆì´ì…˜

#### V1__create_files_table.sql

```sql
CREATE TABLE files (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    file_id VARCHAR(36) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL,
    tenant_id BIGINT NOT NULL,
    role VARCHAR(20) NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_size BIGINT NOT NULL CHECK (file_size > 0),
    mime_type VARCHAR(100) NOT NULL,
    s3_path VARCHAR(500) NOT NULL,
    upload_type VARCHAR(20) NOT NULL,
    uploaded_at DATETIME(6) NOT NULL,
    deleted BOOLEAN NOT NULL DEFAULT FALSE,
    deleted_at DATETIME(6) NULL,
    version BIGINT NOT NULL DEFAULT 0,

    INDEX idx_file_id (file_id),
    INDEX idx_user_uploaded (user_id, uploaded_at DESC, deleted),
    INDEX idx_s3_path (s3_path, deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™

- [ ] **Long FK ì „ëµ**: JPA ê´€ê³„ ì–´ë…¸í…Œì´ì…˜ ê¸ˆì§€
  - `private Long userId` (O)
  - `@ManyToOne private User user` (X)
- [ ] **Optimistic Lock**: `@Version` ì‚¬ìš© í•„ìˆ˜
  - ë™ì‹œ ì™„ë£Œ ì²˜ë¦¬ ë°©ì§€
- [ ] **QueryDSL ìµœì í™”**: DTO Projection ì‚¬ìš©
  - N+1 ë°©ì§€
- [ ] **Lombok ê¸ˆì§€**: Plain Java ë˜ëŠ” Record
  - Entity: Plain Java
  - DTO: Record

### í…ŒìŠ¤íŠ¸ ê·œì¹™

- [ ] **ArchUnit í…ŒìŠ¤íŠ¸ í•„ìˆ˜**:
  - Persistence LayerëŠ” Domain, Applicationì—ë§Œ ì˜ì¡´
  - Long FK ì „ëµ ì¤€ìˆ˜ ê²€ì¦
  - Lombok ì‚¬ìš© ê¸ˆì§€ ê²€ì¦
- [ ] **Integration Test**:
  - TestContainers MySQL ì‚¬ìš©
  - Embedded Redis ì‚¬ìš©
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ > 80%**:
  - Adapter ë©”ì„œë“œ 100% ì»¤ë²„ë¦¬ì§€

---

## âœ… ì™„ë£Œ ì¡°ê±´

### êµ¬í˜„ ì™„ë£Œ
- [ ] FileJpaEntity êµ¬í˜„
- [ ] FileJpaRepository êµ¬í˜„
- [ ] FileQueryDslRepository êµ¬í˜„
- [ ] FileMapper êµ¬í˜„
- [ ] RedisUploadSession DTO êµ¬í˜„
- [ ] RedisUploadSessionRepository êµ¬í˜„
- [ ] RedisSessionMapper êµ¬í˜„
- [ ] FileCommandAdapter êµ¬í˜„
- [ ] FileQueryAdapter êµ¬í˜„
- [ ] UploadSessionRedisAdapter êµ¬í˜„
- [ ] RedisConfig êµ¬í˜„
- [ ] Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸

### í…ŒìŠ¤íŠ¸ ì™„ë£Œ
- [ ] FileJpaRepository Test (5+ í…ŒìŠ¤íŠ¸)
  - CRUD í…ŒìŠ¤íŠ¸ (TestContainers)
  - Unique Constraint í…ŒìŠ¤íŠ¸
  - Index ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
- [ ] FileQueryDslRepository Test (3+ í…ŒìŠ¤íŠ¸)
  - Pagination í…ŒìŠ¤íŠ¸
  - DTO Projection í…ŒìŠ¤íŠ¸
- [ ] RedisUploadSessionRepository Test (5+ í…ŒìŠ¤íŠ¸)
  - Save/Find/Delete (Embedded Redis)
  - TTL í…ŒìŠ¤íŠ¸
  - Keyspace Notification í…ŒìŠ¤íŠ¸
- [ ] FileCommandAdapter Test (3+ í…ŒìŠ¤íŠ¸)
  - Optimistic Lock ì¶©ëŒ
  - ì¤‘ë³µ fileId
- [ ] FileQueryAdapter Test (3+ í…ŒìŠ¤íŠ¸)
- [ ] UploadSessionRedisAdapter Test (3+ í…ŒìŠ¤íŠ¸)
- [ ] ArchUnit Test (3+ ê·œì¹™)

### í’ˆì§ˆ ê²€ì¦
- [ ] ëª¨ë“  Integration Test í†µê³¼
- [ ] ëª¨ë“  ArchUnit Test í†µê³¼
- [ ] í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ > 80%
- [ ] Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸

---

## ğŸ“‚ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
persistence-mysql/src/main/java/com/fileflow/persistence/mysql/
â”œâ”€â”€ file/
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â””â”€â”€ FileJpaEntity.java
â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”œâ”€â”€ FileJpaRepository.java
â”‚   â”‚   â””â”€â”€ FileQueryDslRepositoryImpl.java
â”‚   â”œâ”€â”€ mapper/
â”‚   â”‚   â””â”€â”€ FileMapper.java
â”‚   â””â”€â”€ adapter/
â”‚       â”œâ”€â”€ FileCommandAdapter.java
â”‚       â””â”€â”€ FileQueryAdapter.java
â””â”€â”€ config/
    â””â”€â”€ JpaConfig.java

persistence-redis/src/main/java/com/fileflow/persistence/redis/
â”œâ”€â”€ session/
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â””â”€â”€ RedisUploadSession.java
â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â””â”€â”€ RedisUploadSessionRepositoryImpl.java
â”‚   â”œâ”€â”€ mapper/
â”‚   â”‚   â””â”€â”€ RedisSessionMapper.java
â”‚   â””â”€â”€ adapter/
â”‚       â””â”€â”€ UploadSessionRedisAdapter.java
â”œâ”€â”€ listener/
â”‚   â””â”€â”€ RedisKeyspaceEventListener.java
â””â”€â”€ config/
    â””â”€â”€ RedisConfig.java

persistence-mysql/src/main/resources/db/migration/
â””â”€â”€ V1__create_files_table.sql

persistence-mysql/src/test/java/com/fileflow/persistence/mysql/
â”œâ”€â”€ file/
â”‚   â”œâ”€â”€ FileJpaRepositoryTest.java
â”‚   â”œâ”€â”€ FileQueryDslRepositoryTest.java
â”‚   â”œâ”€â”€ FileCommandAdapterTest.java
â”‚   â””â”€â”€ FileQueryAdapterTest.java
â””â”€â”€ architecture/
    â””â”€â”€ PersistenceLayerArchitectureTest.java

persistence-redis/src/test/java/com/fileflow/persistence/redis/
â”œâ”€â”€ session/
â”‚   â”œâ”€â”€ RedisUploadSessionRepositoryTest.java
â”‚   â””â”€â”€ UploadSessionRedisAdapterTest.java
â””â”€â”€ config/
    â””â”€â”€ RedisConfigTest.java
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: `/Users/sangwon-ryu/fileflow/docs/prd/presigned-url-upload.md`
- **Plan**: `docs/prd/plans/FILE-006-003-persistence-plan.md` (create-plan í›„ ìƒì„±)
- **Jira**: (sync-to-jira í›„ ì¶”ê°€)
- **Persistence Layer ê·œì¹™**: `docs/coding_convention/04-persistence-layer/`

---

## ğŸ“ ì°¸ê³ ì‚¬í•­

### TDD ì§„í–‰ ìˆœì„œ (ê¶Œì¥)

1. **Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ë¨¼ì €**:
   - `V1__create_files_table.sql`
2. **Entity ë° Mapper**:
   - FileJpaEntity, FileMapper
3. **Repository**:
   - FileJpaRepository â†’ FileQueryDslRepository
4. **Redis**:
   - RedisUploadSession, RedisSessionMapper, RedisUploadSessionRepository
5. **Adapter**:
   - FileCommandAdapter, FileQueryAdapter, UploadSessionRedisAdapter

### Optimistic Lock í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ

```java
@Test
void shouldThrowOptimisticLockException_whenConcurrentUpdate() {
    // Given
    File file = fileRepository.save(FileFixture.create());

    // When: ë‘ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ìˆ˜ì •
    ExecutorService executor = Executors.newFixedThreadPool(2);
    executor.submit(() -> {
        File loaded = fileRepository.findById(file.getFileId()).orElseThrow();
        loaded.delete();
        fileRepository.save(loaded);  // version 1
    });
    executor.submit(() -> {
        File loaded = fileRepository.findById(file.getFileId()).orElseThrow();
        loaded.delete();
        fileRepository.save(loaded);  // version 1 (ì¶©ëŒ!)
    });

    // Then: OptimisticLockException ë°œìƒ
}
```

### Redis Keyspace Notification í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ

```java
@Test
void shouldReceiveExpiredEvent_whenSessionExpires() throws InterruptedException {
    // Given
    RedisUploadSession session = RedisUploadSessionFixture.create();
    CountDownLatch latch = new CountDownLatch(1);

    redisMessageListenerContainer.addMessageListener(
        (message, pattern) -> latch.countDown(),
        new PatternTopic("__keyevent@0__:expired")
    );

    // When
    repository.save(session, Duration.ofSeconds(1));
    Thread.sleep(2000);  // TTL ë§Œë£Œ ëŒ€ê¸°

    // Then
    assertThat(latch.await(5, TimeUnit.SECONDS)).isTrue();
}
```

---

**ë‹¤ìŒ ë‹¨ê³„**:
1. `/create-plan FILE-006-003` - TDD Plan ìƒì„±
2. `/kb/persistence/go` - TDD ì‚¬ì´í´ ì‹œì‘
3. êµ¬í˜„ ì™„ë£Œ í›„ FILE-006-004 (REST API Layer) ì‹œì‘
