# FILE-006-002: Application Layer êµ¬í˜„

**Epic**: File Upload Presigned URL System
**Layer**: Application Layer
**ë¸Œëœì¹˜**: feature/FILE-006-002-application
**Jira URL**: (sync-to-jira í›„ ì¶”ê°€)

---

## ğŸ“ ëª©ì 

íŒŒì¼ ì—…ë¡œë“œ ì„¸ì…˜ ë° íŒŒì¼ ê´€ë¦¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ êµ¬í˜„

**í•µì‹¬ ì—­í• **:
- UseCase ê¸°ë°˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ êµ¬í˜„ (CQRS)
- Transaction ê²½ê³„ ê´€ë¦¬ (S3 APIëŠ” íŠ¸ëœì­ì…˜ ë°–)
- Port ì •ì˜ (In/Out)
- ì„¸ì…˜ ë§Œë£Œ ì²˜ë¦¬ (Listener, Scheduler)

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Command UseCase

#### PrepareUploadUseCase (ì„¸ì…˜ ìƒì„± + Presigned URL ìƒì„±)

**Input DTO**:
- [ ] `PrepareUploadCommand`
  ```java
  public record PrepareUploadCommand(
      String sessionId,
      UploadType uploadType,
      String customPath,
      String fileName,
      Long fileSize,
      String mimeType,
      UserContext userContext
  ) {}
  ```

**Output DTO**:
- [ ] `PrepareUploadResponse`
  ```java
  public record PrepareUploadResponse(
      String sessionId,
      String fileId,
      UploadType uploadType,
      String uploadUrl,              // SINGLE
      List<PartUploadUrl> partUploadUrls,  // MULTIPART
      LocalDateTime expiresAt
  ) {
      public record PartUploadUrl(
          int partNumber,
          String uploadUrl
      ) {}
  }
  ```

**ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
- [ ] 1. Redis ë©±ë“±ì„± ì²´í¬ (`LoadUploadSessionPort.findById`)
  - ì¡´ì¬í•˜ë©´ ê¸°ì¡´ ì„¸ì…˜ ë°˜í™˜
- [ ] 2. íŒŒì¼ ê²€ì¦ (Domain Aggregateì— ìœ„ì„)
- [ ] 3. S3 ê²½ë¡œ ìƒì„± (Domain)
- [ ] 4. UploadSession Aggregate ìƒì„±
- [ ] 5. Redis ì €ì¥ (`SaveUploadSessionPort.save`, TTL 15ë¶„)
- [ ] 6. **íŠ¸ëœì­ì…˜ ì»¤ë°‹**
- [ ] 7. Presigned URL ìƒì„± (`S3PresignedUrlPort`, íŠ¸ëœì­ì…˜ ë°–)
  - SINGLE: 1ê°œ PUT URL
  - MULTIPART: Part URL 10ê°œ

**Transaction**: Yes (Redis ì €ì¥ê¹Œì§€)
- âš ï¸ S3 API í˜¸ì¶œì€ íŠ¸ëœì­ì…˜ ë°–

#### CompleteUploadUseCase (ì—…ë¡œë“œ ì™„ë£Œ)

**Input DTO**:
- [ ] `CompleteUploadCommand`
  ```java
  public record CompleteUploadCommand(
      String sessionId,
      UserContext userContext
  ) {}
  ```

**Output DTO**:
- [ ] `FileResponse`
  ```java
  public record FileResponse(
      String fileId,
      String fileName,
      Long fileSize,
      String mimeType,
      String s3Path,
      LocalDateTime uploadedAt
  ) {}
  ```

**ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
- [ ] 1. ì„¸ì…˜ ì¡°íšŒ (`LoadUploadSessionPort.findById`)
- [ ] 2. ê¶Œí•œ ì²´í¬ (`userId` ì¼ì¹˜)
- [ ] 3. ìƒíƒœ ê²€ì¦ (`canComplete()`)
- [ ] 4. **ë©€í‹°íŒŒíŠ¸ì¸ ê²½ìš°**: S3 Complete Multipart Upload (`S3MultipartPort`, íŠ¸ëœì­ì…˜ ë°–)
- [ ] 5. **íŠ¸ëœì­ì…˜ ì‹œì‘**
- [ ] 6. File Aggregate ìƒì„±
- [ ] 7. File ì €ì¥ (`SaveFilePort.save`, Optimistic Lock)
- [ ] 8. ì„¸ì…˜ ìƒíƒœ ë³€ê²½ (`complete()`)
- [ ] 9. **íŠ¸ëœì­ì…˜ ì»¤ë°‹**
- [ ] 10. Redis ì„¸ì…˜ ì‚­ì œ (`DeleteUploadSessionPort.delete`)

**Transaction**: Yes (File ìƒì„± + ì„¸ì…˜ ìƒíƒœ ë³€ê²½)
- âš ï¸ S3 Complete Multipart UploadëŠ” íŠ¸ëœì­ì…˜ ë°–

#### AbortUploadUseCase (ì—…ë¡œë“œ ì·¨ì†Œ)

**Input DTO**:
- [ ] `AbortUploadCommand`
  ```java
  public record AbortUploadCommand(
      String sessionId,
      UserContext userContext
  ) {}
  ```

**ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
- [ ] 1. ì„¸ì…˜ ì¡°íšŒ
- [ ] 2. ê¶Œí•œ ì²´í¬
- [ ] 3. **ë©€í‹°íŒŒíŠ¸ì¸ ê²½ìš°**: S3 Abort Multipart Upload (íŠ¸ëœì­ì…˜ ë°–)
- [ ] 4. ì„¸ì…˜ ìƒíƒœ ë³€ê²½ (`fail()`)
- [ ] 5. Redis ì„¸ì…˜ ì‚­ì œ

**Transaction**: Yes (ì„¸ì…˜ ìƒíƒœë§Œ ë³€ê²½)

### 2. Query UseCase

#### GetUploadSessionUseCase

**Input DTO**:
- [ ] `GetUploadSessionQuery`
  ```java
  public record GetUploadSessionQuery(
      String sessionId,
      UserContext userContext
  ) {}
  ```

**Output DTO**:
- [ ] `UploadSessionResponse`
  ```java
  public record UploadSessionResponse(
      String sessionId,
      String fileId,
      UploadType uploadType,
      SessionStatus status,
      LocalDateTime expiresAt,
      LocalDateTime createdAt
  ) {}
  ```

**ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
- [ ] 1. Redis ì¡°íšŒ
- [ ] 2. ê¶Œí•œ ì²´í¬
- [ ] 3. Response ë³€í™˜

**Transaction**: ReadOnly (Redis ì¡°íšŒ)

#### GetFileUseCase

**Input DTO**:
- [ ] `GetFileQuery`
  ```java
  public record GetFileQuery(
      String fileId,
      UserContext userContext
  ) {}
  ```

**Output DTO**:
- [ ] `FileDetailResponse`
  ```java
  public record FileDetailResponse(
      String fileId,
      String fileName,
      Long fileSize,
      String mimeType,
      String s3Path,
      UploadType uploadType,
      LocalDateTime uploadedAt
  ) {}
  ```

**ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
- [ ] 1. File ì¡°íšŒ (`LoadFilePort.findByIdAndNotDeleted`)
- [ ] 2. ê¶Œí•œ ì²´í¬
- [ ] 3. Response ë³€í™˜

**Transaction**: ReadOnly

#### ListFilesUseCase

**Input DTO**:
- [ ] `ListFilesQuery`
  ```java
  public record ListFilesQuery(
      Long userId,
      int page,
      int size
  ) {}
  ```

**Output DTO**:
- [ ] `PageResponse<FileSummaryResponse>`
  ```java
  public record FileSummaryResponse(
      String fileId,
      String fileName,
      Long fileSize,
      String mimeType,
      LocalDateTime uploadedAt
  ) {}
  ```

**ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
- [ ] 1. File ëª©ë¡ ì¡°íšŒ (`LoadFilePort.findByUserId`)
- [ ] 2. í˜ì´ì§• ì²˜ë¦¬ (Cursor-based)
- [ ] 3. Response ë³€í™˜

**Transaction**: ReadOnly

### 3. Assembler (Domain â†” DTO ë³€í™˜)

#### UploadSessionAssembler

**ì—­í• **: Command DTO â†’ Domain Aggregate ë³€í™˜ (VO ìƒì„±)

**âš ï¸ Static ë©”ì„œë“œ ê¸ˆì§€** (assembler-guide.md ì¤€ìˆ˜):
- AssemblerëŠ” **@Component Beanìœ¼ë¡œ ë“±ë¡** í•„ìˆ˜
- static ë©”ì„œë“œ ì‚¬ìš© ê¸ˆì§€ (DI ë¶ˆê°€, í…ŒìŠ¤íŠ¸ ì–´ë ¤ì›€)
- Instance ë©”ì„œë“œë¡œ êµ¬í˜„

**êµ¬í˜„**:
```java
@Component
public class UploadSessionAssembler {
    /**
     * Command â†’ Domain Aggregate ë³€í™˜
     * @param command PrepareUploadCommand
     * @return UploadSession
     */
    public UploadSession toDomain(PrepareUploadCommand command) {
        // Commandì˜ ì›ì‹œ íƒ€ì… â†’ Domain VO ë³€í™˜
        SessionId sessionId = SessionId.from(command.sessionId());
        FileName fileName = FileName.from(command.fileName());
        FileSize fileSize = FileSize.of(command.fileSize());
        MimeType mimeType = MimeType.of(command.mimeType());

        return UploadSession.forNew(
            command.uploadType(),
            command.customPath(),
            fileName,
            fileSize,
            mimeType,
            command.userContext().userId(),
            command.userContext().tenantId(),
            command.userContext().role(),
            command.userContext().sellerName(),
            Clock.systemDefaultZone()
        );
    }
}
```

**ë©”ì„œë“œ**:
- [ ] `toDomain(PrepareUploadCommand)`: Command â†’ UploadSession Aggregate (Instance ë©”ì„œë“œ)
  - ì›ì‹œ íƒ€ì… â†’ VO ë³€í™˜ (SessionId, FileName, FileSize, MimeType)
  - âš ï¸ `UploadSession.create()` â†’ `UploadSession.forNew()` ì‚¬ìš©

#### FileAssembler

**ì—­í• **: Domain Aggregate â†’ Response DTO ë³€í™˜ (VO â†’ ì›ì‹œ íƒ€ì…)

**êµ¬í˜„**:
```java
@Component
public class FileAssembler {
    /**
     * File â†’ FileResponse ë³€í™˜
     * Law of Demeter ì¤€ìˆ˜: getFileIdValue() ì‚¬ìš©
     */
    public FileResponse toResponse(File file) {
        // Domain VO â†’ Response ì›ì‹œ íƒ€ì… ë³€í™˜
        return new FileResponse(
            file.getFileIdValue(),             // SessionId â†’ String (Law of Demeter)
            file.getFileNameValue(),           // FileName â†’ String
            file.getFileSizeBytes(),           // FileSize â†’ Long
            file.getMimeTypeValue(),           // MimeType â†’ String
            file.getS3PathValue(),             // S3Path â†’ String
            file.getUploadedAt()
        );
    }

    public FileDetailResponse toDetailResponse(File file) {
        return new FileDetailResponse(
            file.getFileIdValue(),
            file.getFileNameValue(),
            file.getFileSizeBytes(),
            file.getMimeTypeValue(),
            file.getS3PathValue(),
            file.getUploadType(),
            file.getUploadedAt()
        );
    }

    public FileSummaryResponse toSummaryResponse(File file) {
        return new FileSummaryResponse(
            file.getFileIdValue(),
            file.getFileNameValue(),
            file.getFileSizeBytes(),
            file.getMimeTypeValue(),
            file.getUploadedAt()
        );
    }
}
```

**ë©”ì„œë“œ**:
- [ ] `toResponse(File)`: File â†’ FileResponse (Instance ë©”ì„œë“œ)
- [ ] `toDetailResponse(File)`: File â†’ FileDetailResponse
- [ ] `toSummaryResponse(File)`: File â†’ FileSummaryResponse
- âš ï¸ **Law of Demeter ì¤€ìˆ˜**: `file.getFileId().value()` â†’ `file.getFileIdValue()`

#### UploadSessionResponseAssembler

**ì—­í• **: Domain Aggregate â†’ Response DTO ë³€í™˜ (ì„¸ì…˜ ì¡°íšŒìš©)

**êµ¬í˜„**:
```java
@Component
public class UploadSessionResponseAssembler {
    /**
     * UploadSession â†’ UploadSessionResponse ë³€í™˜
     * Law of Demeter ì¤€ìˆ˜
     */
    public UploadSessionResponse toResponse(UploadSession session) {
        return new UploadSessionResponse(
            session.getSessionIdValue(),       // SessionId â†’ String (Law of Demeter)
            session.getFileIdValue(),          // FileId â†’ String
            session.getUploadType(),
            session.getStatus(),
            session.getExpiresAt(),
            session.getCreatedAt()
        );
    }
}
```

**ë©”ì„œë“œ**:
- [ ] `toResponse(UploadSession)`: UploadSession â†’ UploadSessionResponse (Instance ë©”ì„œë“œ)
- âš ï¸ **Law of Demeter ì¤€ìˆ˜**: `session.getSessionId().value()` â†’ `session.getSessionIdValue()`

### 4. Port ì •ì˜

#### In Port (UseCase ì¸í„°í˜ì´ìŠ¤)

- [ ] `PrepareUploadInPort`
- [ ] `CompleteUploadInPort`
- [ ] `AbortUploadInPort`
- [ ] `GetUploadSessionInPort`
- [ ] `GetFileInPort`
- [ ] `ListFilesInPort`

#### Out Port (Persistence, S3, Redis)

**Session Port**:
- [ ] `LoadUploadSessionPort`
  - `Optional<UploadSession> findById(String sessionId)`
- [ ] `SaveUploadSessionPort`
  - `void save(UploadSession session, Duration ttl)`
- [ ] `DeleteUploadSessionPort`
  - `void delete(String sessionId)`

**File Port**:
- [ ] `LoadFilePort`
  - `Optional<File> findByIdAndNotDeleted(String fileId)`
  - `List<File> findByUserId(Long userId, Pageable pageable)`
- [ ] `SaveFilePort`
  - `File save(File file)`

**S3 Port**:
- [ ] `S3PresignedUrlPort`
  - `String generatePutUrl(String s3Path, Duration expiration)`
  - `String initiateMultipartUpload(String s3Path)`
  - `List<PartUploadUrl> generatePartUploadUrls(String s3Path, String uploadId, int partCount, Duration expiration)`
- [ ] `S3MultipartPort`
  - `void completeMultipartUpload(String s3Path, String uploadId, List<String> eTags)`
  - `void abortMultipartUpload(String s3Path, String uploadId)`

### 4. Event Listener

#### UploadSessionExpiredListener (Redis Keyspace Notification)

**Trigger**: Redis TTL ë§Œë£Œ ì´ë²¤íŠ¸

**ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
- [ ] 1. sessionId ì¶”ì¶œ
- [ ] 2. ì„¸ì…˜ ìƒíƒœ í™•ì¸ (Redisì—ì„œ ì´ë¯¸ ì‚­ì œë¨)
- [ ] 3. ë©€í‹°íŒŒíŠ¸ì¸ ê²½ìš°: S3 Abort Multipart Upload
- [ ] 4. ë¡œê·¸ ê¸°ë¡ (ìŠ¬ë™ ì•Œë¦¼)

**êµ¬í˜„**:
- [ ] `@EventListener(RedisKeyExpiredEvent.class)`
- [ ] ë¹„ë™ê¸° ì²˜ë¦¬ (`@Async`)

#### S3UploadCompletedListener (ì„ íƒì , S3 Event)

**Trigger**: S3 ObjectCreated ì´ë²¤íŠ¸ (SQS)

**ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
- [ ] 1. S3 ê²½ë¡œì—ì„œ sessionId ì¶”ì¶œ
- [ ] 2. `CompleteUploadUseCase` í˜¸ì¶œ

**êµ¬í˜„**:
- [ ] `@SqsListener(queues = "upload-completed-queue")`

### 5. Scheduler

#### ExpiredSessionCleanupScheduler

**ì‹¤í–‰ ì£¼ê¸°**: 5ë¶„ë§ˆë‹¤ (`@Scheduled(cron = "0 */5 * * * *")`)

**ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
- [ ] 1. Redisì—ì„œ ëª¨ë“  ACTIVE ì„¸ì…˜ ì¡°íšŒ (í‚¤ ìŠ¤ìº”)
- [ ] 2. ë§Œë£Œ ì—¬ë¶€ í™•ì¸ (`expiresAt < now()`)
- [ ] 3. ë§Œë£Œëœ ì„¸ì…˜ì— ëŒ€í•´ `AbortUploadUseCase` í˜¸ì¶œ

**ì£¼ì˜ì‚¬í•­**:
- [ ] Redis SCAN ëª…ë ¹ ì‚¬ìš© (KEYS ê¸ˆì§€)
- [ ] ë°°ì¹˜ í¬ê¸° ì œí•œ (í•œ ë²ˆì— ìµœëŒ€ 100ê°œ)

### 6. DTO ê³µí†µ ê·œì¹™

- [ ] **UserContext** (JWT íŒŒì‹± ê²°ê³¼):
  ```java
  /**
   * ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ DTO
   *
   * <p>JWT í† í°ì—ì„œ ì¶”ì¶œí•œ ì‚¬ìš©ì ì •ë³´
   *
   * @param userId ì‚¬ìš©ì ID
   * @param tenantId í…Œë„ŒíŠ¸ ID
   * @param role ì‚¬ìš©ì ì—­í•  (ADMIN, SELLER, DEFAULT)
   * @param sellerName ì…€ëŸ¬ëª… (SELLERë§Œ í•„ìˆ˜, ë‚˜ë¨¸ì§€ëŠ” null)
   */
  public record UserContext(
      Long userId,
      Long tenantId,
      UserRole role,
      String sellerName
  ) {
      /**
       * JWTì—ì„œ UserContext ìƒì„± (REST API Layerì—ì„œ ì‚¬ìš©)
       *
       * @param jwtUser JwtUser (Spring Security Authentication)
       * @return UserContext DTO
       */
      public static UserContext from(JwtUser jwtUser) {
          return new UserContext(
              jwtUser.getUserId(),
              jwtUser.getTenantId(),
              jwtUser.getRole(),
              jwtUser.getSellerName()
          );
      }
  }
  ```

- [ ] **SessionPreparationResult** (Application Layer Response DTO):
  ```java
  /**
   * ì„¸ì…˜ ì¤€ë¹„ ê²°ê³¼ DTO
   *
   * <p>PrepareUploadUseCaseì˜ ë°˜í™˜ DTO
   *
   * @param sessionId ì„¸ì…˜ ID
   * @param fileId íŒŒì¼ ID
   * @param uploadType ì—…ë¡œë“œ íƒ€ì… (SINGLE, MULTIPART)
   * @param uploadUrl SINGLE ì—…ë¡œë“œ URL (SINGLEë§Œ)
   * @param partUploadUrls MULTIPART ì—…ë¡œë“œ URL ë¦¬ìŠ¤íŠ¸ (MULTIPARTë§Œ)
   * @param expiresAt ì„¸ì…˜ ë§Œë£Œ ì‹œê°
   */
  public record SessionPreparationResult(
      String sessionId,
      String fileId,
      UploadType uploadType,
      String uploadUrl,
      List<PartUploadUrl> partUploadUrls,
      LocalDateTime expiresAt
  ) {
      /**
       * MULTIPART íŒŒíŠ¸ ì—…ë¡œë“œ URL
       */
      public record PartUploadUrl(
          int partNumber,
          String uploadUrl
      ) {}

      /**
       * SINGLE ì—…ë¡œë“œ ê²°ê³¼ ìƒì„±
       */
      public static SessionPreparationResult forSingle(
          String sessionId,
          String fileId,
          String uploadUrl,
          LocalDateTime expiresAt
      ) {
          return new SessionPreparationResult(
              sessionId,
              fileId,
              UploadType.SINGLE,
              uploadUrl,
              null,
              expiresAt
          );
      }

      /**
       * MULTIPART ì—…ë¡œë“œ ê²°ê³¼ ìƒì„±
       */
      public static SessionPreparationResult forMultipart(
          String sessionId,
          String fileId,
          List<PartUploadUrl> partUploadUrls,
          LocalDateTime expiresAt
      ) {
          return new SessionPreparationResult(
              sessionId,
              fileId,
              UploadType.MULTIPART,
              null,
              partUploadUrls,
              expiresAt
          );
      }
  }
  ```

- [ ] **Command DTO**: Record ì‚¬ìš©, Validation ì—†ìŒ (REST API Layerì—ì„œ ê²€ì¦)
- [ ] **Query DTO**: Record ì‚¬ìš©
- [ ] **Response DTO**: Record ì‚¬ìš©, null í•„ë“œ í—ˆìš© (`@Nullable`)

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™

- [ ] **Command/Query ë¶„ë¦¬ (CQRS)**:
  - Command UseCase: ìƒíƒœ ë³€ê²½
  - Query UseCase: ì¡°íšŒë§Œ
- [ ] **Transaction ê²½ê³„ ì—„ê²© ê´€ë¦¬**:
  - `@Transactional` ë‚´ S3 API í˜¸ì¶œ ì ˆëŒ€ ê¸ˆì§€
  - S3 APIëŠ” íŠ¸ëœì­ì…˜ ë°–ì—ì„œ í˜¸ì¶œ í›„ ë³´ìƒ íŠ¸ëœì­ì…˜
- [ ] **Assembler ì‚¬ìš©**:
  - Domain â†” DTO ë³€í™˜ì€ Assemblerì— ìœ„ì„
  - UseCaseì—ì„œ ì§ì ‘ ë³€í™˜ ê¸ˆì§€
- [ ] **Port ì˜ì¡´ì„±**:
  - UseCaseëŠ” Port(ì¸í„°í˜ì´ìŠ¤)ì—ë§Œ ì˜ì¡´
  - êµ¬í˜„ì²´(Adapter) ì§ì ‘ ì˜ì¡´ ê¸ˆì§€

### í…ŒìŠ¤íŠ¸ ê·œì¹™

- [ ] **ArchUnit í…ŒìŠ¤íŠ¸ í•„ìˆ˜**:
  - Application LayerëŠ” Domainì—ë§Œ ì˜ì¡´
  - Port(Out) ì¸í„°í˜ì´ìŠ¤ë§Œ ì˜ì¡´
  - Adapter ì§ì ‘ ì˜ì¡´ ê¸ˆì§€
- [ ] **Mock ì‚¬ìš©**:
  - Out PortëŠ” Mockitoë¡œ Mock
  - Domain AggregateëŠ” ì‹¤ì œ ê°ì²´ ì‚¬ìš©
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ > 80%**:
  - UseCaseë³„ ì •ìƒ/ì˜ˆì™¸ ì‹œë‚˜ë¦¬ì˜¤

---

## âœ… ì™„ë£Œ ì¡°ê±´

### êµ¬í˜„ ì™„ë£Œ
- [ ] Command UseCase 3ê°œ êµ¬í˜„ (Prepare, Complete, Abort)
- [ ] Query UseCase 3ê°œ êµ¬í˜„ (GetSession, GetFile, ListFiles)
- [ ] Assembler 3ê°œ êµ¬í˜„ (UploadSessionAssembler, FileAssembler, UploadSessionResponseAssembler)
- [ ] Port ì¸í„°í˜ì´ìŠ¤ 6ê°œ ì •ì˜
- [ ] UserContext, Command/Query/Response DTO ì •ì˜
- [ ] Event Listener 2ê°œ êµ¬í˜„ (Redis TTL, S3 Event)
- [ ] Scheduler 1ê°œ êµ¬í˜„ (Expired Session Cleanup)

### í…ŒìŠ¤íŠ¸ ì™„ë£Œ
- [ ] PrepareUploadUseCase Unit Test (5+ í…ŒìŠ¤íŠ¸)
  - ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤
  - ë©±ë“±ì„± (ê¸°ì¡´ ì„¸ì…˜ ë°˜í™˜)
  - íŒŒì¼ í¬ê¸° ì´ˆê³¼
  - íŒŒì¼ íƒ€ì… ì˜¤ë¥˜
  - S3 API í˜¸ì¶œ ì‹¤íŒ¨
- [ ] CompleteUploadUseCase Unit Test (5+ í…ŒìŠ¤íŠ¸)
  - ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤ (SINGLE, MULTIPART)
  - ì„¸ì…˜ ì—†ìŒ
  - ê¶Œí•œ ì—†ìŒ
  - ìƒíƒœ ì˜¤ë¥˜ (EXPIRED)
  - Optimistic Lock ì¶©ëŒ
- [ ] AbortUploadUseCase Unit Test (3+ í…ŒìŠ¤íŠ¸)
- [ ] Query UseCase Unit Test (ê° 3+ í…ŒìŠ¤íŠ¸)
- [ ] Event Listener Unit Test (ê° 2+ í…ŒìŠ¤íŠ¸)
- [ ] Scheduler Unit Test (2+ í…ŒìŠ¤íŠ¸)
- [ ] ArchUnit Test (3+ ê·œì¹™)

### í’ˆì§ˆ ê²€ì¦
- [ ] ëª¨ë“  Unit Test í†µê³¼
- [ ] ëª¨ë“  ArchUnit Test í†µê³¼
- [ ] í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ > 80%
- [ ] Transaction ê²½ê³„ ìˆ˜ë™ í™•ì¸
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸

---

## ğŸ“‚ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
application/src/main/java/com/fileflow/application/
â”œâ”€â”€ session/
â”‚   â”œâ”€â”€ port/
â”‚   â”‚   â”œâ”€â”€ in/
â”‚   â”‚   â”‚   â”œâ”€â”€ PrepareUploadInPort.java
â”‚   â”‚   â”‚   â”œâ”€â”€ CompleteUploadInPort.java
â”‚   â”‚   â”‚   â”œâ”€â”€ AbortUploadInPort.java
â”‚   â”‚   â”‚   â””â”€â”€ GetUploadSessionInPort.java
â”‚   â”‚   â””â”€â”€ out/
â”‚   â”‚       â”œâ”€â”€ LoadUploadSessionPort.java
â”‚   â”‚       â”œâ”€â”€ SaveUploadSessionPort.java
â”‚   â”‚       â”œâ”€â”€ DeleteUploadSessionPort.java
â”‚   â”‚       â”œâ”€â”€ S3PresignedUrlPort.java
â”‚   â”‚       â””â”€â”€ S3MultipartPort.java
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ PrepareUploadUseCase.java
â”‚   â”‚   â”œâ”€â”€ CompleteUploadUseCase.java
â”‚   â”‚   â”œâ”€â”€ AbortUploadUseCase.java
â”‚   â”‚   â””â”€â”€ GetUploadSessionUseCase.java
â”‚   â”œâ”€â”€ assembler/
â”‚   â”‚   â”œâ”€â”€ UploadSessionAssembler.java
â”‚   â”‚   â””â”€â”€ UploadSessionResponseAssembler.java
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ command/
â”‚   â”‚   â”‚   â”œâ”€â”€ PrepareUploadCommand.java
â”‚   â”‚   â”‚   â”œâ”€â”€ CompleteUploadCommand.java
â”‚   â”‚   â”‚   â””â”€â”€ AbortUploadCommand.java
â”‚   â”‚   â”œâ”€â”€ query/
â”‚   â”‚   â”‚   â””â”€â”€ GetUploadSessionQuery.java
â”‚   â”‚   â””â”€â”€ response/
â”‚   â”‚       â”œâ”€â”€ PrepareUploadResponse.java
â”‚   â”‚       â””â”€â”€ UploadSessionResponse.java
â”‚   â”œâ”€â”€ listener/
â”‚   â”‚   â”œâ”€â”€ UploadSessionExpiredListener.java
â”‚   â”‚   â””â”€â”€ S3UploadCompletedListener.java
â”‚   â””â”€â”€ scheduler/
â”‚       â””â”€â”€ ExpiredSessionCleanupScheduler.java
â”œâ”€â”€ file/
â”‚   â”œâ”€â”€ port/
â”‚   â”‚   â”œâ”€â”€ in/
â”‚   â”‚   â”‚   â”œâ”€â”€ GetFileInPort.java
â”‚   â”‚   â”‚   â””â”€â”€ ListFilesInPort.java
â”‚   â”‚   â””â”€â”€ out/
â”‚   â”‚       â”œâ”€â”€ LoadFilePort.java
â”‚   â”‚       â””â”€â”€ SaveFilePort.java
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ GetFileUseCase.java
â”‚   â”‚   â””â”€â”€ ListFilesUseCase.java
â”‚   â”œâ”€â”€ assembler/
â”‚   â”‚   â””â”€â”€ FileAssembler.java
â”‚   â””â”€â”€ dto/
â”‚       â”œâ”€â”€ query/
â”‚       â”‚   â”œâ”€â”€ GetFileQuery.java
â”‚       â”‚   â””â”€â”€ ListFilesQuery.java
â”‚       â””â”€â”€ response/
â”‚           â”œâ”€â”€ FileResponse.java
â”‚           â”œâ”€â”€ FileDetailResponse.java
â”‚           â””â”€â”€ FileSummaryResponse.java
â””â”€â”€ common/
    â””â”€â”€ UserContext.java

application/src/test/java/com/fileflow/application/
â”œâ”€â”€ session/
â”‚   â”œâ”€â”€ PrepareUploadUseCaseTest.java
â”‚   â”œâ”€â”€ CompleteUploadUseCaseTest.java
â”‚   â”œâ”€â”€ AbortUploadUseCaseTest.java
â”‚   â””â”€â”€ UploadSessionExpiredListenerTest.java
â”œâ”€â”€ file/
â”‚   â”œâ”€â”€ GetFileUseCaseTest.java
â”‚   â””â”€â”€ ListFilesUseCaseTest.java
â””â”€â”€ architecture/
    â””â”€â”€ ApplicationLayerArchitectureTest.java
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: `/Users/sangwon-ryu/fileflow/docs/prd/presigned-url-upload.md`
- **Plan**: `docs/prd/plans/FILE-006-002-application-plan.md` (create-plan í›„ ìƒì„±)
- **Jira**: (sync-to-jira í›„ ì¶”ê°€)
- **Application Layer ê·œì¹™**: `docs/coding_convention/03-application-layer/`

---

## ğŸ“ ì°¸ê³ ì‚¬í•­

### TDD ì§„í–‰ ìˆœì„œ (ê¶Œì¥)

1. **DTO ë¨¼ì €** (ì˜ì¡´ì„± ì—†ìŒ):
   - UserContext, Command/Query/Response DTO
2. **Port ì¸í„°í˜ì´ìŠ¤**:
   - In Port, Out Port ì •ì˜
3. **Query UseCase** (ë‹¨ìˆœ):
   - GetFile, ListFiles, GetUploadSession
4. **Command UseCase** (ë³µì¡):
   - PrepareUpload, CompleteUpload, AbortUpload
5. **Listener, Scheduler**:
   - Event ì²˜ë¦¬

### Transaction ê²½ê³„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] PrepareUploadUseCase:
  - Redis ì €ì¥ê¹Œì§€ íŠ¸ëœì­ì…˜
  - S3 APIëŠ” íŠ¸ëœì­ì…˜ ë°–
- [ ] CompleteUploadUseCase:
  - S3 CompleteëŠ” íŠ¸ëœì­ì…˜ ë°–
  - File ìƒì„± + ì„¸ì…˜ ìƒíƒœ ë³€ê²½ì€ íŠ¸ëœì­ì…˜ ì•ˆ
- [ ] AbortUploadUseCase:
  - S3 AbortëŠ” íŠ¸ëœì­ì…˜ ë°–

---

**ë‹¤ìŒ ë‹¨ê³„**:
1. `/create-plan FILE-006-002` - TDD Plan ìƒì„±
2. `/kb/application/go` - TDD ì‚¬ì´í´ ì‹œì‘
3. êµ¬í˜„ ì™„ë£Œ í›„ FILE-006-003 (Persistence Layer) ì‹œì‘
