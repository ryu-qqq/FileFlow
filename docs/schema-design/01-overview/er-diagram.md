# üìä FileFlow ER Îã§Ïù¥Ïñ¥Í∑∏Îû®

## 1. Ï†ÑÏ≤¥ ER Îã§Ïù¥Ïñ¥Í∑∏Îû®

```mermaid
erDiagram
    %% ÌÖåÎÑåÌä∏ & Ï°∞ÏßÅ
    TENANTS ||--o{ ORGANIZATIONS : has
    TENANTS ||--o{ TENANT_SETTINGS : has
    ORGANIZATIONS ||--o{ ORGANIZATION_SETTINGS : has
    ORGANIZATIONS ||--o{ USERS : belongs_to
    
    %% ÏÇ¨Ïö©Ïûê & Í∂åÌïú
    USERS ||--o{ USER_ROLES : has
    ROLES ||--o{ USER_ROLES : assigned_to
    ROLES ||--o{ ROLE_PERMISSIONS : has
    PERMISSIONS ||--o{ ROLE_PERMISSIONS : granted_to
    
    %% ÏóÖÎ°úÎìú Í¥ÄÎ¶¨
    TENANTS ||--o{ UPLOAD_POLICIES : defines
    ORGANIZATIONS ||--o{ UPLOAD_POLICIES : customizes
    USERS ||--o{ UPLOAD_SESSIONS : creates
    UPLOAD_SESSIONS ||--o{ UPLOAD_PARTS : contains
    UPLOAD_POLICIES ||--o{ UPLOAD_SESSIONS : governs
    
    %% ÌååÏùº Í¥ÄÎ¶¨
    UPLOAD_SESSIONS ||--o{ FILE_ASSETS : produces
    FILE_ASSETS ||--o{ FILE_VARIANTS : has
    FILE_ASSETS ||--o{ FILE_METADATA : has
    FILE_ASSETS ||--o{ FILE_RELATIONSHIPS : has_source
    FILE_ASSETS ||--o{ FILE_RELATIONSHIPS : has_target
    
    %% ÌååÏù¥ÌîÑÎùºÏù∏ Ï≤òÎ¶¨
    PIPELINE_DEFINITIONS ||--o{ PIPELINE_STAGES : contains
    FILE_ASSETS ||--o{ PIPELINE_EXECUTIONS : triggers
    PIPELINE_DEFINITIONS ||--o{ PIPELINE_EXECUTIONS : uses
    PIPELINE_EXECUTIONS ||--o{ PIPELINE_STAGE_LOGS : generates
    PIPELINE_STAGES ||--o{ PIPELINE_STAGE_LOGS : executed_in
    
    %% Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
    FILE_ASSETS ||--o{ EXTRACTED_DATA : produces
    EXTRACTED_DATA ||--o{ DATA_MAPPINGS : uses
    CANONICAL_FORMATS ||--o{ DATA_MAPPINGS : defines
    
    %% Í∞êÏÇ¨ Î°úÍ∑∏
    USERS ||--o{ AUDIT_LOGS : generates
    FILE_ASSETS ||--o{ ACCESS_LOGS : tracked_in
    PIPELINE_EXECUTIONS ||--o{ PROCESSING_ERRORS : may_have
```

## 2. ÎèÑÎ©îÏù∏Î≥Ñ ÏÉÅÏÑ∏ Í¥ÄÍ≥ÑÎèÑ

### 2.1 ÌÖåÎÑåÌä∏ & Ï°∞ÏßÅ Í¥ÄÍ≥Ñ

```mermaid
erDiagram
    TENANTS {
        varchar(50) tenant_id PK
        enum tenant_type "B2B/B2C"
        varchar(100) name
        enum status
        json settings
        datetime created_at
        datetime updated_at
    }
    
    ORGANIZATIONS {
        bigint id PK
        varchar(50) tenant_id FK
        varchar(100) org_code UK
        varchar(200) name
        enum org_type "SELLER/COMPANY/INTERNAL"
        enum status
        json metadata
        datetime created_at
        datetime updated_at
    }
    
    TENANT_SETTINGS {
        bigint id PK
        varchar(50) tenant_id FK
        varchar(100) setting_key
        text setting_value
        enum value_type
        datetime created_at
        datetime updated_at
    }
    
    ORGANIZATION_SETTINGS {
        bigint id PK
        bigint organization_id FK
        varchar(100) setting_key
        text setting_value
        datetime created_at
        datetime updated_at
    }
    
    TENANTS ||--o{ ORGANIZATIONS : "1:N"
    TENANTS ||--o{ TENANT_SETTINGS : "1:N"
    ORGANIZATIONS ||--o{ ORGANIZATION_SETTINGS : "1:N"
```

### 2.2 ÏÇ¨Ïö©Ïûê & Í∂åÌïú Í¥ÄÍ≥Ñ

```mermaid
erDiagram
    USERS {
        bigint id PK
        varchar(50) tenant_id FK
        bigint organization_id FK
        varchar(100) username UK
        varchar(200) email UK
        varchar(255) password_hash
        enum user_type "SELLER/COMPANY_ADMIN/INTERNAL_ADMIN/CUSTOMER"
        enum status
        json profile
        datetime last_login_at
        datetime created_at
        datetime updated_at
    }
    
    ROLES {
        bigint id PK
        varchar(50) tenant_id FK
        varchar(50) role_code UK
        varchar(100) role_name
        text description
        enum role_type "SYSTEM/CUSTOM"
        datetime created_at
        datetime updated_at
    }
    
    USER_ROLES {
        bigint id PK
        bigint user_id FK
        bigint role_id FK
        datetime assigned_at
        datetime expires_at
    }
    
    PERMISSIONS {
        bigint id PK
        varchar(100) permission_code UK
        varchar(200) permission_name
        varchar(50) resource_type
        varchar(50) action
        text description
    }
    
    ROLE_PERMISSIONS {
        bigint id PK
        bigint role_id FK
        bigint permission_id FK
        json conditions
    }
    
    USERS ||--o{ USER_ROLES : "1:N"
    ROLES ||--o{ USER_ROLES : "1:N"
    ROLES ||--o{ ROLE_PERMISSIONS : "1:N"
    PERMISSIONS ||--o{ ROLE_PERMISSIONS : "1:N"
```

### 2.3 ÌååÏùº Í¥ÄÎ¶¨ Í¥ÄÍ≥Ñ

```mermaid
erDiagram
    FILE_ASSETS {
        bigint id PK
        varchar(36) file_id UK
        varchar(36) session_id FK
        varchar(50) tenant_id FK
        bigint organization_id FK
        varchar(255) original_name
        varchar(255) stored_name
        varchar(20) file_type "IMAGE/HTML/PDF/EXCEL"
        bigint file_size
        varchar(100) mime_type
        varchar(2048) storage_path
        varchar(2048) cdn_url
        varchar(64) checksum
        enum status
        datetime created_at
        datetime updated_at
        datetime deleted_at
    }
    
    FILE_VARIANTS {
        bigint id PK
        bigint original_file_id FK
        varchar(36) variant_file_id UK
        varchar(50) variant_type "THUMBNAIL/OPTIMIZED/CONVERTED"
        json variant_config
        varchar(2048) storage_path
        varchar(2048) cdn_url
        bigint file_size
        json dimensions
        datetime created_at
    }
    
    FILE_METADATA {
        bigint id PK
        bigint file_id FK
        varchar(100) metadata_key
        text metadata_value
        enum value_type "STRING/NUMBER/JSON/BINARY"
        datetime created_at
    }
    
    FILE_RELATIONSHIPS {
        bigint id PK
        bigint source_file_id FK
        bigint target_file_id FK
        varchar(50) relationship_type "DERIVED/RELATED/REPLACEMENT"
        json metadata
        datetime created_at
    }
    
    FILE_ASSETS ||--o{ FILE_VARIANTS : "1:N"
    FILE_ASSETS ||--o{ FILE_METADATA : "1:N"
    FILE_ASSETS ||--o{ FILE_RELATIONSHIPS : "1:N source"
    FILE_ASSETS ||--o{ FILE_RELATIONSHIPS : "1:N target"
```

### 2.4 ÏóÖÎ°úÎìú Í¥ÄÎ¶¨ Í¥ÄÍ≥Ñ

```mermaid
erDiagram
    UPLOAD_SESSIONS {
        bigint id PK
        varchar(36) session_id UK
        varchar(50) tenant_id FK
        bigint user_id FK
        bigint policy_id FK
        enum upload_type "PRESIGNED/EXTERNAL_URL"
        enum status
        varchar(2048) external_url
        json session_config
        varchar(64) idempotency_key
        integer total_parts
        datetime expires_at
        datetime created_at
        datetime updated_at
    }
    
    UPLOAD_PARTS {
        bigint id PK
        varchar(36) session_id FK
        integer part_number
        varchar(255) etag
        bigint size
        enum status
        datetime uploaded_at
    }
    
    UPLOAD_POLICIES {
        bigint id PK
        varchar(50) tenant_id FK
        bigint organization_id FK
        varchar(50) policy_code UK
        varchar(100) policy_name
        json allowed_types
        bigint max_file_size
        bigint max_total_size
        integer max_files
        json allowed_sources
        json processing_rules
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    UPLOAD_SESSIONS ||--o{ UPLOAD_PARTS : "1:N"
    UPLOAD_POLICIES ||--o{ UPLOAD_SESSIONS : "1:N"
```

### 2.5 ÌååÏù¥ÌîÑÎùºÏù∏ Ï≤òÎ¶¨ Í¥ÄÍ≥Ñ

```mermaid
erDiagram
    PIPELINE_DEFINITIONS {
        bigint id PK
        varchar(50) pipeline_code UK
        varchar(100) pipeline_name
        varchar(20) file_type
        json trigger_conditions
        json configuration
        boolean is_active
        integer priority
        datetime created_at
        datetime updated_at
    }
    
    PIPELINE_STAGES {
        bigint id PK
        bigint pipeline_id FK
        varchar(50) stage_code
        varchar(100) stage_name
        integer sequence_order
        varchar(100) processor_type
        json stage_config
        boolean is_optional
        integer timeout_seconds
    }
    
    PIPELINE_EXECUTIONS {
        bigint id PK
        varchar(36) execution_id UK
        bigint file_id FK
        bigint pipeline_id FK
        enum status
        json input_params
        json output_results
        datetime started_at
        datetime completed_at
        integer duration_ms
    }
    
    PIPELINE_STAGE_LOGS {
        bigint id PK
        bigint execution_id FK
        bigint stage_id FK
        enum status
        json input_data
        json output_data
        text error_message
        datetime started_at
        datetime completed_at
        integer duration_ms
    }
    
    PIPELINE_DEFINITIONS ||--o{ PIPELINE_STAGES : "1:N"
    PIPELINE_DEFINITIONS ||--o{ PIPELINE_EXECUTIONS : "1:N"
    PIPELINE_EXECUTIONS ||--o{ PIPELINE_STAGE_LOGS : "1:N"
    PIPELINE_STAGES ||--o{ PIPELINE_STAGE_LOGS : "1:N"
```

### 2.6 Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú Í¥ÄÍ≥Ñ

```mermaid
erDiagram
    EXTRACTED_DATA {
        bigint id PK
        bigint file_id FK
        varchar(50) extraction_type "OCR/AI_MAPPING/METADATA"
        json extracted_content
        float confidence_score
        varchar(50) extraction_method
        datetime extracted_at
    }
    
    DATA_MAPPINGS {
        bigint id PK
        bigint extracted_data_id FK
        bigint canonical_format_id FK
        json source_fields
        json mapped_fields
        float mapping_score
        enum status
        datetime created_at
    }
    
    CANONICAL_FORMATS {
        bigint id PK
        varchar(50) format_code UK
        varchar(100) format_name
        varchar(50) domain_type "PRODUCT/ORDER/INVENTORY"
        json schema_definition
        integer version
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    EXTRACTED_DATA ||--o{ DATA_MAPPINGS : "1:N"
    CANONICAL_FORMATS ||--o{ DATA_MAPPINGS : "1:N"
```

## 3. Ïù∏Îç±Ïä§ Ï†ÑÎûµ

### 3.1 Primary Keys
- Î™®Îì† ÌÖåÏù¥Î∏îÏùÄ `id` (BIGINT AUTO_INCREMENT) ÏÇ¨Ïö©
- ÎπÑÏ¶àÎãàÏä§ ÌÇ§Îäî Î≥ÑÎèÑ Unique Index ÏÑ§Ï†ï

### 3.2 Foreign Keys
- Î™®Îì† FKÏóê Ïù∏Îç±Ïä§ ÏûêÎèô ÏÉùÏÑ±
- CASCADE ÏòµÏÖòÏùÄ Ïã†Ï§ëÌûà ÏÇ¨Ïö© (ÎåÄÎ∂ÄÎ∂Ñ RESTRICT)

### 3.3 Ï°∞Ìöå ÏÑ±Îä• Ïù∏Îç±Ïä§

```sql
-- ÏûêÏ£º ÏÇ¨Ïö©ÎêòÎäî Î≥µÌï© Ïù∏Îç±Ïä§
CREATE INDEX idx_files_tenant_org ON file_assets(tenant_id, organization_id, created_at DESC);
CREATE INDEX idx_files_type_status ON file_assets(file_type, status, created_at DESC);
CREATE INDEX idx_sessions_user_status ON upload_sessions(user_id, status, created_at DESC);
CREATE INDEX idx_executions_file_pipeline ON pipeline_executions(file_id, pipeline_id, status);

-- Í≤ÄÏÉâÏö© Ïù∏Îç±Ïä§
CREATE FULLTEXT INDEX idx_files_search ON file_assets(original_name);
CREATE INDEX idx_metadata_key_value ON file_metadata(metadata_key, metadata_value(100));
```

### 3.4 ÌååÌã∞ÏÖîÎãù Ï†ÑÎûµ

ÎåÄÏö©Îüâ ÌÖåÏù¥Î∏îÏùò Í≤ΩÏö∞ ÌååÌã∞ÏÖîÎãù Ï†ÅÏö©:

```sql
-- ÎÇ†Ïßú Í∏∞Î∞ò ÌååÌã∞ÏÖîÎãù (ÏõîÎ≥Ñ)
ALTER TABLE file_assets
PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503),
    ...
);

-- ÌÖåÎÑåÌä∏ Í∏∞Î∞ò ÌååÌã∞ÏÖîÎãù
ALTER TABLE audit_logs
PARTITION BY KEY(tenant_id)
PARTITIONS 10;
```

## 4. Ï†úÏïΩÏ°∞Í±¥ & ÎπÑÏ¶àÎãàÏä§ Í∑úÏπô

### 4.1 Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ±
- Î™®Îì† FKÎäî Ïú†Ìö®Ìïú Ï∞∏Ï°∞ Î≥¥Ïû•
- Soft Delete Ïãú Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Í∑úÏπô
- ÏàúÌôò Ï∞∏Ï°∞ Î∞©ÏßÄ

### 4.2 ÎπÑÏ¶àÎãàÏä§ Í∑úÏπô
- ÌÖåÎÑåÌä∏ Í∞Ñ Îç∞Ïù¥ÌÑ∞ Í≤©Î¶¨ (Row Level Security)
- ÌååÏùº ÌÅ¨Í∏∞ Ï†úÌïú Ï≤¥ÌÅ¨
- ÎèôÏãúÏÑ± Ï†úÏñ¥ (Optimistic Locking)

### 4.3 Í∞êÏÇ¨ Í∑úÏπô
- Î™®Îì† CUD ÏûëÏóÖ Î°úÍπÖ
- ÎØºÍ∞ê Îç∞Ïù¥ÌÑ∞ Ï†ëÍ∑º Ï∂îÏ†Å
- Î≥ÄÍ≤Ω Ïù¥Î†• Í¥ÄÎ¶¨
