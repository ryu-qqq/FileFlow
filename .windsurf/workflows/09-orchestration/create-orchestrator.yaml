# Orchestration Pattern Boilerplate ìƒì„± ì›Œí¬í”Œë¡œìš°
# Windsurf IDE (Cascade)ì—ì„œ ì°¸ê³ í•˜ëŠ” ì²´ê³„ì ì¸ ê°€ì´ë“œ
# ì‹¤ì œ íŒŒì¼ ìƒì„±ì€ Cascadeê°€ .windsurf/rules/*.mdì™€ templates/*.javaë¥¼ ì°¸ê³ í•˜ì—¬ ìˆ˜í–‰

name: "Create Orchestration Pattern Boilerplate"
description: "ì™¸ë¶€ API í˜¸ì¶œì„ ìœ„í•œ Orchestration Pattern ì „ì²´ êµ¬ì¡°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤ (Command, Orchestrator, Entities, Repositories, Schedulers, Controller, Tests)"
version: "1.0.0"
author: "Claude Spring Standards"
tags: ["orchestration", "boilerplate", "pattern", "java21", "spring-boot"]

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
triggers:
  keywords: ["orchestrator", "orchestration", "ì™¸ë¶€ API", "ì™¸ë¶€ í˜¸ì¶œ", "idempotency", "ë©±ë“±ì„±"]
  patterns:
    - ".*Orchestrator.*ë¥¼ ìƒì„±.*"
    - ".*ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°.*ë§Œë“¤.*"
    - ".*ì™¸ë¶€ API.*íŒ¨í„´.*"

# ì…ë ¥ íŒŒë¼ë¯¸í„°
inputs:
  domain:
    type: string
    description: "Domain ì´ë¦„ (ì˜ˆ: Payment, FileUpload, Notification)"
    required: true
    example: "Payment"

  eventType:
    type: string
    description: "EventType ì´ë¦„ (ì˜ˆ: PaymentRequested, FileUploadRequested)"
    required: true
    example: "PaymentRequested"

  externalApi:
    type: string
    description: "ì™¸ë¶€ API ì„¤ëª… (ì˜ˆ: PaymentGateway, S3Client, FCMClient)"
    required: false
    default: "ExternalApiClient"

# ìƒì„± ë‹¨ê³„ (Cascadeê°€ ì°¸ê³ )
steps:
  # Step 1: Command Record ìƒì„±
  - name: "Generate Command Record"
    description: "IdemKeyë¥¼ í¬í•¨í•œ Command Record íŒ¨í„´ ìƒì„±"
    reference_rule: ".windsurf/rules/09-orchestration-layer.md"
    reference_template: ".windsurf/templates/orchestration/command.java"
    output:
      path: "application/src/main/java/com/ryuqq/application/{domain_lower}/command/{Domain}Command.java"
      pattern: "Record íŒ¨í„´"
      checklist:
        - "Record í‚¤ì›Œë“œ ì‚¬ìš© (Lombok ê¸ˆì§€)"
        - "Compact Constructor ê²€ì¦ (Objects.requireNonNull)"
        - "Javadoc ì‘ì„± (@author, @since)"
        - "IdemKey í•„ë“œ í¬í•¨ (String idempotencyKey)"
    validation:
      - "Lombok ì–´ë…¸í…Œì´ì…˜ ì—†ìŒ (@Data, @Builder ë“±)"
      - "Compact Constructorì— null ì²´í¬"
      - "@author, @since ì¡´ì¬"

  # Step 2: Orchestrator ìŠ¤ì¼ˆë ˆí†¤ ìƒì„±
  - name: "Generate Orchestrator Skeleton"
    description: "BaseOrchestratorë¥¼ ìƒì†í•œ Orchestrator ìŠ¤ì¼ˆë ˆí†¤ ìƒì„±"
    reference_rule: ".windsurf/rules/09-orchestration-layer.md"
    reference_template: ".windsurf/templates/orchestration/orchestrator.java"
    output:
      path: "application/src/main/java/com/ryuqq/application/{domain_lower}/{Domain}Orchestrator.java"
      pattern: "BaseOrchestrator ìƒì†"
      checklist:
        - "BaseOrchestrator<{Domain}Command> ìƒì†"
        - "domain(), eventType() ì˜¤ë²„ë¼ì´ë“œ"
        - "executeInternal() @Async ì„ ì–¸"
        - "Retry ì „ëµ êµ¬í˜„ (calculateBackoff)"
        - "Error ë¶„ë¥˜ (TransientException vs PermanentException)"
        - "Dependencies ì£¼ì… (ExternalApiClient ë“±)"
    developer_todo:
      - "executeInternal() ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ êµ¬í˜„ í•„ìš”"
      - "ì™¸ë¶€ API í˜¸ì¶œ ì½”ë“œ ì‘ì„±"
      - "Outcome ë°˜í™˜ ë¡œì§ ì‘ì„± (Ok/Retry/Fail)"
    validation:
      - "executeInternal()ì— @Async ì¡´ì¬"
      - "executeInternal()ì— @Transactional ì—†ìŒ"
      - "domain(), eventType() ë©”ì„œë“œ ì¡´ì¬"

  # Step 3: Entities ìƒì„±
  - name: "Generate Entities"
    description: "Operation, WriteAheadLog ì—”í‹°í‹° ìƒì„±"
    reference_rule: ".windsurf/rules/09-orchestration-layer.md"
    reference_template: ".windsurf/templates/orchestration/entities/"
    outputs:
      - path: "adapter-out/persistence-mysql/src/main/java/com/ryuqq/adapter/out/persistence/{domain_lower}/entity/{Domain}OperationEntity.java"
        pattern: "JPA Entity"
        checklist:
          - "@Entity, @Table ì–´ë…¸í…Œì´ì…˜"
          - "IdemKey Unique ì œì•½ (@Table(uniqueConstraints = ...))"
          - "Long FK ì „ëµ (ê´€ê³„ ì–´ë…¸í…Œì´ì…˜ ê¸ˆì§€)"
          - "Javadoc ì‘ì„±"
      - path: "adapter-out/persistence-mysql/src/main/java/com/ryuqq/adapter/out/persistence/{domain_lower}/entity/{Domain}WriteAheadLogEntity.java"
        pattern: "JPA Entity"
        checklist:
          - "@Entity, @Table ì–´ë…¸í…Œì´ì…˜"
          - "opId ì™¸ë˜í‚¤ (Long íƒ€ì…)"
          - "state ì»¬ëŸ¼ (PENDING/COMPLETED)"
          - "ì¸ë±ìŠ¤ ì •ì˜ (@Table(indexes = ...))"
    validation:
      - "JPA ê´€ê³„ ì–´ë…¸í…Œì´ì…˜ ì—†ìŒ (@ManyToOne, @OneToMany ë“±)"
      - "IdemKeyì— Unique ì œì•½ ì¡´ì¬"

  # Step 4: Repositories ìƒì„±
  - name: "Generate Repositories"
    description: "OperationRepository, WriteAheadLogRepository ìƒì„±"
    reference_rule: ".windsurf/rules/09-orchestration-layer.md"
    reference_template: ".windsurf/templates/orchestration/repositories/"
    outputs:
      - path: "adapter-out/persistence-mysql/src/main/java/com/ryuqq/adapter/out/persistence/{domain_lower}/repository/{Domain}OperationRepository.java"
        pattern: "JpaRepository ìƒì†"
        checklist:
          - "JpaRepository<{Domain}OperationEntity, String> ìƒì†"
          - "findByIdemKey() ë©”ì„œë“œ"
          - "updateState() ë©”ì„œë“œ"
      - path: "adapter-out/persistence-mysql/src/main/java/com/ryuqq/adapter/out/persistence/{domain_lower}/repository/{Domain}WriteAheadLogRepository.java"
        pattern: "JpaRepository ìƒì†"
        checklist:
          - "JpaRepository<{Domain}WriteAheadLogEntity, Long> ìƒì†"
          - "findByState() ë©”ì„œë“œ"
          - "markCompleted() ë©”ì„œë“œ"
    validation:
      - "JpaRepository ìƒì† í™•ì¸"
      - "Query ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ ì •í™•ì„±"

  # Step 5: Schedulers ìƒì„±
  - name: "Generate Schedulers"
    description: "Finalizer, Reaper ìŠ¤ì¼€ì¤„ëŸ¬ ìƒì„±"
    reference_rule: ".windsurf/rules/09-orchestration-layer.md"
    reference_template: ".windsurf/templates/orchestration/schedulers/"
    outputs:
      - path: "application/src/main/java/com/ryuqq/application/{domain_lower}/scheduler/{Domain}Finalizer.java"
        pattern: "@Scheduled Finalizer"
        checklist:
          - "@Component ì–´ë…¸í…Œì´ì…˜"
          - "@Scheduled(fixedDelay = 5000)"
          - "processPendingWal() ë©”ì„œë“œ"
          - "PENDING WAL ì¡°íšŒ ë° ì²˜ë¦¬ ë¡œì§"
      - path: "application/src/main/java/com/ryuqq/application/{domain_lower}/scheduler/{Domain}Reaper.java"
        pattern: "@Scheduled Reaper"
        checklist:
          - "@Component ì–´ë…¸í…Œì´ì…˜"
          - "@Scheduled(fixedDelay = 10000)"
          - "processTimeoutOperations() ë©”ì„œë“œ"
          - "MAX_ATTEMPTS ì´ˆê³¼ ì²˜ë¦¬ ë¡œì§"
    validation:
      - "@Scheduled ì–´ë…¸í…Œì´ì…˜ ì¡´ì¬"
      - "fixedDelay ê°’ ì ì ˆì„±"

  # Step 6: Controller ìŠ¤ì¼ˆë ˆí†¤ ìƒì„±
  - name: "Generate Controller Skeleton"
    description: "REST API ì—”ë“œí¬ì¸íŠ¸ ìŠ¤ì¼ˆë ˆí†¤ ìƒì„±"
    reference_rule: ".windsurf/rules/09-orchestration-layer.md"
    reference_template: ".windsurf/templates/orchestration/controller.java"
    output:
      path: "adapter-in/adapter-in-web/src/main/java/com/ryuqq/adapter/in/web/{domain_lower}/{Domain}Controller.java"
      pattern: "@RestController"
      checklist:
        - "@RestController, @RequestMapping ì–´ë…¸í…Œì´ì…˜"
        - "POST ì—”ë“œí¬ì¸íŠ¸ (ë©±ë“±ì„± ë³´ì¥)"
        - "202 Accepted ì‘ë‹µ (ë¹„ë™ê¸° ì²˜ë¦¬)"
        - "Outcome â†’ Response DTO ë§¤í•‘"
    developer_todo:
      - "Response DTO ë§¤í•‘ ë¡œì§ êµ¬í˜„"
      - "ì—ëŸ¬ í•¸ë“¤ë§ ì¶”ê°€"
    validation:
      - "POST ë©”ì„œë“œë§Œ ì¡´ì¬"
      - "ResponseEntity ë°˜í™˜ íƒ€ì…"

  # Step 7: Tests ìƒì„±
  - name: "Generate Tests"
    description: "Orchestration Pattern í…ŒìŠ¤íŠ¸ ìƒì„±"
    reference_rule: ".windsurf/rules/09-orchestration-layer.md"
    reference_template: ".windsurf/templates/orchestration/tests/"
    outputs:
      - path: "application/src/test/java/com/ryuqq/application/{domain_lower}/{Domain}OrchestratorTest.java"
        pattern: "Unit Test"
        checklist:
          - "Idempotency í…ŒìŠ¤íŠ¸ (ë™ì¼ IdemKey ì¬ìš”ì²­)"
          - "Retry í…ŒìŠ¤íŠ¸ (ì¼ì‹œì  ì˜¤ë¥˜)"
          - "Fail í…ŒìŠ¤íŠ¸ (ì˜êµ¬ì  ì˜¤ë¥˜)"
          - "@MockBean ì‚¬ìš©"
      - path: "bootstrap/bootstrap-web-api/src/test/java/com/ryuqq/bootstrap/integration/{domain_lower}/{Domain}IntegrationTest.java"
        pattern: "Integration Test"
        checklist:
          - "@SpringBootTest ì–´ë…¸í…Œì´ì…˜"
          - "WAL í…ŒìŠ¤íŠ¸ (Crash Recovery)"
          - "Timeout í…ŒìŠ¤íŠ¸ (Reaper)"
          - "Race Condition í…ŒìŠ¤íŠ¸ (ë™ì‹œ ìš”ì²­)"
    developer_todo:
      - "ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë³„ ì—£ì§€ ì¼€ì´ìŠ¤ ì¶”ê°€"
    validation:
      - "@Test ì–´ë…¸í…Œì´ì…˜ ì¡´ì¬"
      - "Assert êµ¬ë¬¸ ì¡´ì¬"

# Post-generation ë‹¨ê³„
post_steps:
  - name: "Validation"
    description: "ìƒì„±ëœ ì½”ë“œ ê²€ì¦"
    actions:
      - "validation-helper.py ì‹¤í–‰"
      - "Lombok ì‚¬ìš© ì—¬ë¶€ í™•ì¸"
      - "@Transactional + @Async ì¶©ëŒ í™•ì¸"
      - "IdemKey Unique ì œì•½ í™•ì¸"

  - name: "Display TODO"
    description: "ê°œë°œìê°€ êµ¬í˜„í•´ì•¼ í•  TODO í‘œì‹œ"
    output: |
      âœ… Boilerplate ìƒì„± ì™„ë£Œ!

      ğŸ“ ê°œë°œì TODO:
      1. {Domain}Orchestrator.executeInternal() êµ¬í˜„
         - ì™¸ë¶€ API í˜¸ì¶œ ì½”ë“œ ì‘ì„±
         - Outcome ë°˜í™˜ ë¡œì§ ì‘ì„± (Ok/Retry/Fail)

      2. {Domain}Controller Response DTO ë§¤í•‘
         - Outcome â†’ Response DTO ë³€í™˜

      3. Tests ì—£ì§€ ì¼€ì´ìŠ¤ ì¶”ê°€
         - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë³„ íŠ¹ìˆ˜ ì¼€ì´ìŠ¤

      4. ê²€ì¦ ì‹¤í–‰
         ./gradlew test
         /validate-architecture

# ì—ëŸ¬ ì²˜ë¦¬
error_handling:
  - condition: "íŒŒì¼ ì´ë¯¸ ì¡´ì¬"
    action: "ì‚¬ìš©ìì—ê²Œ ë®ì–´ì“°ê¸° ì—¬ë¶€ í™•ì¸"

  - condition: "íŒ¨í‚¤ì§€ êµ¬ì¡° ë¶ˆì¼ì¹˜"
    action: "í”„ë¡œì íŠ¸ êµ¬ì¡° ë¶„ì„ í›„ ì˜¬ë°”ë¥¸ ê²½ë¡œ ì¶”ì²œ"

  - condition: "ê²€ì¦ ì‹¤íŒ¨"
    action: "ìƒì„±ëœ íŒŒì¼ ë¡¤ë°±, ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ"

# ì„±ê³µ ë©”íŠ¸ë¦­
success_metrics:
  automation_rate: "80-85%"
  expected_time: "5-10ë¶„ (ê¸°ì¡´ 2-3ì‹œê°„ ëŒ€ë¹„ 70-80% ë‹¨ì¶•)"
  convention_compliance: "90-95%"
  developer_intervention_required:
    - "executeInternal() ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (15-20ë¶„)"
    - "Response DTO ë§¤í•‘ (5ë¶„)"
    - "ì—£ì§€ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸ (10ë¶„)"

# ì°¸ê³  ë¬¸ì„œ
references:
  rules: ".windsurf/rules/09-orchestration-layer.md"
  templates: ".windsurf/templates/orchestration/"
  documentation: "docs/coding_convention/09-orchestration-patterns/"
  examples: "docs/coding_convention/09-orchestration-patterns/05_quick-start-guide.md"
