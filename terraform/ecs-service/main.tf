# ============================================================================
# FILEFLOW - ECS Service
# ============================================================================
# Generated by Infrastructure Wizard
# Service: fileflow
# Environment: prod
# ============================================================================

# CloudWatch Log Group
module "fileflow_logs" {
  source = "../modules/cloudwatch-log-group"

  name              = local.log_group_name
  retention_in_days = local.log_retention_days
  kms_key_id        = data.aws_kms_key.cloudwatch_logs.arn

  # Required tags
  environment = local.environment
  service     = local.service_name
  team        = "platform-team"
  owner       = "platform-team@example.com"
  cost_center = "engineering"
  project     = "fileflow"
}

# Security Group for ECS Tasks
resource "aws_security_group" "fileflow" {
  name_prefix = "${local.name_prefix}-ecs-"
  description = "Security group for fileflow ECS tasks"
  vpc_id      = local.vpc_id

  # Egress: Allow all outbound traffic
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Allow all outbound traffic"
  }

  # Ingress: Allow traffic from ALB
  ingress {
    from_port       = local.container_port
    to_port         = local.container_port
    protocol        = "tcp"
    security_groups = [aws_security_group.fileflow_alb.id]
    description     = "Allow traffic from ALB"
  }

  tags = merge(
    local.required_tags,
    {
      Name      = "sg-${local.name_prefix}-ecs"
      Component = "security"
    }
  )

  lifecycle {
    create_before_destroy = true
  }
}

# IAM Role for ECS Task Execution
resource "aws_iam_role" "fileflow_execution_role" {
  name = "${local.name_prefix}-ecs-execution-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole"
      Effect = "Allow"
      Principal = {
        Service = "ecs-tasks.amazonaws.com"
      }
    }]
  })

  tags = local.required_tags
}

resource "aws_iam_role_policy_attachment" "fileflow_execution_role_policy" {
  role       = aws_iam_role.fileflow_execution_role.name
  policy_arn = "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
}

# Additional policy for ECR access
resource "aws_iam_role_policy" "fileflow_ecr_access" {
  name = "${local.name_prefix}-ecr-access"
  role = aws_iam_role.fileflow_execution_role.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "ecr:GetAuthorizationToken",
          "ecr:BatchCheckLayerAvailability",
          "ecr:GetDownloadUrlForLayer",
          "ecr:BatchGetImage"
        ]
        Resource = "*"
      }
    ]
  })
}

# Additional policy for Secrets Manager access
resource "aws_iam_role_policy" "fileflow_secrets_access" {
  name = "${local.name_prefix}-secrets-access"
  role = aws_iam_role.fileflow_execution_role.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "secretsmanager:GetSecretValue"
        ]
        Resource = [
          "arn:aws:secretsmanager:ap-northeast-2:646886795421:secret:prod-shared-mysql-master-password-*"
        ]
      },
      {
        Effect = "Allow"
        Action = [
          "kms:Decrypt"
        ]
        Resource = data.aws_kms_key.ecs_secrets.arn
      }
    ]
  })
}

# IAM Role for ECS Task
resource "aws_iam_role" "fileflow_task_role" {
  name = "${local.name_prefix}-ecs-task-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole"
      Effect = "Allow"
      Principal = {
        Service = "ecs-tasks.amazonaws.com"
      }
    }]
  })

  tags = local.required_tags
}

# ECS Service
module "fileflow_service" {
  source = "../modules/ecs-service"

  # Required variables
  name               = local.service_name
  cluster_id         = aws_ecs_cluster.fileflow.id
  container_name     = local.container_name
  container_port     = local.container_port
  container_image    = local.ecr_image_uri
  cpu                = 1024
  memory             = 2048
  desired_count      = 1
  execution_role_arn = aws_iam_role.fileflow_execution_role.arn
  task_role_arn      = aws_iam_role.fileflow_task_role.arn
  subnet_ids         = local.private_subnet_ids
  common_tags        = local.required_tags

  # Security groups
  security_group_ids = [aws_security_group.fileflow.id]

  # CloudWatch Logs
  log_configuration = {
    log_driver = "awslogs"
    options = {
      "awslogs-group"         = module.fileflow_logs.log_group_name
      "awslogs-region"        = "ap-northeast-2"
      "awslogs-stream-prefix" = "ecs"
    }
  }

  # Load Balancer Configuration
  load_balancer_config = {
    target_group_arn = module.fileflow_alb.target_group_arns["fileflow"]
    container_name   = local.container_name
    container_port   = local.container_port
  }

  # Environment Variables
  container_environment = [
    {
      name  = "ENVIRONMENT"
      value = local.environment
    },
    {
      name  = "SERVICE_NAME"
      value = local.service_name
    },
    {
      name  = "SPRING_PROFILES_ACTIVE"
      value = "prod"
    },
    {
      name  = "DB_HOST"
      value = local.db_address
    },
    {
      name  = "DB_PORT"
      value = tostring(local.db_port)
    },
    {
      name  = "DB_NAME"
      value = "fileflow"
    },
    {
      name  = "DB_USER"
      value = "admin"
    },
    {
      name  = "FLYWAY_ENABLED"
      value = "true"
    },
    {
      name  = "FLYWAY_BASELINE_ON_MIGRATE"
      value = "true"
    },
    {
      name  = "REDIS_HOST"
      value = local.redis_endpoint
    },
    {
      name  = "REDIS_PORT"
      value = tostring(local.redis_port)
    }
  ]

  # Secrets (injected at runtime)
  container_secrets = [
    {
      name      = "DB_PASSWORD"
      valueFrom = "${data.aws_secretsmanager_secret_version.db_password.arn}:password::"
    }
  ]

  depends_on = [
    module.fileflow_logs,
    aws_iam_role_policy_attachment.fileflow_execution_role_policy
  ]
}

# ============================================================================
# Download Scheduler Service
# ============================================================================

# CloudWatch Log Group for Download Scheduler
module "download_scheduler_logs" {
  source = "../modules/cloudwatch-log-group"

  name              = "/aws/ecs/${local.service_name}-scheduler-download"
  retention_in_days = local.log_retention_days
  kms_key_id        = data.aws_kms_key.cloudwatch_logs.arn

  environment = local.environment
  service     = "${local.service_name}-scheduler-download"
  team        = "platform-team"
  owner       = "platform-team@example.com"
  cost_center = "engineering"
  project     = "fileflow"
}

# Security Group for Download Scheduler
resource "aws_security_group" "download_scheduler" {
  name_prefix = "${local.name_prefix}-scheduler-download-"
  description = "Security group for fileflow download scheduler tasks"
  vpc_id      = local.vpc_id

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Allow all outbound traffic"
  }

  tags = merge(
    local.required_tags,
    {
      Name      = "sg-${local.name_prefix}-scheduler-download"
      Component = "security"
    }
  )

  lifecycle {
    create_before_destroy = true
  }
}

# Download Scheduler ECS Service
module "download_scheduler_service" {
  source = "../modules/ecs-service"

  name               = "${local.service_name}-scheduler-download"
  cluster_id         = aws_ecs_cluster.fileflow.id
  container_name     = "fileflow-scheduler-download"
  container_port     = 9091 # Actuator port
  container_image    = "${local.ecr_image_uri}-download-scheduler"
  cpu                = 512
  memory             = 1024
  desired_count      = 1 # 스케줄러는 항상 1개만
  execution_role_arn = aws_iam_role.fileflow_execution_role.arn
  task_role_arn      = aws_iam_role.fileflow_task_role.arn
  subnet_ids         = local.private_subnet_ids
  common_tags        = local.required_tags

  security_group_ids = [aws_security_group.download_scheduler.id]

  log_configuration = {
    log_driver = "awslogs"
    options = {
      "awslogs-group"         = module.download_scheduler_logs.log_group_name
      "awslogs-region"        = "ap-northeast-2"
      "awslogs-stream-prefix" = "download-scheduler"
    }
  }

  # No Load Balancer for scheduler
  load_balancer_config = null

  container_environment = [
    {
      name  = "SPRING_PROFILES_ACTIVE"
      value = "prod"
    },
    {
      name  = "DOWNLOAD_DB_HOST"
      value = local.db_address
    },
    {
      name  = "DOWNLOAD_DB_PORT"
      value = tostring(local.db_port)
    },
    {
      name  = "DOWNLOAD_DB_USERNAME"
      value = "admin"
    },
    {
      name  = "REDIS_HOST"
      value = local.redis_endpoint
    },
    {
      name  = "REDIS_PORT"
      value = tostring(local.redis_port)
    },
    {
      name  = "AWS_REGION"
      value = "ap-northeast-2"
    },
    {
      name  = "AWS_S3_BUCKET"
      value = "fileflow-prod"
    },
    {
      name  = "AWS_CLOUDWATCH_LOG_GROUP"
      value = module.download_scheduler_logs.log_group_name
    },
    {
      name  = "ACTUATOR_PORT"
      value = "9091"
    }
  ]

  container_secrets = [
    {
      name      = "DOWNLOAD_DB_PASSWORD"
      valueFrom = "${data.aws_secretsmanager_secret_version.db_password.arn}:password::"
    }
  ]

  depends_on = [
    module.download_scheduler_logs,
    aws_iam_role_policy_attachment.fileflow_execution_role_policy
  ]
}

# ============================================================================
# Pipeline Scheduler Service
# ============================================================================

# CloudWatch Log Group for Pipeline Scheduler
module "pipeline_scheduler_logs" {
  source = "../modules/cloudwatch-log-group"

  name              = "/aws/ecs/${local.service_name}-scheduler-pipeline"
  retention_in_days = local.log_retention_days
  kms_key_id        = data.aws_kms_key.cloudwatch_logs.arn

  environment = local.environment
  service     = "${local.service_name}-scheduler-pipeline"
  team        = "platform-team"
  owner       = "platform-team@example.com"
  cost_center = "engineering"
  project     = "fileflow"
}

# Security Group for Pipeline Scheduler
resource "aws_security_group" "pipeline_scheduler" {
  name_prefix = "${local.name_prefix}-scheduler-pipeline-"
  description = "Security group for fileflow pipeline scheduler tasks"
  vpc_id      = local.vpc_id

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Allow all outbound traffic"
  }

  tags = merge(
    local.required_tags,
    {
      Name      = "sg-${local.name_prefix}-scheduler-pipeline"
      Component = "security"
    }
  )

  lifecycle {
    create_before_destroy = true
  }
}

# Pipeline Scheduler ECS Service
module "pipeline_scheduler_service" {
  source = "../modules/ecs-service"

  name               = "${local.service_name}-scheduler-pipeline"
  cluster_id         = aws_ecs_cluster.fileflow.id
  container_name     = "fileflow-scheduler-pipeline"
  container_port     = 9092 # Actuator port
  container_image    = "${local.ecr_image_uri}-pipeline-scheduler"
  cpu                = 512
  memory             = 1024
  desired_count      = 1 # 스케줄러는 항상 1개만
  execution_role_arn = aws_iam_role.fileflow_execution_role.arn
  task_role_arn      = aws_iam_role.fileflow_task_role.arn
  subnet_ids         = local.private_subnet_ids
  common_tags        = local.required_tags

  security_group_ids = [aws_security_group.pipeline_scheduler.id]

  log_configuration = {
    log_driver = "awslogs"
    options = {
      "awslogs-group"         = module.pipeline_scheduler_logs.log_group_name
      "awslogs-region"        = "ap-northeast-2"
      "awslogs-stream-prefix" = "pipeline-scheduler"
    }
  }

  # No Load Balancer for scheduler
  load_balancer_config = null

  container_environment = [
    {
      name  = "SPRING_PROFILES_ACTIVE"
      value = "prod"
    },
    {
      name  = "PIPELINE_DB_HOST"
      value = local.db_address
    },
    {
      name  = "PIPELINE_DB_PORT"
      value = tostring(local.db_port)
    },
    {
      name  = "PIPELINE_DB_USERNAME"
      value = "admin"
    },
    {
      name  = "REDIS_HOST"
      value = local.redis_endpoint
    },
    {
      name  = "REDIS_PORT"
      value = tostring(local.redis_port)
    },
    {
      name  = "AWS_REGION"
      value = "ap-northeast-2"
    },
    {
      name  = "AWS_S3_BUCKET"
      value = "fileflow-prod"
    },
    {
      name  = "AWS_CLOUDWATCH_LOG_GROUP"
      value = module.pipeline_scheduler_logs.log_group_name
    },
    {
      name  = "ACTUATOR_PORT"
      value = "9092"
    }
  ]

  container_secrets = [
    {
      name      = "PIPELINE_DB_PASSWORD"
      valueFrom = "${data.aws_secretsmanager_secret_version.db_password.arn}:password::"
    }
  ]

  depends_on = [
    module.pipeline_scheduler_logs,
    aws_iam_role_policy_attachment.fileflow_execution_role_policy
  ]
}

# ============================================================================
# Upload Scheduler Service
# ============================================================================

# CloudWatch Log Group for Upload Scheduler
module "upload_scheduler_logs" {
  source = "../modules/cloudwatch-log-group"

  name              = "/aws/ecs/${local.service_name}-scheduler-upload"
  retention_in_days = local.log_retention_days
  kms_key_id        = data.aws_kms_key.cloudwatch_logs.arn

  environment = local.environment
  service     = "${local.service_name}-scheduler-upload"
  team        = "platform-team"
  owner       = "platform-team@example.com"
  cost_center = "engineering"
  project     = "fileflow"
}

# Security Group for Upload Scheduler
resource "aws_security_group" "upload_scheduler" {
  name_prefix = "${local.name_prefix}-scheduler-upload-"
  description = "Security group for fileflow upload scheduler tasks"
  vpc_id      = local.vpc_id

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Allow all outbound traffic"
  }

  tags = merge(
    local.required_tags,
    {
      Name      = "sg-${local.name_prefix}-scheduler-upload"
      Component = "security"
    }
  )

  lifecycle {
    create_before_destroy = true
  }
}

# Upload Scheduler ECS Service
module "upload_scheduler_service" {
  source = "../modules/ecs-service"

  name               = "${local.service_name}-scheduler-upload"
  cluster_id         = aws_ecs_cluster.fileflow.id
  container_name     = "fileflow-scheduler-upload"
  container_port     = 9093 # Actuator port
  container_image    = "${local.ecr_image_uri}-upload-scheduler"
  cpu                = 512
  memory             = 1024
  desired_count      = 1 # 스케줄러는 항상 1개만
  execution_role_arn = aws_iam_role.fileflow_execution_role.arn
  task_role_arn      = aws_iam_role.fileflow_task_role.arn
  subnet_ids         = local.private_subnet_ids
  common_tags        = local.required_tags

  security_group_ids = [aws_security_group.upload_scheduler.id]

  log_configuration = {
    log_driver = "awslogs"
    options = {
      "awslogs-group"         = module.upload_scheduler_logs.log_group_name
      "awslogs-region"        = "ap-northeast-2"
      "awslogs-stream-prefix" = "upload-scheduler"
    }
  }

  # No Load Balancer for scheduler
  load_balancer_config = null

  container_environment = [
    {
      name  = "SPRING_PROFILES_ACTIVE"
      value = "prod"
    },
    {
      name  = "UPLOAD_DB_HOST"
      value = local.db_address
    },
    {
      name  = "UPLOAD_DB_PORT"
      value = tostring(local.db_port)
    },
    {
      name  = "UPLOAD_DB_USERNAME"
      value = "admin"
    },
    {
      name  = "REDIS_HOST"
      value = local.redis_endpoint
    },
    {
      name  = "REDIS_PORT"
      value = tostring(local.redis_port)
    },
    {
      name  = "AWS_REGION"
      value = "ap-northeast-2"
    },
    {
      name  = "AWS_S3_BUCKET"
      value = "fileflow-prod"
    },
    {
      name  = "AWS_CLOUDWATCH_LOG_GROUP"
      value = module.upload_scheduler_logs.log_group_name
    },
    {
      name  = "ACTUATOR_PORT"
      value = "9093"
    },
    {
      name  = "BATCH_CLEANUP_CRON"
      value = "0 0 2 * * *" # 매일 새벽 2시
    },
    {
      name  = "BATCH_PENDING_EXPIRATION_MINUTES"
      value = "30"
    },
    {
      name  = "BATCH_IN_PROGRESS_EXPIRATION_HOURS"
      value = "24"
    }
  ]

  container_secrets = [
    {
      name      = "UPLOAD_DB_PASSWORD"
      valueFrom = "${data.aws_secretsmanager_secret_version.db_password.arn}:password::"
    }
  ]

  depends_on = [
    module.upload_scheduler_logs,
    aws_iam_role_policy_attachment.fileflow_execution_role_policy
  ]
}
