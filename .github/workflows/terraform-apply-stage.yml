# ============================================================================
# FileFlow - Terraform Apply (Stage)
# ============================================================================
# ìŠ¤í…Œì´ì§€ í™˜ê²½ ì¸í”„ë¼ í”„ë¡œë¹„ì €ë‹ ë° Image Tag ì—…ë°ì´íŠ¸
# deploy-stage.ymlì—ì„œ ìžë™ í˜¸ì¶œ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
#
# ëª¨ë“ˆ ìˆœì„œ: ecr â†’ s3 â†’ sqs â†’ ecs-cluster â†’ ecs-web-api â†’ ecs-download-worker
#            â†’ ecs-resizing-worker â†’ ecs-scheduler
# ============================================================================

name: Terraform Apply (Stage)

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      web-api-image-tag:
        description: 'Web API Docker image tag (e.g., web-api-stage-1-abc1234)'
        required: false
        type: string
      download-worker-image-tag:
        description: 'Download Worker Docker image tag'
        required: false
        type: string
      scheduler-image-tag:
        description: 'Scheduler Docker image tag'
        required: false
        type: string
      resizing-worker-image-tag:
        description: 'Resizing Worker Docker image tag'
        required: false
        type: string
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  contents: read
  id-token: write

jobs:
  terraform-apply:
    name: Terraform Apply (Stage)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      # ìˆœì°¨ ì‹¤í–‰ (ì˜ì¡´ì„± ìˆœì„œ)
      max-parallel: 1
      matrix:
        module:
          - name: ecr
            dir: terraform/environments/stage/ecr
            order: 0
          - name: s3
            dir: terraform/environments/stage/s3
            order: 1
          - name: sqs
            dir: terraform/environments/stage/sqs
            order: 2
          - name: ecs-cluster
            dir: terraform/environments/stage/ecs-cluster
            order: 3
          - name: ecs-web-api
            dir: terraform/environments/stage/ecs-web-api
            order: 4
          - name: ecs-download-worker
            dir: terraform/environments/stage/ecs-download-worker
            order: 5
          - name: ecs-resizing-worker
            dir: terraform/environments/stage/ecs-resizing-worker
            order: 6
          - name: ecs-scheduler
            dir: terraform/environments/stage/ecs-scheduler
            order: 7

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2
          role-duration-seconds: 3600
          role-session-name: GitHubActions-FileFlow-TerraformApply-Stage

      - name: Terraform Init - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: terraform init -reconfigure

      - name: Terraform Apply - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "ðŸš€ Applying Terraform for ${{ matrix.module.name }} (stage)..."

          EXTRA_VARS=""

          if [ "${{ matrix.module.name }}" == "ecs-web-api" ] && [ -n "${{ inputs.web-api-image-tag }}" ]; then
            echo "ðŸ“¦ Using Web API image tag: ${{ inputs.web-api-image-tag }}"
            EXTRA_VARS="-var=image_tag=${{ inputs.web-api-image-tag }}"
          elif [ "${{ matrix.module.name }}" == "ecs-download-worker" ] && [ -n "${{ inputs.download-worker-image-tag }}" ]; then
            echo "ðŸ“¦ Using Download Worker image tag: ${{ inputs.download-worker-image-tag }}"
            EXTRA_VARS="-var=image_tag=${{ inputs.download-worker-image-tag }}"
          elif [ "${{ matrix.module.name }}" == "ecs-scheduler" ] && [ -n "${{ inputs.scheduler-image-tag }}" ]; then
            echo "ðŸ“¦ Using Scheduler image tag: ${{ inputs.scheduler-image-tag }}"
            EXTRA_VARS="-var=image_tag=${{ inputs.scheduler-image-tag }}"
          elif [ "${{ matrix.module.name }}" == "ecs-resizing-worker" ] && [ -n "${{ inputs.resizing-worker-image-tag }}" ]; then
            echo "ðŸ“¦ Using Resizing Worker image tag: ${{ inputs.resizing-worker-image-tag }}"
            EXTRA_VARS="-var=image_tag=${{ inputs.resizing-worker-image-tag }}"
          else
            echo "â„¹ï¸  No image tag provided for ${{ matrix.module.name }}, using default from provider.tf"
          fi

          echo "ðŸ“‹ Generating terraform plan..."
          terraform plan $EXTRA_VARS -out=tfplan

          terraform apply -auto-approve -no-color tfplan
          echo "âœ… Apply completed for ${{ matrix.module.name }}"

      - name: Terraform Output - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "ðŸ“‹ Outputs for ${{ matrix.module.name }}:"
          terraform output -json > outputs-${{ matrix.module.name }}.json
          terraform output

      - name: Upload Apply Results - ${{ matrix.module.name }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apply-results-stage-${{ matrix.module.name }}
          path: ${{ matrix.module.dir }}/outputs-${{ matrix.module.name }}.json
          retention-days: 30

  notify-completion:
    name: Notify Stage Infra Deployment
    needs: terraform-apply
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Create Deployment Summary
        run: |
          echo "## ðŸŽ‰ FileFlow Infrastructure Deployment (Stage)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ needs.terraform-apply.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Stage" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Modules Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- ECR Repository (stage)" >> $GITHUB_STEP_SUMMARY
          echo "- S3 Bucket (stage)" >> $GITHUB_STEP_SUMMARY
          echo "- SQS Queues (stage)" >> $GITHUB_STEP_SUMMARY
          echo "- ECS Cluster (stage)" >> $GITHUB_STEP_SUMMARY
          echo "- ECS Web API (stage)" >> $GITHUB_STEP_SUMMARY
          echo "- ECS Download Worker (stage)" >> $GITHUB_STEP_SUMMARY
          echo "- ECS Resizing Worker (stage)" >> $GITHUB_STEP_SUMMARY
          echo "- ECS Scheduler (stage)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service Discovery" >> $GITHUB_STEP_SUMMARY
          echo "- web-api-stage.connectly.local" >> $GITHUB_STEP_SUMMARY
