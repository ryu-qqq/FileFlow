# ============================================================================
# FileFlow Build & Deploy
#
# Reusable Workflows 사용하여 단순화
# 기존 600줄 → 약 100줄로 단순화
# ============================================================================

name: Build and Deploy to ECS

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
      - '**.md'
      - 'docs/**'

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: fileflow-cluster-prod

jobs:
  # ============================================================================
  # 빌드 Jobs (병렬 실행)
  # ============================================================================
  build-web-api:
    name: Build web-api
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: fileflow-web-api-prod
      component: web-api
      dockerfile: bootstrap/bootstrap-web-api/Dockerfile
      gradle-task: ":bootstrap:bootstrap-web-api:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-scheduler:
    name: Build scheduler
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: fileflow-scheduler-prod
      component: scheduler
      dockerfile: bootstrap/bootstrap-scheduler/Dockerfile
      gradle-task: ":bootstrap:bootstrap-scheduler:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # 배포 Jobs (병렬 실행)
  # ============================================================================
  deploy-web-api:
    name: Deploy web-api
    needs: build-web-api
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: fileflow-cluster-prod
      ecs-service: fileflow-web-api-prod
      image-uri: ${{ needs.build-web-api.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-scheduler:
    name: Deploy scheduler
    needs: build-scheduler
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: fileflow-cluster-prod
      ecs-service: fileflow-scheduler-prod
      image-uri: ${{ needs.build-scheduler.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # 배포 완료 알림 (Slack + GitHub Summary)
  # ============================================================================
  notify:
    name: Deployment Notification
    needs: [build-web-api, build-scheduler, deploy-web-api, deploy-scheduler]
    if: always()
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-notify-slack.yml@main
    with:
      project-name: FileFlow
      environment: prod
      status: ${{ (needs.deploy-web-api.result == 'success' && needs.deploy-scheduler.result == 'success') && 'success' || 'failure' }}
      components: |
        [
          {"name": "web-api", "status": "${{ needs.deploy-web-api.result }}", "image": "${{ needs.build-web-api.outputs.image-tag || 'N/A' }}"},
          {"name": "scheduler", "status": "${{ needs.deploy-scheduler.result }}", "image": "${{ needs.build-scheduler.outputs.image-tag || 'N/A' }}"}
        ]
      mention-on-failure: "@here"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
