name: Terraform Apply

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'

permissions:
  contents: read
  id-token: write

jobs:
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      # ìˆœì°¨ ì‹¤í–‰ìœ¼ë¡œ ë³€ê²½ (ì˜ì¡´ì„± ê³ ë ¤)
      max-parallel: 1
      matrix:
        module:
          # ì˜ì¡´ì„± ìˆœì„œëŒ€ë¡œ ë°°ì¹˜
          - name: ecr
            dir: terraform/ecr
            order: 0
          - name: elasticache-redis
            dir: terraform/elasticache-redis
            order: 1
          - name: s3-bucket
            dir: terraform/s3-bucket
            order: 2
          - name: sqs-queue
            dir: terraform/sqs-queue
            order: 3
          - name: ecs-service
            dir: terraform/ecs-service
            order: 4

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2
          role-duration-seconds: 3600
          role-session-name: GitHubActions-FileFlow-TerraformApply

      - name: Terraform Init - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: terraform init

      - name: Check and Import Existing Resources - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "ðŸ” ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ í™•ì¸ ë° Import ì¤‘..."

          # Plan ì‹¤í–‰í•˜ì—¬ ì¶©ëŒ í™•ì¸
          set +e
          terraform plan -out=tfplan 2>&1 | tee plan_output.txt
          PLAN_EXIT_CODE=$?
          set -e

          # 409 ì—ëŸ¬ ë˜ëŠ” "already exists" íŒ¨í„´ í™•ì¸
          if grep -q "EntityAlreadyExists\|already exists" plan_output.txt; then
            echo "âš ï¸  ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ë°œê²¬! Import ìž‘ì—… ì‹œìž‘..."

            # ECS Service ëª¨ë“ˆ
            if [ "${{ matrix.module.name }}" == "ecs-service" ]; then
              echo "ðŸ“¦ ECS Service ë¦¬ì†ŒìŠ¤ Import ì¤‘..."

              # IAM Execution Role
              if aws iam get-role --role-name fileflow-prod-ecs-execution-role --region ap-northeast-2 >/dev/null 2>&1; then
                echo "  â†’ Importing fileflow-prod-ecs-execution-role..."
                terraform import -input=false aws_iam_role.fileflow_execution_role fileflow-prod-ecs-execution-role || echo "  âš ï¸  Import failed or already in state"
              fi

              # IAM Task Role
              if aws iam get-role --role-name fileflow-prod-ecs-task-role --region ap-northeast-2 >/dev/null 2>&1; then
                echo "  â†’ Importing fileflow-prod-ecs-task-role..."
                terraform import -input=false aws_iam_role.fileflow_task_role fileflow-prod-ecs-task-role || echo "  âš ï¸  Import failed or already in state"
              fi

              # ALB
              ALB_ARN=$(aws elbv2 describe-load-balancers --names fileflow-prod-alb --region ap-northeast-2 --query 'LoadBalancers[0].LoadBalancerArn' --output text 2>/dev/null || echo "")
              if [ -n "$ALB_ARN" ] && [ "$ALB_ARN" != "None" ]; then
                echo "  â†’ Importing ALB: $ALB_ARN"
                terraform import -input=false aws_lb.fileflow_alb "$ALB_ARN" || echo "  âš ï¸  Import failed or already in state"
              fi

              # Target Group
              TG_ARN=$(aws elbv2 describe-target-groups --names fileflow-prod-alb-fileflow --region ap-northeast-2 --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || echo "")
              if [ -n "$TG_ARN" ] && [ "$TG_ARN" != "None" ]; then
                echo "  â†’ Importing Target Group: $TG_ARN"
                terraform import -input=false aws_lb_target_group.fileflow "$TG_ARN" || echo "  âš ï¸  Import failed or already in state"
              fi
            fi

            # ElastiCache Redis ëª¨ë“ˆ
            if [ "${{ matrix.module.name }}" == "elasticache-redis" ]; then
              echo "ðŸ“¦ ElastiCache Redis ë¦¬ì†ŒìŠ¤ Import ì¤‘..."
              if aws elasticache describe-replication-groups --replication-group-id fileflow-prod-redis --region ap-northeast-2 >/dev/null 2>&1; then
                echo "  â†’ Importing fileflow-prod-redis..."
                terraform import -input=false aws_elasticache_replication_group.redis fileflow-prod-redis || echo "  âš ï¸  Import failed or already in state"
              fi
            fi

            # S3 Bucket ëª¨ë“ˆ
            if [ "${{ matrix.module.name }}" == "s3-bucket" ]; then
              echo "ðŸ“¦ S3 Bucket ë¦¬ì†ŒìŠ¤ Import ì¤‘..."
              BUCKET_NAME="fileflow--prod"
              if aws s3api head-bucket --bucket "$BUCKET_NAME" --region ap-northeast-2 >/dev/null 2>&1; then
                echo "  â†’ Importing $BUCKET_NAME..."
                terraform import -input=false aws_s3_bucket.main "$BUCKET_NAME" || echo "  âš ï¸  Import failed or already in state"
              fi
            fi

            # SQS Queue ëª¨ë“ˆ
            if [ "${{ matrix.module.name }}" == "sqs-queue" ]; then
              echo "ðŸ“¦ SQS Queue ë¦¬ì†ŒìŠ¤ Import ì¤‘..."
              QUEUE_URL=$(aws sqs get-queue-url --queue-name fileflow-prod-queue --region ap-northeast-2 --query 'QueueUrl' --output text 2>/dev/null || echo "")
              if [ -n "$QUEUE_URL" ] && [ "$QUEUE_URL" != "None" ]; then
                echo "  â†’ Importing fileflow-prod-queue..."
                terraform import -input=false aws_sqs_queue.main "$QUEUE_URL" || echo "  âš ï¸  Import failed or already in state"
              fi
            fi

            # ECR ëª¨ë“ˆ
            if [ "${{ matrix.module.name }}" == "ecr" ]; then
              echo "ðŸ“¦ ECR Repository ë¦¬ì†ŒìŠ¤ Import ì¤‘..."
              if aws ecr describe-repositories --repository-names fileflow-prod --region ap-northeast-2 >/dev/null 2>&1; then
                echo "  â†’ Importing fileflow-prod ECR repository..."
                terraform import -input=false aws_ecr_repository.fileflow fileflow-prod || echo "  âš ï¸  Import failed or already in state"
              fi
            fi

            echo "âœ… Import ì™„ë£Œ! Plan ìž¬ì‹¤í–‰..."
            terraform plan -out=tfplan
          else
            echo "âœ… ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì—†ìŒ ë˜ëŠ” Stateì™€ ì¼ì¹˜. ì •ìƒ ì§„í–‰."
          fi

          rm -f plan_output.txt

      - name: Terraform Apply - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "ðŸš€ Applying Terraform for ${{ matrix.module.name }}..."
          terraform apply -auto-approve -no-color tfplan
          echo "âœ… Apply completed for ${{ matrix.module.name }}"

      - name: Terraform Output - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "ðŸ“‹ Outputs for ${{ matrix.module.name }}:"
          terraform output -json > outputs-${{ matrix.module.name }}.json
          terraform output

      - name: Upload Apply Results - ${{ matrix.module.name }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apply-results-${{ matrix.module.name }}
          path: ${{ matrix.module.dir }}/outputs-${{ matrix.module.name }}.json
          retention-days: 30

  notify-completion:
    name: Notify Deployment Completion
    needs: terraform-apply
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Create Deployment Summary
        run: |
          echo "## ðŸŽ‰ FileFlow Infrastructure Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ needs.terraform-apply.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Modules Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECR Repository" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ElastiCache Redis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… S3 Bucket" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SQS Queue" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Service" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps**:" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify infrastructure in AWS Console" >> $GITHUB_STEP_SUMMARY
          echo "2. Check CloudWatch logs" >> $GITHUB_STEP_SUMMARY
          echo "3. Test application endpoints" >> $GITHUB_STEP_SUMMARY
