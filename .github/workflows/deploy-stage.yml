# ============================================================================
# FileFlow - Stage Build & Deploy
#
# Stage ÌôòÍ≤Ω Î∞∞Ìè¨ ÌååÏù¥ÌîÑÎùºÏù∏
# Ìä∏Î¶¨Í±∞: stage Î∏åÎûúÏπò push
#
# Ïª¥Ìè¨ÎÑåÌä∏: web-api, download-worker, resizing-worker, scheduler (Î≥ëÎ†¨ ÎπåÎìú/Î∞∞Ìè¨)
# Ïù∏ÌîÑÎùº: ECS Fargate + Service Discovery (ALB ÏóÜÏùå)
#
# Stage ÌôòÍ≤Ω ÌäπÏßï:
# - Production ÎØ∏Îü¨ ÌôòÍ≤Ω
# - Î≥ÄÍ≤Ω Í∞êÏßÄ(paths-filter)Î°ú Î≥ÄÍ≤ΩÎêú Ïª¥Ìè¨ÎÑåÌä∏Îßå ÎπåÎìú/Î∞∞Ìè¨
# - force-all ÏòµÏÖòÏúºÎ°ú Ï†ÑÏ≤¥ Í∞ïÏ†ú ÎπåÎìú Í∞ÄÎä•
# ============================================================================

name: Stage Build and Deploy

on:
  workflow_dispatch:
    inputs:
      force-all:
        description: 'Î™®Îì† ÏÑúÎπÑÏä§ Í∞ïÏ†ú ÎπåÎìú/Î∞∞Ìè¨'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - stage
    paths-ignore:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
      - '**.md'
      - 'docs/**'

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: fileflow-cluster-stage

jobs:
  # ============================================================================
  # Î≥ÄÍ≤Ω Í∞êÏßÄ (Path Filter)
  # ============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web-api: ${{ steps.filter.outputs.web-api }}
      download-worker: ${{ steps.filter.outputs.download-worker }}
      scheduler: ${{ steps.filter.outputs.scheduler }}
      resizing-worker: ${{ steps.filter.outputs.resizing-worker }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            shared:
              - 'gradle/**'
              - 'build.gradle'
              - 'settings.gradle'
              - 'gradle/libs.versions.toml'
              - 'domain/**'
              - 'application/**'
              - 'adapter-out/**'
            web-api:
              - 'bootstrap/bootstrap-web-api/**'
              - 'adapter-in/rest-api/**'
            download-worker:
              - 'bootstrap/bootstrap-download-worker/**'
              - 'adapter-in/sqs-consumer/**'
            scheduler:
              - 'bootstrap/bootstrap-scheduler/**'
              - 'adapter-in/scheduler/**'
            resizing-worker:
              - 'bootstrap/bootstrap-resizing-worker/**'
              - 'adapter-in/redis-consumer/**'

      - name: Summary
        run: |
          echo "### üîç Stage Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Shared (gradle/domain/app/adapter-out) | ${{ steps.filter.outputs.shared }} |" >> $GITHUB_STEP_SUMMARY
          echo "| web-api | ${{ steps.filter.outputs.web-api }} |" >> $GITHUB_STEP_SUMMARY
          echo "| download-worker | ${{ steps.filter.outputs.download-worker }} |" >> $GITHUB_STEP_SUMMARY
          echo "| scheduler | ${{ steps.filter.outputs.scheduler }} |" >> $GITHUB_STEP_SUMMARY
          echo "| resizing-worker | ${{ steps.filter.outputs.resizing-worker }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Force All**: ${{ github.event.inputs.force-all || 'false' }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ÌÖåÏä§Ìä∏ (Í≥µÌÜµ - Ìïú Î≤àÎßå Ïã§Ìñâ)
  # ============================================================================
  test:
    name: Run Tests (Stage)
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: |
      needs.detect-changes.outputs.shared == 'true' ||
      needs.detect-changes.outputs.web-api == 'true' ||
      needs.detect-changes.outputs.download-worker == 'true' ||
      needs.detect-changes.outputs.scheduler == 'true' ||
      needs.detect-changes.outputs.resizing-worker == 'true' ||
      github.event.inputs.force-all == 'true'

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Configure Testcontainers
        run: |
          echo "docker.host=unix:///var/run/docker.sock" > ~/.testcontainers.properties
          echo "ryuk.disabled=true" >> ~/.testcontainers.properties

      - name: Run tests
        env:
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379
          DOCKER_HOST: unix:///var/run/docker.sock
          TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: /var/run/docker.sock
          DOCKER_API_VERSION: "1.44"
          CI: true
        run: |
          chmod +x gradlew
          ./gradlew clean test -x jacocoTestCoverageVerification --no-daemon

      - name: Generate REST Docs
        run: |
          ./gradlew :adapter-in:rest-api:asciidoctor :adapter-in:rest-api:copyDocs --no-daemon

      - name: Upload REST Docs artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rest-docs
          path: adapter-in/rest-api/build/generated-static/docs/
          retention-days: 1

  # ============================================================================
  # ÎπåÎìú Jobs (Î≥ÄÍ≤Ω Í∞êÏßÄ Í∏∞Î∞ò Ï°∞Í±¥Î∂Ä Î≥ëÎ†¨ Ïã§Ìñâ)
  # ============================================================================
  build-web-api:
    name: Build web-api (stage)
    needs: [detect-changes, test]
    if: |
      always() &&
      needs.test.result == 'success' &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.web-api == 'true' ||
       github.event.inputs.force-all == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      image-uri: ${{ steps.build-push.outputs.image-uri }}
      image-tag: ${{ steps.build-push.outputs.image-tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Download REST Docs artifacts
        uses: actions/download-artifact@v4
        with:
          name: rest-docs
          path: adapter-in/rest-api/build/generated-static/docs/

      - name: Build bootJar with REST Docs
        run: |
          chmod +x gradlew
          ./gradlew :bootstrap:bootstrap-web-api:bootJar -x test --no-daemon

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: fileflow-web-api-stage
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE_TAG="web-api-stage-${{ github.run_number }}-${SHORT_SHA}"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f bootstrap/bootstrap-web-api/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image-uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

  build-download-worker:
    name: Build download-worker (stage)
    needs: [detect-changes, test]
    if: |
      always() &&
      needs.test.result == 'success' &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.download-worker == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: fileflow-download-worker-stage
      component: download-worker-stage
      dockerfile: bootstrap/bootstrap-download-worker/Dockerfile
      gradle-task: ":bootstrap:bootstrap-download-worker:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-scheduler:
    name: Build scheduler (stage)
    needs: [detect-changes, test]
    if: |
      always() &&
      needs.test.result == 'success' &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.scheduler == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: fileflow-scheduler-stage
      component: scheduler-stage
      dockerfile: bootstrap/bootstrap-scheduler/Dockerfile
      gradle-task: ":bootstrap:bootstrap-scheduler:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-resizing-worker:
    name: Build resizing-worker (stage)
    needs: [detect-changes, test]
    if: |
      always() &&
      needs.test.result == 'success' &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.resizing-worker == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: fileflow-resizing-worker-stage
      component: resizing-worker-stage
      dockerfile: bootstrap/bootstrap-resizing-worker/Dockerfile
      gradle-task: ":bootstrap:bootstrap-resizing-worker:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # Î∞∞Ìè¨ Jobs (ÎπåÎìú ÏÑ±Í≥µ Ïãú Ï°∞Í±¥Î∂Ä Î≥ëÎ†¨ Ïã§Ìñâ)
  # ============================================================================
  deploy-web-api:
    name: Deploy web-api (stage)
    needs: build-web-api
    if: needs.build-web-api.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: fileflow-cluster-stage
      ecs-service: fileflow-web-api-stage
      image-uri: ${{ needs.build-web-api.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-download-worker:
    name: Deploy download-worker (stage)
    needs: build-download-worker
    if: needs.build-download-worker.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: fileflow-cluster-stage
      ecs-service: fileflow-download-worker-stage
      image-uri: ${{ needs.build-download-worker.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-scheduler:
    name: Deploy scheduler (stage)
    needs: build-scheduler
    if: needs.build-scheduler.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: fileflow-cluster-stage
      ecs-service: fileflow-scheduler-stage
      image-uri: ${{ needs.build-scheduler.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-resizing-worker:
    name: Deploy resizing-worker (stage)
    needs: build-resizing-worker
    if: needs.build-resizing-worker.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: fileflow-cluster-stage
      ecs-service: fileflow-resizing-worker-stage
      image-uri: ${{ needs.build-resizing-worker.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # Terraform Image Tag ÏóÖÎç∞Ïù¥Ìä∏ (Stage)
  # ============================================================================
  update-terraform-tags:
    name: Update Terraform Image Tags (Stage)
    needs: [build-web-api, build-download-worker, build-scheduler, build-resizing-worker]
    if: |
      always() &&
      (needs.build-web-api.result == 'success' ||
       needs.build-download-worker.result == 'success' ||
       needs.build-scheduler.result == 'success' ||
       needs.build-resizing-worker.result == 'success')
    uses: ./.github/workflows/terraform-apply-stage.yml
    with:
      web-api-image-tag: ${{ needs.build-web-api.outputs.image-tag || '' }}
      download-worker-image-tag: ${{ needs.build-download-worker.outputs.image-tag || '' }}
      scheduler-image-tag: ${{ needs.build-scheduler.outputs.image-tag || '' }}
      resizing-worker-image-tag: ${{ needs.build-resizing-worker.outputs.image-tag || '' }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # Î∞∞Ìè¨ ÏôÑÎ£å ÏïåÎ¶º (Slack + GitHub Summary)
  # ============================================================================
  notify:
    name: Deployment Notification
    needs: [detect-changes, deploy-web-api, deploy-download-worker, deploy-scheduler, deploy-resizing-worker, update-terraform-tags]
    if: always()
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-notify-slack.yml@main
    with:
      project-name: FileFlow
      environment: stage
      status: |
        ${{
          (needs.deploy-web-api.result == 'success' || needs.deploy-web-api.result == 'skipped') &&
          (needs.deploy-download-worker.result == 'success' || needs.deploy-download-worker.result == 'skipped') &&
          (needs.deploy-scheduler.result == 'success' || needs.deploy-scheduler.result == 'skipped') &&
          (needs.deploy-resizing-worker.result == 'success' || needs.deploy-resizing-worker.result == 'skipped') &&
          (needs.update-terraform-tags.result == 'success' || needs.update-terraform-tags.result == 'skipped')
          && 'success' || 'failure'
        }}
      components: |
        [
          {"name": "web-api", "status": "${{ needs.deploy-web-api.result }}"},
          {"name": "download-worker", "status": "${{ needs.deploy-download-worker.result }}"},
          {"name": "scheduler", "status": "${{ needs.deploy-scheduler.result }}"},
          {"name": "resizing-worker", "status": "${{ needs.deploy-resizing-worker.result }}"},
          {"name": "terraform-tags", "status": "${{ needs.update-terraform-tags.result }}"}
        ]
      mention-on-failure: "@here"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
